---

title: Data processing system having a plurality of storage systems
abstract: It is an object of the present invention to conduct data transfer or data copying between a plurality of storage systems, without affecting the host computer of the storage systems. Two or more auxiliary storage systems B, C are connected to a primary storage system A connected to a host device . The auxiliary storage systems B, C read journals of data update from the primary storage system A at respective independent timings, save the journals in prescribed logical volumes JNL 2, JNL 3, produce copying of the data present in the primary storage system A based on the journals present in the logical volumes JNL 2, JNL 3 at the independent timings, and save the copies in auxiliary logical volumes COPY 1, COPY 3. The primary storage system A holds the journals till both auxiliary storage systems B, C read the journals and restore. The timing of journal read can be controlled according to the journal quantity, processing load, and the like.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07457929&OS=07457929&RS=07457929
owner: Hitachi, Ltd.
number: 07457929
owner_city: Tokyo
owner_country: JP
publication_date: 20051215
---
This application is a Continuation of U.S. application Ser. No. 10 765 128 filed on Jan. 28 2004 now U.S. Pat. No. 7 216 209 and claims priority from U.S. application Ser. No. 10 765 128 filed on Jan. 28 2004 which claims priority from Japanese Patent Application No. 2003 416414 filed on Dec. 15 2003 the entire disclosure of which is incorporated herein by reference.

The present invention relates to a data processing system having a plurality of storage systems and more particularly to data copying between a plurality of storage systems.

In recent years a technology relating to data copying between storage systems has gained importance by allowing a data processing system to be able to provide services to a customer even when a failure has occurred in the first storage system in order to provide continual service to the customer. Technology for copying the information stored in the first storage system into the second and third storage systems was disclosed in the following patent references.

U.S. Pat. No. 5 170 480 discloses a technology in which a first computer connected to a first storage system transfers the data stored in the first storage system to a second computer via a communication link between the first computer and the second computer and the second computer transfers the data to the second storage system connected to the second computer.

U.S. Pat. No. 6 209 002 discloses a technology in which a first storage system transfers the data stored in the first storage system to the second storage system and the second storage system transfers the data to the third storage system. The computer and the first storage system are connected by a communication link the first storage system and the second storage system are connected by a communication link and the second storage system and the third storage system are connected by a communication link. The first storage system holds a first logical volume which is the copying object. The second storage system holds a second logical volume which is the copy of the first logical volume and a third logical volume which is the copy of the second logical volume. The third storage system holds a fourth logical volume which is the copy of the third logical volume. In this patent reference the second storage system executes exclusively the data copying processing from the second logical volume to the third logical volume and the data copying processing from the third logical volume to the fourth logical volume.

The technology disclosed in U.S. Pat. No. 5 170 480 constantly uses the first computer and the second computer for data copying. The first computer conducts usual operations and the load of data copying processing applied to the first computer cannot be ignored. Another problem is that because data for copying use a communication link between the first computer and the first storage system those data collide with the data transfer necessary for usual operations and the data reference and data update time necessary for usual operations are extended.

With the technology disclosed in U.S. Pat. No. 6 209 002 the storage capacity multiple of the data quantity which is to be copied is required for the second storage system and the third storage system. Furthermore when the data quantity which is the object of copying is large the time consumed by the data copying processing is increased and data in the third storage system become old. The resulting problem is that when operations are restarted by using the data of the third storage system a long time is required to renew the data of the third storage system and the time required to restart the operations is extended. Furthermore according to the description provided in this reference the first storage system in addition to data update processing in the first storage system also conducts data update completion reporting to the host computer when data update processing with the second storage system has ended. Therefore a long time is consumed for data update from the computers and the time required for data update extends with the increase in the distance between the first storage system and the second storage system. The resulting problem is that the distance between the two storage systems cannot be made too large.

It is an object of the present invention to conduct data transfer or data copying between a plurality of storage systems without affecting the host computer of the storage systems.

It is another object of the present invention to conduct data transfer or data copying between a plurality of storage systems without affecting the communication between the storage systems and the computer.

It is yet another object of the present invention to reduce a data storage area held in a plurality of storage systems.

It is still another object of the present invention to conduct rapidly and effectively data transfer or data copying between a plurality of storage systems so as to produce no effect on the operation of the host computer of the plurality of storage systems.

The data processing system according to one aspect of the present invention comprises a first storage system communicably connected to a host unit and a second storage system and a third storage system each communicably connected to the first storage system.

The first storage system comprises a first control unit a first data storage area for storing data transmitted from the host unit and a first journal storage area for storing the journal used for producing a copy of data stored in the first storage area. The first control unit writes the data transmitted from the host unit into the first data storage area writes the journal of the data written into the first data storage area into the first journal storage area and transmits the journal present in the first journal storage area to each of the second and third storage systems in response to a request from each of the second and third storage systems.

The second storage system comprises a second control unit a second data storage area for storing a copy of the data present in the first data storage area and a second journal storage area for storing the journal. The second control unit reads the journal from the first storage system at an independently scheduled journal read timing writes the read out journal into the second journal storage area produces a copy of the data present in the first storage area based on the journal present in the second journal storage area at an independently scheduled restore timing and writes the copy into the second data storage area.

The third storage system comprises a third control unit a third data storage area for storing a copy of the data present in the first data storage area and a third journal storage area for storing the journal. The third control unit reads the journal from the first storage system at an independently scheduled journal read timing writes the read out journal into the third journal storage area produces a copy of the data present in the first data storage area based on the journal present in the third journal storage area at an independently scheduled restore timing and writes the copy into the third data storage area.

Further the first control unit in the first storage system detects as to whether or not the journal present in the first journal storage area has been read by the second and third storage systems. The first control unit holds the journal present in the first journal storage area till it is read by both the second storage system and the third storage system and can delete the journal present in the first journal storage area after the journal has been read by both the second storage system and the third storage system.

The third control unit of the third storage system may be adapted to control the time interval of journal read according to the number of data in the journal that has been read from the first journal storage area. Alternatively the third control unit may be adapted to control the time interval of journal read according to the communication quantity of the data exchanged between the first storage system and the third storage system. Alternatively the third control unit may be adapted to control the time interval of journal read according to the storage capacity of the journal held in the third data storage area. Alternatively the third control unit may be adapted to control the time interval of journal read according to the processing load of the third storage system. Alternatively the third control unit may be adapted to read from the first storage system information relating to the storage capacity of the journal held in the first journal storage area in the first storage system and to control the time interval of journal read according to the information relating to the storage capacity of the journal that was read out. Alternatively the first storage system may own management information relating to the first journal storage area and the third control unit of the third storage system may read from the first storage system the management information relating to the first journal storage area which is owned by the first storage system and may control the time interval of journal read according to the management information relating to the first journal storage area that was read out. The second control unit of the second storage system basically may be adapted to control the time interval of journal read in the same manner as described above.

The first data storage area in the first storage system can be composed of a plurality of logical volumes. The first control unit can write into the first journal storage area a plurality of journals each corresponding to a plurality of data stored in this plurality of logical volumes. Information relating to an update sequence of the corresponding plurality of data can be contained in a plurality of journals stored in the first journal storage area. Each of the second and third control units of the second and third storage systems can produce copies of a plurality of data based on the plurality of journals according to the update sequence contained in the plurality of journals read out from the first storage system and to write those copies in respective second and third data storage areas.

The third storage system may be adapted to control the restore timing according to the processing load of the third storage system.

The data processing system according to another aspect of the present invention comprises a first storage system communicably connected to a host unit and a second storage system and a third storage system each communicably connected to the first storage system.

The first storage system comprises a first control unit a first data storage area for storing data transmitted from the host unit and a first journal storage area for storing a journal used for producing a copy of data stored in the first storage area. The first control unit of the first storage system writes the data transmitted from the host unit into the first data storage area and writes the journal of the data that has been written into the first journal storage area.

The second storage system comprises a second control unit and a second journal storage area for storing the journal. The second control unit of the second storage system reads the journal from the first storage system at a prescribed journal read timing and writes the read out journal into the second journal storage area.

The third storage system comprises a third control unit and a third journal storage area for storing the journal. The third control unit of the third storage system reads the journal from the first storage system at a prescribed journal read timing and writes the read out journal into the third journal storage area.

The second storage system also can additionally comprise a second data storage area for storing a copy of the data. The second control unit may be adapted to produce a copy of the data from the journal stored in the second journal storage area at the prescribed restore timing and to write the produced copies of the data into the second data storage area.

The third storage system also can additionally comprise a third data storage area for storing a copy of the data. The third control unit may be adapted to produce a copy of the data from the journal stored in the third journal storage area at the prescribed restore timing and to write the produced copies of the data into the third data storage area.

The first control unit of the first storage system may be adapted to detect as to whether or not the journal present in the first journal storage area has been read by the second and third storage systems to hold the journal present in the first journal storage area till it is read by both the second and the third storage system and to delete the journal present in the first journal storage area after the journal has been read by both the second and the third storage system.

The preferred embodiments of the data processing system in accordance with the present invention will be described below in greater detail with reference to the appended drawings.

As shown in and in this data processing system a host computer and a storage system A are connected by a connection path . Further the storage system A and another storage system B are connected by a connection path . The storage system B is used for holding a copy of the data saved in the storage system A. In the explanation provided hereinbelow in order to distinguish easily between the storage system A holding the data which is the object of copying and the storage system B for holding the copied data the former storage system A will be referred to as a primary storage system and the latter storage system B will be referred to as an auxiliary storage system .

Physical structures of the primary storage system A and the auxiliary storage system B will be explained hereinbelow with reference to .

Because the primary storage system A and the auxiliary storage system B basically have identical physical structures only the structure of the primary storage system A is shown as a representative structure in . As shown in the primary storage system A comprises at least one channel adapter at least one disk adapter at least one cache memory at least one shared memory at least one physical storage unit for example a hard disk drive at least one common path and at least one connection line . The channel adapter disk adapter cache memory and shared memory are connected to each other by the common path . The common path may be duplicated in the event of failure of the common path . The disk adapter and the physical storage unit are connected to each other by a connection line . Furthermore a maintenance monitor not shown in the figures for conducting setting monitoring and maintenance of the storage systems is connected to all the channel adapters and disk adapters by using a special line.

The channel adapter is connected to the host computer or the other storage system for example the auxiliary storage system B by the connection line or the connection line . The channel adapter controls data transfer between the host computer and the cache memory or data transfer between the other storage system and the cache memory . The disk adapter control data transfer between cache memory and the physical storage unit . The cache memory is a memory for holding temporarily the data received from the host computer or the other storage system or the data read out from the physical storage unit . The shared memory is a memory shared by all the channel adapters and disk adapters in the storage systems . A variety of information for example the below described volume information pair information group information and pointer information for control or management which is used mainly by the channel adapter and disk adapter is stored and hold in the shared memory . The physical structure of the auxiliary storage system B is basically identical to the above described structure.

As shown in the entire storage area provided by the physical storage units . . . in each of the storage systems A and B is managed by dividing in multiple logical storage areas . . . . Individual logical storage areas will be referred to hereinbelow as logical volumes . The capacity of each logical volume and the physical storage position physical address in the storage systems A or B can be indicated from a terminal computer not shown in the figures for maintenance which is connected to the storage system A or B or the host computer . The physical address of each logical volume is stored in the below described volume information . The physical address is composed for example of the number storage unit number identifying a physical storage unit in the storage system A or B and a numerical value uniquely specifying the storage area in the storage unit for example a location from the head of the storage area in the physical storage unit . In the explanation below it will be assumed that the physical address is represented by a set of the storage unit number of the physical storage unit and the location from the head of the storage area in the physical storage unit . In the storage system following a commonly used RAID principle one logical volume corresponds to a plurality of physical storage areas in a plurality of physical storage units . To facilitate explanation hereinbelow it will be assumed that one logical volume corresponds to one storage area in one physical storage unit . However those skilled in the art can easily comprehend that the principle of the present invention can be also applied in accordance with the explanation provided hereinbelow to storage systems based on the RAID principle.

Data stores in the storage systems A B can be uniquely specified by the number logical volume number identifying the logical volume where the data is present and the numerical value for example a location from the head of the storage area in the logical volume which uniquely indicates the storage area of the data in the logical volume . In the explanation below the logical address is considered to be represented by a set of the logical volume number of the logical volume and the location location in the logical volume from the head of the storage area in the logical volume .

In the explanation below in order to distinguish easily between the logical volume of the copying object and the logical volume which is the copy thereof the former will be referred to as a primary logical volume and the second will be referred to as an auxiliary logical volume . A pair of the primary logical volume and auxiliary logical volume will be called a pair . Information on the relation and state of the primary logical volume and auxiliary logical volume is stored in the below described pair information .

A management unit called a group is provided to match the data update sequences between a plurality of primary logical volumes and a plurality of auxiliary logical volumes which constitute pairs with respective primary logical volumes. For example let us assume a case in which the host computer conducts processing in which it updates a first data in the first primary logical volume and then reads out the first data and updates a second data in the second primary logical volume by using the first data. In this case if the data copying processing from the first primary logical volume to the first auxiliary logical volume and the data copying processing from the second primary logical volume to the second auxiliary logical volume are conducted independently copying processing of the second data into the second auxiliary logical volume is sometimes conducted prior to copying processing of the first data into the first auxiliary logical volume. In such a case if a failure occurs and copying processing into first auxiliary logical volume is terminated after the copying processing of the second data into the second auxiliary logical volume but before the copying processing of the first data into the first auxiliary logical volume is completed then compatibility of data between the first auxiliary logical volume and second auxiliary logical volume is lost. In this case update sequence control using a group is carried out to maintain the compatibility of data between the first auxiliary logical volume and second auxiliary logical volume. Thus a plurality of logical volumes which require matching of data update sequences between the primary logical volume and auxiliary logical volume are catalogued in the same group. The update number of the below described group information is allocated to each data update conducted in the primary logical volume belonging to this group. Copying of the updated data into the auxiliary logical volume is carried out in the order of the update numbers. For example in the case illustrated by the two primary logical volumes DATA 1 and DATA 2 within the primary storage system A constitute one group Group 1 . The two auxiliary logical volumes COPY 1 and COPY 2 which are the copies of the two primary logical volumes DATA 1 and DATA 2 constitute the same group Group 1 in the auxiliary storage system B.

When the data of the primary logical volume which is the object of data copying are updated a journal relating to this data update is created for usage in updating the data of the auxiliary logical volume and this journal is saved in the prescribed logical volume in the primary storage system A. In the present embodiment a logical volume referred to hereinbelow as a journal logical volume for saving only the journal of this group is allocated to each group in the primary storage system A. In the example shown in a journal logical volume JNL 1 is allocated to the group Group 1 . A journal logical volume is also allocated to each group in the auxiliary storage system B. In the example shown in a journal logical volume JNL 2 is allocated to the group Group 1 in the auxiliary storage system. The journal logical volume JNL 2 in the auxiliary storage system B is used for holding the journal of Group 1 transferred from the primary storage system A to the auxiliary storage system B. Holding the journal in the journal logical volume in the auxiliary storage system B makes it unnecessary to conduct data update of the auxiliary logical volume during journal reception and data of the auxiliary logical volume can be updated based on this journal in a subsequent period which is not synchronous with journal reception for example when the load of the auxiliary storage system B is low.

Furthermore when there are multiple connection lines between the primary storage system A and the auxiliary storage system B a multiplex transfer of the journal from the primary storage system A to the auxiliary storage system B can be conducted and transfer capacity of the multiple connection lines can be used effectively. There is a possibility that a large number of journals will be retained in the auxiliary storage system B if the prescribed update sequence is protected but if the journals that cannot be used immediately for data updating the auxiliary logical volume are saved in the journal logical volume the cache memory can be released.

The above mentioned journal is composed or write data and update information. The update information is the information for managing the write data and this information includes the instant of time at which the write command was received the group number the update number of the below described group information the logical address of the write command the data size of the write data and the logical address of the journal logical volume storing the write data. The update information may also hold only the instant of time at which the write command was received and the update number. When the write command creation time is contained in the write command from the host computer the command creation time contained in the write command may be used instead of the instant of time at which the write command was received.

As shown in the journal logical volume can be used upon division for example into a storage area update information area for storing the update information and a storage area write data area for storing the write data. The update information of the write data written into the primary logical volume is stored in the order of update numbers from the head of the update information area of the journal logical volume . If the storage location of certain update information has reached the end of the update information area subsequent update information is stored from the head of the update information area . The write data corresponding to the write data written into the primary logical volume is stored in the order to update numbers from the head of the write data area of the journal logical volume . If the storage location of certain write data reaches the end of the write data area subsequent write data is stored from the head of the write data area . Further the size ratio of the update information area and write data area may be a fixed value and may be set to a random value via a maintenance terminal or host computer . Information such as the address indicating the range of update information area and write data area in the journal logical volume or the address indicating the storage location of the newest and oldest update information and write data is stored in the below described pointer information . In the explanation below the journal logical volume is used upon dividing into the update information and write data area but a method for continuously storing the update information and write data of each journal from the head of the journal logical volume may be also employed as a modification example.

The write command reception time such as Mar. 17 1999 10 PM 20 min 10 sec is stored in the update information shown as a example in . It is recorded in the update information that the aforesaid write command was a command for storing the write data in the location 700 from the head of the storage area of the logical volume with a logical volume number 1 and that the size of write data was 300 . Furthermore it is also recorded in the update information that the write data of the journal is stored from the position 1500 from the head of the storage area with a logical volume number 4 journal logical volume . Moreover it is further recorded in the update information that the logical volume with a logical volume number 1 belongs to group 1 and that the data update according to the write command is a data update with number 4 from the data copying start of group 1 .

Again referring to the primary storage system A has functions of conducting a command reception processing for receiving a data read write command from the host computer and a read write processing for reading writing the data from into the appropriate logical volume . The auxiliary storage system B has functions of conducting a journal read JNLRD processing for reading the journal from the primary storage system A a read write processing for reading writing the data from into the appropriate logical volume and a restore processing for updating the data present in the appropriate auxiliary logical volume based on the journal from the primary storage system A. Those processing functions are executed by the channel adapter disk adapter cache memory and shared memory shown in .

The operation of reflecting the data update to the primary logical volume of the primary storage system A in the auxiliary logical volume of the auxiliary storage system B will be briefly explained below with reference to .

 1 If the primary storage system A receives a write command relating to the data present in the primary logical volume for example DATA 1 from the host computer then the update of the object data present in the primary logical volume DATA 1 and saving the journal in the journal logical volume JNL 1 are conducted by the command reception processing and read write processing arrow .

 2 The auxiliary storage system B sends a command for reading the journal into the primary storage system A by the journal read processing . If the primary storage system A receives the command for reading the journal from the auxiliary storage system B the journal is read from the journal logical volume JNL 1 and transmitted to the auxiliary storage system B by the command reception processing and read write processing arrow .

 3 The auxiliary storage system B stores the journal read out from the primary storage system into the journal logical volume JNL 2 by the read write processing arrow .

 4 The auxiliary storage system B reads the journal from the journal logical volume JNL 2 in the order of increasing update numbers and updates the data of the auxiliary logical volume for example COPY 1 by the restore processing and read write processing by using the pointer information arrow .

The volume information is saved in a memory referable from the channel adapter and disk adapter for example in the shared memory shown in . The volume information is employed for managing the logical volumes. As shown in a volume state a format system a capacity a pair number and a physical address are stored for each logical volume number. The volume state is stored as normal main auxiliary abnormal unused . The logical volume with a normal or main volume state is a logical volume that can be normally accessed from host computer . The logical volume with an auxiliary volume state may be allowed to be accessed from the host computer . The logical volume with a main volume state is a primary logical volume for which data copying is conducted. The logical volume with an auxiliary volume state is the auxiliary logical volume which is used for copying. The logical volume with an abnormal volume state is the logical volume which cannot be normally accessed due to a failure. Here the failure is for example a breakdown of the storage unit storing the logical volume . The logical volume with the unused volume state is a logical volume which is not used. The pair number stores a pair number which is effective in the case of the main or auxiliary volume state and serves to specify the below described pair information . In the example shown in the logical volume of the logical volume number 1 is a primary logical volume storing the data which is the object of copying can be accessed has a format system of OPEN 3 and a capacity of 3 GB and indicates that the data held therein are stored from the head of the storage area of the physical storage unit with a storage unit number 1 .

The pair information is saved in a memory referable from the channel adapter and disk adapter for example in the shared memory shown in . The pair information is the information for managing the pairs and as shown in a pair state a primary storage system number a primary logical volume number an auxiliary storage system number an auxiliary logical volume number a group number and a copy completion address are held for each pair number. The pair state holds any of normal abnormal unused yet to be copied being copied . When the pair state is normal it indicates that data copying of the primary logical volume is conducted normally. When the pair state is abnormal it indicates that copying of the primary logical volume is not conducted due to a failure. The failure as referred to herein is for example a breakage of the connection path . When the pair state is unused it indicates that the information with this pair number is ineffective. When the pair state is being copied it indicates that the below described initial copy processing is being conducted. When the pair state is yet to be copied it indicates that the below described initial copy processing has not yet been conducted. The primary storage system number holds the number specifying the primary storage system A holding the primary logical volume . The auxiliary storage system number holds the number specifying the auxiliary storage system B holding the auxiliary logical volume . The group number holds the number of the group to which the primary logical volume belongs in the case of the primary storage system A and holds the number of the group to which the auxiliary logical volume belongs in the case of the auxiliary storage system B. The copy completion address is explained in the below described initial copy processing. In the pair information 1 shown as an example in the data copying object is a primary logical volume specified by the primary logical volume number 1 of the primary storage system number 1 the data copying address is an auxiliary logical volume specified by the auxiliary logical volume number 1 of the auxiliary storage system number 2 and this pair information indicates that data copying processing is conducted normally.

The group information is retained in a memory referable from the channel adapter and disk adapter for example in a shared memory . As shown in the group information holds a group state a pair set a journal logical volume number and an update number. The group state holds any of normal abnormal and unused . When the group state is normal it indicates that at least one pair state of a pair set is normal . When the group state is abnormal it indicates that all the pair states of the pair set are abnormal . When the group state is unused it indicates that the information on the group number is ineffective. The pair set holds the pair numbers of all the primary logical volumes belonging to this group in the case of the primary storage system and holds the pair numbers of all the auxiliary logical volumes belonging to this group in the case of the auxiliary storage system. The journal logical volume number indicates the number of the journal logical volumes belonging to the group with this group number. The update number has an initial value of 1 and is incremented by 1 if data is written into the primary logical volume in the group. The update number is stored in the update information of the journal and is used to protect the update sequence of data in the auxiliary storage system B. Even at the zero stage as shown in in the group information the group with a group number 1 is composed of a logical volume belonging to the pair numbers 1 and 2 and a journal logical volume with a logical volume number 4 and the data copying processing is conducted normally.

The pointer information is retained in the memory referable from the channel adapter and disk adapter for example in the shared memory . The pointer information is the information for managing the journal logical volume of the group for each group. As shown in the pointer information holds an update information area head address in the journal logical volume a write data area head address an update information newest address an update information oldest address a write data newest address a write data oldest address read start address and a retry start address.

The primary storage system A has the pointer information for managing the journal logical volume in the primary storage system A the number of the pointer information sets being equal to the number of auxiliary storage systems connected to the primary storage system A. Thus in the example shown in one auxiliary storage system B is connected to the primary storage system A. Therefore as shown in the primary storage system A has one set of pointer information correspondingly to this one auxiliary storage system B. The system number of this one auxiliary storage system B is described in the pointer information . However in the below described example shown in a plurality for example two of auxiliary storage systems B C are connected in parallel to the primary storage system A. In the case shown in the primary storage system A has a plurality of sets of pointer information B C see each corresponding to the respective system of the aforesaid plurality of auxiliary storage systems B C and the system numbers of the corresponding auxiliary storage systems B C are recorded in the plurality of sets of pointer information B C. Thus when the primary storage system A has a plurality of sets of pointer information corresponding to each of a plurality of auxiliary storage systems B C connected to the primary storage system whether or not the journal read from the primary storage system A has been conducted by the respective auxiliary storage systems B C the timing thereof differs between the auxiliary storage systems B C can be managed by a plurality of sets of pointer information allocated to respective auxiliary storage systems B C. Using this makes it possible to conduct control so that the primary storage system A holds each journal located in the primary storage system A so that it is not deleted till it is read by all of the plurality of auxiliary storage systems B C.

On the other hand the auxiliary storage system B basically has one set of pointer information for managing the journal logical volume in this auxiliary storage system B. However a configuration in which a plurality of auxiliary storage systems are cascade connected to the primary storage system can be also used this configuration is not shown in the figures . In this case the auxiliary storage system positioned in the middle of the cascade can have a plurality of sets of pointer information corresponding to the two upper and lower auxiliary storage systems.

As shown in the update information area head address holds the logical address of the head of the update information area of the journal logical volume . The write data area head address holds the logical address of the head of the write data area of the journal logical volume . The update information newest address holds the logical address of the head used for retaining the update information of a journal when the journal is stored next. The update information oldest address holds the logical address of the head retaining the update information of the oldest with the smallest update number journal. The write data newest address holds the logical address of the head used for retaining the write data when the journal is stored next. The write data oldest address holds the logical address of the head retaining the write data of the oldest with the smallest update number journal in the journal logical volume . The read start address and retry start address are used only in the primary storage system A and are employed in the below described journal read reception processing. In the pointer information shown as an example in the update information area is from the head address 0 of the storage area with the logical volume number 4 to the position with the address 699 and the write data area is from the position with the address 700 in the storage area with the logical volume number 4 to the address 2699 . Further the update information is retained from the position with the address 200 of the storage area with the logical volume number 4 to the position with the address 499 and the update information of the next journal is stored from the position with the address 500 of the storage area with the logical volume number 4 . Furthermore the write data of the journal is retained from the position with the address 1300 of the storage area with the logical volume number 4 to the position with the address 2199 and the write data of the next journal is stored from the position with the address 2200 of the storage area with the logical volume number 4 .

In the explanation provided above one journal logical volume was allocated to one group. However a plurality of journal logical volumes may be allocated to one group. For example two journal logical volumes may be allocated to one group the pointer information may be provided for each journal logical volume and the journal may be stored alternately in the two journal logical volumes. As a result the writing of the journal into the physical storage unit is dispersed and the performance is improved. Further journal read performance is also improved. In another example two journal logical volumes are allocated to one group and usually only one journal logical volume is used. The other journal logical volume is used when the performance of the journal logical volume that has been presently used is decreased. The decrease in performance is referred to herein is for example a breakdown of one of a plurality of physical storage units when the journal logical volume is composed of a plurality of physical storage units and data are held based on a RAID 5 system.

As described hereinabove the volume information pair information group information and pointer information can be stored in the shared memory . However those types of information and may be also stored collectively in any of the cache memory channel adapter disk adapter of physical storage unit or may be dispersed therebetween.

The user acquires the group number with an unused group state for example the group number A by using the maintenance terminal or host computer with reference to the group information in the primary storage system A. The user inputs the group creation designation that designates the group number A into the primary storage system A by using the maintenance terminal or host computer . Having received the group creation designation the primary storage system A changes the group state of the designated group number A to normal .

Similarly the user acquires the group number with an unused group state for example the group number B with reference to the group information of the auxiliary storage system B. The user inputs the group creation designation that designates the auxiliary storage system B and the group number B into the primary storage system A by using the maintenance terminal or host computer . The primary storage system A transfers the received group creation designation to the auxiliary storage system B. The auxiliary storage system B changes the group state of the designated group number B to normal .

Alternatively the user may directly input the group creation designation that designates the group number B into the auxiliary storage system B by using the maintenance terminal of the auxiliary storage system B or the host computer connected to the auxiliary storage system B. In this case too the auxiliary storage system B changes the group state of the designated group number B to normal .

The user inputs into the primary storage system A the pair catalog designation which designates the information specifying the primary logical volume which is the data copying source and the information which specifies the auxiliary logical volume which is the data copying address by using the maintenance terminal or host computer . The information specifying the primary logical volume includes the created group number A and the primary logical volume number in this group A . The information specifying the auxiliary logical volume includes the storage system number of the auxiliary storage system B the created group number B and the auxiliary logical volume number in this group B .

Having received the aforesaid pair catalog designation the primary storage system A acquires the pair number with the unused pair information from the pair information . Then the primary storage system A in the row of the acquired pair numbers in the pair information sets the pair state to yet to be copied sets the storage system number of the primary storage system A to the primary storage system number sets the designated primary logical volume number to the primary logical volume number sets the designated ass number to the ass number sets the designated auxiliary logical volume number to the auxiliary logical volume number and sets the designated group number A to the group number. Furthermore the primary storage system A adds the acquired pair number to the pair set of the group information with the designated group number A and changes the volume state with the primary logical volume number to main .

The primary storage system A posts the storage system number of the primary storage system A the group number B designated by the user the primary logical volume number and the auxiliary logical volume number to the auxiliary storage system B. The auxiliary storage system B acquires the pair number that has not yet been used from the pair information . Furthermore the auxiliary storage system B in the row of the acquired pair numbers in the pair information sets the pair state to yet to be copied sets the storage system number of the primary storage system A to the mss number sets the designated primary logical volume number to the primary logical volume number sets the designated auxiliary storage system number of the auxiliary storage system B to the ass number sets the designated auxiliary logical volume number to the auxiliary logical volume number and sets the designated group number B to the group number. Furthermore the auxiliary storage system B adds the acquired pair number to the pair set of the group information with the designated group number B and changes the volume state with the auxiliary logical volume number to auxiliary .

In the case explained hereinabove the cataloguing of logical volumes into groups and setting the pairs of logical volumes were conducted simultaneously but they may be also conducted independently from each other.

The user inputs into the primary storage system A the designation journal logical volume catalog designation for cataloguing the logical volumes journal logical volumes used for retaining the journal by using the maintenance terminal or host computer . The group number and logical volume number are included into the journal logical volume catalog designation.

The primary storage system A catalogs the designated logical volume number to journal logical volume numbers present in the group information with the designated group number and then sets normal in the volume state in the volume information of the logical volume.

At the same time the user designates the storage system number of the auxiliary storage system B the group number B and the logical volume number of the journal logical volume by referring to the volume information of the auxiliary storage system B and using the maintenance terminal or host computer and inputs the designation of the journal logical volume catalog into the primary storage system A. The primary storage system A transfers the journal logical volume catalog designation to the auxiliary storage system B. The auxiliary storage system B catalogs the designated logical volume number into the journal logical volume number in the group information with the designated group number B and then sets normal in the volume state in the volume information of the logical volume.

The user may also designate the group number and the logical volume number of the journal logical volume by using the maintenance terminal of the auxiliary storage system B or the host computer connected to the auxiliary storage system B and to input the journal logical volume catalog designation directly into the auxiliary storage system B. In this case too the auxiliary storage system B catalogs the designated logical volume number in the logical volume number in the group information with the designated group number B and then sets normal in the volume state in the volume information of the logical volume.

The above described operation is conducted with respect to all the logical volumes used as the journal logical volumes. The order of step and step may be inversed.

The user indicates the group number for starting the data copying processing by using the maintenance terminal or host computer and designates the start of data copying processing in the primary storage system A. The primary storage system A sets to 0 the copy completion address of all the pair information belonging to the designated group.

The primary storage system A designates the start of journal read processing and restore processing see to the auxiliary storage system B. The primary storage system A starts the below described initial copying processing.

If the initial copying processing is ended the primary storage system A report the end of the initial copying processing to the auxiliary storage system B. The auxiliary storage system B changes the pair states of all the auxiliary logical volumes belonging to the designated group to normal .

In the initial copying processing with respect to the entire storage area of the primary logical volume which is the object of data copying journals are created for each unit data size in the order from the head of that entire storage area while using the copy completion address of the pair information . The initial value of the copy completion address is zero and each time the journal is created the data size of the data for which journal creation has been completed is added thereto. In the initial copying processing journal creation is completed for the range from the head of the storage area of the logical volume to the address immediately presenting the copy completion address. Conducting initial copying processing makes it possible to transfer the data that are in the primary logical volume and have not been updated to the auxiliary logical volume. The explanation hereinbelow is conducted with respect to the case in which the channel adapter see located in the primary storage system A conducts the initial copying processing but the initial copying processing may be also conducted by the disk adapter . The procedure of the initial copying processing will be explained hereinbelow based on .

 1 The channel adapter located in the primary storage system A obtains a primary logical volume for example A for which the pair state is not yet copied among the pairs belonging to the group which is the processing object changes this pair state to being copied and repeats the below descried processing steps . When the primary logical volume with a not yet copied pair state is not present the processing is ended step .

 2 The channel adapter creates a journal for each data of a unit size for example 1 MB with respect to the primary logical volume A acquired in step step . The journal creation processing is described below in greater detail.

 3 The channel adapter adds the size of the data for which the creation of journal has been completed to the copying completion address of pair information step .

 4 The above described processing of step and step is repeated till the copying completion address reaches the capacity of the primary logical volume A step . When the copying completion address becomes equal to the capacity of the primary logical volume A the journal becomes created for the entire storage area of the primary logical volume A . Therefore the channel adapter updates the pair state to normal and the starts the initial copying processing for another primary logical volume step .

In the flow chart shown in individual primary logical volumes are successively processed but a plurality of logical volumes may be also processed simultaneously.

 1 The channel adapter step shown in present in the primary storage system A receives an access command from the host computer. The access command comprises commands such as data read data write or the below described journal read the logical address of the command object and the data quantity. In the explanation below the logical address in the access command will be represented as a logical address A the logical volume number will be represented as a logical volume A the position in the logical volume will be represented as a position A in the logical volume and the data quantity will be represented as a data quantity A .

 2 The channel adapter examines the access command steps . When the examination conducted in step shows that the access command is a journal read command the below described journal read reception processing is conducted step . When the access command is other than the journal read command and data write command for example when it is a data read command then data read processing is conducted in the same manner as with the conventional technology step .

 3 When the examination conducted in step shows that the access command is a data write command the channel adapter examines the volume state by referring to the volume information of the logical volume A step . When the examination conducted in step shows that the volume state of the logical volume A is other than normal or main the access to the logical volume A is impossible. Therefore the channel adapter reports the abnormal end to the host computer step .

 4 When the examination conducted in step shows that the volume state of the logical volume A is either normal or main the channel adapter reserves the cache memory and notifies the host computer that the preparation for data reception has been completed. The host computer receives this notification and transmits the write data to the primary storage system A. The channel adapter receives the write data and retains it in the cache memory step in .

 5 The channel adapter examines as to whether the logical volume A is the data copying object by referring the volume state of the logical volume A step . If the examination conducted in step shows that the volume state is main the logical volume A is the data copying object. Therefore the below described journal creation processing is conducted step .

 6 If the examination conducted in step shows that the volume state is normal or after the end of the journal creation procedure of step the channel adapter instructs the disk adapter to write the write data into the storage unit in and sends an end report to the host computer steps . The disk adapter then saves the write data in the physical storage unit by read write processing in .

The above described journal creation processing of step shown in and step shown in will be described below with reference to and .

 1 The channel adapter acquires the pointer information of the initial set step in . The channel adapter examines the volume state of the journal logical volume step . When the examination of step shows that the volume state of the journal logical volume is abnormal journal storage is impossible in the journal logical volume. Therefore the channel adapter changes the groups state to abnormal and completes the processing step . In this case the channel adapter changes the journal logical volume to the normal logical volume.

 2 When the examination of step shows that the journal logical volume is normal the channel adapter continues the journal creation processing. The operations differ depending on whether journal creation processing is a processing within the initial copying processing or a processing within the command reception processing step . When the journal creation processing is a processing within the command reception processing the operations are conducted from step . When the journal creation processing is within the initial copying processing the operations are conducted from step .

 3 When the journal creation processing is a processing within the command reception processing the channel adapter examines as to whether the logical address A of the write object is the processing object of the initial copying processing step . When the pair state of the logical volume A is not yet copied the journal creation processing is conducted thereafter in the initial copying processing. Therefore the channel adapter ends processing without creating the journal step . When the pair state of the logical volume A is being copied if the copying completion address is equal to or less than the position A in the logical address the journal creation processing is conducted thereafter in the initial copying processing. Therefore the channel adapter ends processing without creating the journal step . In other cases that is when the pair state of the logical volume A is being copied and the copying completion address is not less than the position A in the logical address or when the pair state of the logical volume A is normal the channel adapter continues the journal creation processing.

 4 The channel adapter then examines as to whether the journal can be stored in the journal logical volume. Thus the channel adapter uses the pointer information and examines the presence of an unused area of the update information area step . When the update information newest address and the update information oldest address of pointer information are equal to each other no unused area is present in the update information area. Therefore the channel adapter ends processing as a journal creation failure step .

When the examination of step shows that an unused area is present in the updated information area the channel adapter uses the pointer information and examines as to whether a write data can be stored in the write data area step . When the sum of the write data newest address and data quantity A is equal to or larger than the write data oldest address storing in the write data area is impossible. Therefore the channel adapter ends processing as a journal creation failure step . The channel adapter repeats the processing of steps through with respect to the pointer information of the next set as long as the pointer information of the next set is present.

 5 When the journal can be stored the channel adapter acquires an update number a logical address for storing the update information and a logical address for storing the write data and creates the update information in the cache memory . The channel adapter acquires the update number from the group information of the object group adds 1 thereto and sets the resulting numerical value in the update number of group information . The channel adapter acquires the update information newest address of pointer information as the logical address for storing the update information adds the size of the update information thereto and sets the resulting numerical value in the update information newest address of pointer information . The channel adapter acquires the write data newest address of pointer information as the logical address for storing the write data adds the data quantity A to this write data newest address and sets the resulting numerical value in the write data newest address of pointer information . The channel adapter sets the above described acquired numerical value group number write command reception time logical address A in the write command and data quantity A into the update information step in . For example when the group information shown as an example in and the pointer information shown as an example in are present if a write command is received which instructs that the data of data size 100 be written in a position advanced by an address number 800 from the head of the storage area of the primary logical volume 1 that belongs to group 1 the channel adapter creates the update information such as shown in . Further the update number in the group information shown as an example in is changed to 5 . Moreover the update information newest address in the pointer information is changed to 600 when the size of the update information was 100 and the write data newest address is changed to 2300 . When there is the pointer information of a plurality of sets corresponding to a respective plurality of auxiliary storage systems connected to the primary storage system the channel adapter updates the entire pointer information of that plurality of sets in the above described manner.

 6 The channel adapter instructs the disk adapter to write the write data and update information of the journal into the storage unit and normally ends the processing step in .

 7 When the journal creation processing is a processing within the initial copying processing the operations are conducted from step . The channel adapter examines as to whether the journal can be created. Thus the channel adapter uses the pointer information and examines the presence of an unused area in the update information area step . When the update information newest address and the update information oldest address of pointer information are equal to each other no unused area is present in the update information area. Therefore the channel adapter ends processing as a journal creation failure step . Here in the initial copying processing of the present embodiment the write data of the journal is read from the primary logical volume and the write data area is not used. Therefore confirmation of the unused area in the write data area is not required. The channel adapter repeats the processing of step with respect to the pointer information of the next set as long as the pointer information of the next set is present.

 8 When the examination of step shows that the journal can be stored the channel adapter acquires the following numerical values which are to be set in the update information and creates the update information in the cache memory . Thus the channel adapter acquires the update number for the group information of the object group adds 1 thereto and sets the resulting numerical value in the update number of group information . The channel adapter acquires the position of the update information newest address of pointer information as the logical address for storing the update information adds the size of the update information thereto and sets the resulting numerical value in the update information newest address of pointer information .

The channel adapter sets the above described acquired numerical value group number start time of the present processing logical address of the initial copying processing object processing data quantity for one cycle of initial copying and a logical address of the journal logical volume storing the write data in the initial copying processing into the update information step in .

 9 The channel adapter instructs the disk adapter to write the write data and update information into the storage unit and normally ends the processing step in .

In the explanation above the update information was stored in the cache memory but as a modification of the aforesaid configuration the update information may be also stored in the shared memory or other storage location.

Writing of the write data with the disk adapter into the physical storage unit can be conducted asynchronously that is not necessarily immediately after step and step . However when the host computer again generates a write command relating to the logical address A the write data of the journal are overwritten. Therefore the write data of the journal have to be written into the storage location in the physical storage unit corresponding to the logical address of the journal logical volume indicated by the update information prior to receiving the write data from the host computer . Alternatively the write data of the journal may be saved in the other cache memory and written thereafter into the storage location in the physical storage unit corresponding to the logical address of the journal logical volume of the update information.

In the above described journal creation processing the journals are saved from the cache memory to the physical storage unit at the appropriate timing. As a modification example a cache memory of a constant capacity may be prepared in advance for the journals and the journals may be saved in the physical storage unit at a stage when this cache memory was entirely used. The capacity of the cache memory for the journals may be designated for example from the maintenance terminal.

The read write processing see and is the processing in which the disk adapter receives a command from the channel adapter or disk adapter and executes the command. The read write processing is classified into the write processing by which the data present in the designated cache memory are written into the storage area in the physical storage unit corresponding to the designated logical address and the read processing by which the data of the storage area in the storage unit corresponding to the designated logical address are read into the designated cache memory .

 1 As shown in and the channel adapter present in the primary storage system A receives an access command journal read command from the auxiliary storage system B. This access command comprises an identifier indicating that the command is a journal read command a group number of the command object and the presence or absence of retry indication step in . In the explanation below the group number in the access command journal read command will be considered as a group number A .

 2 The channel adapter examines as to whether the group state with the group number A is normal step . If the examination of step shows that the group state is not normal for example if it is failure the channel adapter posts the group state to the auxiliary storage system B and ends the processing. The auxiliary storage system B conducts processing according to the received group state. For example when the group state is failure the auxiliary storage system B ends the journal read processing step .

 3 If the examination of step shows that the group state with the group number A is normal the channel adapter examines the state of the journal logical volume step . If the examination of step shows that the volume state of the journal logical volume is not normal for example if it is failure the channel adapter changes the group state to failure posts the group state to the auxiliary storage system B and ends the processing. The auxiliary storage system B conducts processing according to the received group state. For example when the group state is failure the auxiliary storage system B ends the journal read processing step .

 4 If the examination of step shows that the volume state of the journal logical volume is normal the channel adapter examines as to whether the journal read command is a retry indication step .

 5 If the examination of step shows that the journal read command is a retry indication the channel adapter again transmits the journal that was received in the previous cycle to the auxiliary storage system B. The channel adapter reserves the cache memory and instructs the disk adapter to write the data update information of the size of the update information into the cache memory from the storage location indicated by the retry start address of pointer information in .

The read write processing of the disk adapter comprises reading the update information from the physical storage unit saving the data in the cache memory and posting the read end of the update information to the channel adapter in .

The channel adapter receives the notification about the read end of the update information acquires the logical address of the write data and the size of the write data from the update information reserves the cache memory and instructs the disk adapter to write the write data into the cache memory step in .

The read write processing in the disk adapter comprises reading the write data from the physical storage unit saving the data in the cache memory and posting the read end of the write data to the channel adapter in .

The channel adapter receives the notification about the read end of the write data transmits the update information and write data to the auxiliary storage system B releases the cache memory holding the journals and ends the processing step in .

 6 If the examination of step shows that the command is not the retry indication the channel adapter examines as to whether the non transmitted journals are present and if they are present sends those journals to the auxiliary storage system B. The channel adapter compares the read start address of the pointer information and the update information newest address step .

When the read start address is equal to the update information newest address all the journals have been transmitted to the auxiliary storage system B. Therefore the channel adapter transmits a no journals message to the auxiliary storage system B step and releases the storage area of the journals transmitted to the auxiliary storage system B at the time of processing the previous journal read command step .

In the release processing of the storage area of the journals in step it is not necessary to conduct actively the release operation with respect to the storage area and only the update of the pointer of the oldest address may be conducted. Thus the retry start address is set into the update information oldest address of pointer information . When the update information oldest address becomes the write data area head address the update information oldest address is considered to be 0 . The write data oldest address of pointer information is changed to a numerical value obtained by adding the size of the write data transmitted in response to the previous read journal command to the present value thereof. When the write data oldest address becomes the logical address with a capacity of not less than the journal logical volume the write data area head address is corrected by decreasing.

 7 When the examination of step shows that un transmitted journals are present the channel adapter reserves the cache memory and instructs the disk adapter to write the data update information of the size of the update information from the read start address of pointer information to the cache memory in .

The read write processing of the disk adapter comprises reading the update information from the physical storage unit saving it in the cache memory and posting the read end of the update information to the channel adapter in .

The channel adapter receives the notification about the read end of the update information acquires the logical address of write data and the size of write data from the update information reserves the cache memory and instructs the disk adapter to read the write data into the cache memory step in .

The read write processing of the disk adapter comprises reading the write data from the physical storage unit saving it in the cache memory and posting the read end of the write data to the channel adapter in .

The channel adapter receives the notification about the read end of the write data transmits the update information and write data to the auxiliary storage system B step and releases the cache memory holding the journals in . Then the read start address is set to the retry start address of the pointer information and the read start address is changed to the numerical value obtained by adding the update information size of the transmitted journals to the present value.

 8 The channel adapter releases the storage area of the journals that were transmitted to the auxiliary storage system B during processing of the previous journal read command step .

In the above described journal read reception processing the primary storage system A successively transmits the journals one by one to the auxiliary storage system B. In a modification example a plurality of journals may be transmitted to the auxiliary storage system B at the same time. The number of journals that are transmitted by one journal read command may be designated within the journal read command by the auxiliary storage system B. Alternatively the user may designate it in the primary storage system A or auxiliary storage system B at the time of group cataloguing. Furthermore the number of journals that are transmitted in one journal read command may be changed according to the load or transfer capacity of the connection path of the primary storage system A and the auxiliary storage system B. Furthermore the journal transfer quantity may be designated according to the size of write data of the journals rather than to the number of journals.

In the above described journal read reception processing the journals are read from the physical storage unit into the cache memory . However this operation is unnecessary when the journals are already present in the cache memory .

The release processing of the storage area of the journals in the above described journal read reception processing is implemented during processing of the next journal read command. As a modification example the storage area of the journals may be also released immediately after the journals have been transmitted to the auxiliary storage system B. Furthermore the auxiliary storage system B also may set the update number that may be released in the journal read command and the primary storage system A may release the storage area of the journals with the update numbers designated by this setting.

 1 The channel adapter located in the auxiliary storage system B reserves the cache memory for storing the journals and transmits to the primary storage system A the identifier indicating that this is the journal read command the group number of the primary storage system A of the command object and the access command journal read command indicating the presence or absence of the retry indication step in . The group number in the access command is hereinbelow considered as a group number A .

 2 The channel adapter receives the response of the primary storage system A and the journals in . The channel adapter examines the response from the primary storage system A and when the response is no journals transmits the read journal command to the primary storage system A after the fixed time because no journal of the designated group is present in the primary storage system A steps .

 4 When the response of the primary storage system A is group state is failure or group state is unused the channel adapter changes the group state of the auxiliary storage system B to the received state and ends the journal read processing steps .

 5 When the response of the primary storage system A is other than the above described responses in other words when it is normal end the channel adapter examines the volume state of the journal logical volume step . When the volume state of the journal logical volume is abnormal it is impossible to store the journals in the journal logical volume. Therefore the channel adapter changes the group state to abnormal and ends the processing step In this case the channel adapter changes the journal logical volume to a normal logical volume and returns the group state to normal.

 6 When the examination of step shows that the volume state of the journal logical volume is normal the channel adapter conducts the below described journal store processing . When the journal store processing ends normally the channel adapter immediately transmits the next journal read command or transmits the next journal read command after the fixed time interval step . The timing for transmitting the next journal command may be such that the commands are sent periodically with a constant time spacing and this time spacing may be controlled according to the number of received journals communication capacity of the connection line storage capacity of the journals held in the auxiliary storage system B or the load of the auxiliary storage system B. Furthermore the storage capacity of the journals held in the primary storage system A and pointer information of the primary storage system A may be read by the auxiliary storage system B and the aforesaid time spacing may be controlled according to the numerical values thereof. Transfer of the above described information may be also conducted by a special command and may be contained in the response of the journal read command. Subsequent processing is identical to that conducted after step .

 7 When the journal store processing of step has not ended normally the unused area of the journal logical volume is insufficient. Therefore the channel adapter destroys the received journals and transmits the journal read command with retry indication after a fixed interval step . Alternatively the channel adapter holds the journals in the cache memory and again conducts the journal store processing after a fixed interval. This is done because the unused area can be added to the journal logical volume after a fixed interval by conducting the below described restore processing . When such a method is used the presence or absence of the retry indication in the journal read command is unnecessary.

 1 The channel adapter of the auxiliary storage system acquires the pointer information of the very first set step . The channel adapter of the auxiliary storage system examines whether the journal can be stored in the journal logical volume. Thus the channel adapter uses the pointer information and examines as to whether or not the unused area is present in the update information area step . When the update information newest address and the update information oldest address of the pointer information are equal to each other no unused area is present in the update information area. Therefore the channel adapter ends the processing as a journal creation failure step .

 2 When the examination of step shows that an unused area is present in the update information area the channel adapter uses the pointer information and examines as to whether write data are present in the write data area step . When the sum of the newest address and the data quantity of write data of the received journal is equal to or larger than the write data oldest address the write data cannot be stored in the write data area. Therefore the channel adapter ends the processing as a journal creation failure step .

The channel adapter repeats the steps through with respect to the pointer information of the next set as long as the pointer information of the next set is present.

 3 When the journals can be stored the channel adapter changes the group number of the received update information and the logical address of the journal logical volume. The group number is changed to the group number of the auxiliary storage system B and the logical address of the journal logical volume is changed to the write data newest address of pointer information . The channel adapter changes the update information newest address of pointer information to a numerical value obtained by adding the size of update information to the update information newest address. The channel adapter changes the write data newest address of pointer information to a numerical value obtained by adding the size of write data to the write data newest address step . When a plurality of sets of pointer information corresponding to a plurality of auxiliary storage systems are present the channel adapter changes all those multiple sets of pointer information in the above described manner.

 4 The channel adapter instructs the disk adapter to write the update information and write data into the storage unit and ends the processing as a journal creation success step in . Then the disk adapter writes the update information and write data into the physical storage unit by read write processing and releases the cache memory in .

In the above descried journal storage processing the journals are saved from the cache memory into the physical storage unit at an appropriate timing. As a modification example the cache memory of fixed capacity may be prepared in advance for the journals and the journals may be saved in the physical storage unit at a stage at which the entire cache memory was used. The capacity of the cache memory for journals may be designated for example from the maintenance terminal.

 1 The channel adapter of the auxiliary storage system B examines as to whether the group state with the group number B is normal step . When the examination of step shows that the group state is other than normal for example when it is failure the channel adapter ends the restore processing step .

 2 When the examination of step shows that the group state is normal the channel adapter examines the volume state of the journal logical volume step . When the examination of step shows that the volume state of the journal logical volume is abnormal the access is impossible. Therefore the channel adapter changes the group state to abnormal and ends the processing step .

 3 When the examination of step shows that the volume state of the journal logical volume is normal the channel adapter examines as to whether the journal of the restore object is present. Thus the channel adapter acquires the update information oldest address and update information newest address of pointer information . When the update information newest address and the update information oldest address are equal to each other the journal is not present. Therefore the channel adapter temporarily ends the restore processing and restarts the restore processing after a fixed interval step .

 4 When the examination of step shows that a journal of the restore object is present the channel adapter conducts the next processing with respect to the journal having the oldest smallest update number. The update information of the journal having the oldest smallest update number is saved from the update information newest address of the pointer information . The reserves the cache memory and instructs the disk adapter to read the data update information of the size of the update information from the update information newest address to the cache memory in .

The read write processing of the disk adapter comprises reading update information from the physical storage unit saving in the cache memory and notifying the channel adapter about the update information read end in .

The channel adapter receives the notification about the update information read end acquires the logical address of write data and the size of write data from the update information reserves the cache memory and instructs the disk adapter to read the write data into the cache memory in .

The read write processing of disk adapter comprises reading the write data from the physical storage unit saving it in the cache memory and notifying the channel adapter about the write data read end step in .

 5 The channel adapter finds the logical address of the auxiliary logical volume which is updated from the update information and instructs the disk adapter to write the word data into the auxiliary logical volume step in . The read write processing of the disk adapter comprises writing the data into the storage zone of the physical storage unit corresponding to the logical address of the auxiliary logical volume releasing the cache memory and notifying the channel adapter about the data write completion in .

 6 The channel adapter receives the notification about the data write completion and releases the storage area of the journals. In the release processing of the storage area of the journals the update information oldest address of pointer information is changed to a numerical value obtained by adding the size of the update information thereto. When the update information oldest address becomes the word data area head address the update information oldest address is considered to be 0 . The word data oldest address of pointer information is changed to a numerical value obtained by adding the word data size thereto. When the word data oldest address becomes a logical address equal to or larger than the capacity of the journal logical volume the word data area head address is corrected so as to be reduced. The channel adapter thereafter starts the next restore processing step .

In the above mentioned restore processing the journal is read from the physical storage unit into the cache memory . However this operation is not required when the journal has already been present in the cache memory .

In the above described journal read reception processing and journal read processing the primary storage system A determines the journal which is to be transmitted based on the pointer information . As a modification example the auxiliary storage system B may determine the journal which is to be transmitted. In this case the auxiliary storage system B can for example add the update number to the journal read command. In this case a table or a search method for finding the logical address where the update information was stored from the update number can be provided in the shared memory of the primary storage system A thereby making it possible for the primary storage system A to find the logical address of the update information from the update number designated by the auxiliary storage system B in the journal read reception processing.

In the above described journal read reception processing and journal read processing a special access command which is a journal read command is used. As a modification example the usual read command may be used. In this case for example the group information and pointer information of the primary storage system A can be transferred in advance into the auxiliary storage system B and the auxiliary storage system B can generate a read command for reading the data in other words the journal of the journal logical volume present in the primary storage system A based on the group information and pointer information .

In the above described journal read reception processing the journals are sequentially transmitted from the primary storage system A to the auxiliary storage system B in the order of update numbers. As a modification example the journals may be transmitted in the order different from that of the update numbers. Alternatively a plurality of journals may be transmitted in parallel from the primary storage system A to the auxiliary storage system B. In this case a table or a search method for finding the logical address where the update information was stored from the update number can be provided in the auxiliary storage system B thereby making it possible to process the journals in the order of update numbers in the restore processing of the auxiliary storage system B.

In the present embodiment the primary storage system A acquires the journals the auxiliary storage system B reads the journals from the primary storage system A and data copying is conducted based thereon. As a result the host computer connected to the primary storage system A bears no load relating to data copying. Furthermore because the journals are transferred between the primary storage system A and the auxiliary storage system B the communication line between the primary storage system A and the host computer is not used for data copying.

As shown in in the present embodiment a third storage system C is added to the primary storage system A and the auxiliary storage system B. The physical configuration of the storage systems A B and C basically may be identical to the configuration that has already been explained with reference to . The host computer and the third storage system C are connected by a connection path the third storage system C and the primary storage system A are connected by the connection path and the primary storage system A and the auxiliary storage system B are connected by the connection path . The third storage system C comprises original logical volumes ORG 1 ORG 2 and the like holding respective data on the source of data in the primary logical volumes DATA 1 DATA 2 and the like in the primary storage system A.

The third storage system C updates the data original data in the required original logical volume for example ORG 1 in response to a data write command from the host computer . At this time the third storage system C not only updates the original data present in the original logical volume for example ORG 1 but also sends to the primary storage system A the data write command for updating the data present in the primary logical volume DATA 1 corresponding to the original data of the update object step .

The primary storage system A as was explained in the first embodiment receives the aforesaid data write command updates the data of the required primary logical volume for example DATA 1 and saves the journals of the data update in the journal logical volume JNL 1 by the above described command reception processing and read write processing step .

The auxiliary storage system B reads the journals from the primary storage system A by the above described journal read processing and saves the journals in the journal logical volume JNL 2 by the read write processing .

If the journal read command is received from the auxiliary storage system B the primary storage system A reads the journals from the journal logical volume JNL 1 by the command reception processing and read write processing and sends them to the auxiliary storage system B .

The auxiliary storage system B reads the journals from the journal logical volume JNL 2 in the order of update numbers by the above described restore processing and read write processing and updates the data of the auxiliary logical volume COPY 1 which is the copy of the primary logical volume DATA 1 . Thus updating the data in the order of update numbers makes it possible to maintain the compatibility of data between the logical volumes.

In the data processing system shown in the primary storage system A acquires the journals and stores them in a storage area specifically allocated for journals. Furthermore the auxiliary storage system B stores the journals received from the primary storage system in a storage area specifically allocated for journals. In this system the storage area specifically allocated for journals can be made less than the storage area for data copying object and copying of data form the primary storage system to the auxiliary storage system can be conducted with a smaller storage capacity.

As shown in in the present embodiment a third storage system C is added to the primary storage system A and the auxiliary storage system B. The physical configuration of the storage systems A B and C basically may be identical to the configuration that has already been explained with reference to . The host computer and the third storage system C are connected by the connection path the third storage system C and the primary storage system A are connected by the connection path and the primary storage system A and the auxiliary storage system B are connected by the connection path .

The primary storage system A shows the third storage system C as if the primary logical volumes DATA 1 DATA 2 and the like are present but does not allocate the actual physical storage area that is the physical storage unit for the primary logical volumes DATA 1 DATA 2 and the like . For example the prescribed numerical value is set this value indicating that no physical storage unit was allocated from the physical addresses of each primary logical volume in the volume information . Therefore the primary logical volumes DATA 1 DATA 2 and the like in the primary storage system A are virtual. The primary storage system A has the journal logical volume JNL 1 for saving the journal of data update of those virtual primary logical volumes DATA 1 DATA 2 and the like and the actual physical storage areas are allocated thereto. The third storage system C has original logical volumes for example ORG 1 ORG 2 and the like where the actual data equivalent to the data in the virtual primary logical volumes DATA 1 DATA 2 and the like in the primary storage system A were saved and the actual physical storage areas are allocated thereto.

The third storage system C updates the data original data of the required original logical volume for example ORG 1 in response to the data write command from the host computer . At this time the third storage system C not only updates the original data but also sends to the primary storage system A a data write command for updating the data present in the virtual primary logical volume for example DATA 1 corresponding to the updated original data .

If the primary storage system A receives the write command for the data present in the virtual primary logical volume for example DATA 1 from the third storage system C it saves the journal of the data update in the journal logical volume JNL 1 without conducting the processing issuance of a data write command to the disk adapter of step of the command reception processing shown in .

The auxiliary storage system B reads the journals from the primary storage system A by the above described journal read processing and saves them in the journal logical volume JNL 2 by the read write processing .

If the primary storage system A receives the journal read command from the auxiliary storage system B it reads the journals from the journal logical volume JNL 1 by the command reception processing and read write processing and transmits the journals to the auxiliary storage system B .

The auxiliary storage system B reads the journals from the journal logical volume JNL 2 according to the update number by the above described restore processing and read write processing and updates the data of the auxiliary logical volume for example COPY 1 which is the copy of the original logical volume for example ORG 1 . Thus the compatibility of data between the logical volumes can be maintained by updating the data in the order of update numbers.

In the data processing system shown in when a failure occurs in the third storage system C or the host computer connected to the third storage system C the journal JNL 1 present in the primary storage system A is reflected in the logical volume for example COPY 1 of the auxiliary storage system B thereby making possible the reference to and update of the newest data with the host computer not shown in connected to the auxiliary storage system B. Furthermore it is possible to reduce the quantity of information necessary for data copying by storing only the journals without holding the copy of the original data in the primary storage system A.

As shown in this embodiment comprises a primary storage system A and a plurality for example two auxiliary storage systems B C. Physical structures of all those storage systems A B C may be basically identical to those that have already been explained with reference to . The host computer and the primary storage system A are connected by a connection path the primary storage system A and the first auxiliary storage system B are connected by a connection path and the primary storage system A and the second auxiliary storage system C are connected by a connection path . In the primary storage system A the prescribed plurality of primary logical volumes for example DATA 1 DATA 2 and journal logical volume for example JNL 1 constitute one group group 1 . In the first auxiliary storage system B a plurality of auxiliary logical volumes for example COPY 1 COPY 2 which are the respective copies of the plurality of primary logical volumes DATA 1 DATA 2 belonging to the above mentioned group 1 and the journal logical volume for example JNL 2 constitute the same group group 1 . Similarly in the second auxiliary storage system C a plurality of auxiliary logical volumes for example COPY 3 COPY 4 which are the respective copies of primary logical volumes DATA 1 DATA 2 of group 1 and the journal logical volume for example JNL 3 constitute the same group group 1 .

Because a plurality of auxiliary storage systems B C are present for one primary storage system A as shown as an example in a plurality of sets of pointer information B C corresponding to respective auxiliary storage systems B C are held in the primary storage system A. The pointer information B for the first auxiliary storage system B is held in the first auxiliary storage system B and the pointer information C for the second auxiliary storage system C is held in the second auxiliary storage system C. The structure and meaning of those sets of pointer information B C are identical to those that have already been explained with reference to and . The different auxiliary storage systems B C conduct the journal read processing and restore processing according to respective independent schedules. Therefore as shown in the addresses indicated by the pointer information B C for the different auxiliary storage systems B C are not necessarily identical.

If the primary storage system A receives a write command with respect to the data of a certain primary logical volume for example DATA 1 from the host computer it updates the required data within the primary logical volume for example DATA 1 by the above described command reception processing and read write processing and holds the journal of this data update in the journal logical volume JNL 1 .

The first auxiliary storage system B reads the journals from the primary storage system A by the above described journal read processing and holds this journal in the journal logical volume JNL 2 by the read write processing . Here the timing at which the first auxiliary storage system B reads the journals the timing of sending the journal read command to the primary storage system A is independently scheduled by the channel adapter of the first auxiliary storage system B. This journal read timing as has already been explained with reference to step shown in may be for example immediately after the normal end of journal storage processing of the previous journal or after a fixed interval elapses since the normal end of journal storage processing of the previous journal or periodically with a fixed time spacing. When the journal read command is sent periodically this time interval may be controlled according to the number of received journals communication capacity of connection path storage capacity of the journals held by the first auxiliary storage system B or the load of the first auxiliary storage system B. Furthermore the first auxiliary storage system B reads the storage capacity of the journals held by the primary storage system A or the pointer information of the primary storage system A and the above mentioned time interval may be controlled based on the numerical values thereof. Transfer of this information may be conducted by a special command or may be contained in the response to the journal read command. In any case it is not necessary that the timing for reading the journals be synchronized with the other auxiliary storage system C.

If the primary storage system A receives a command for reading a journal from the auxiliary storage system B it reads the journal from the journal logical volume JNL 1 and transmits it to the first auxiliary storage system B by the command reception processing and read write processing .

The first auxiliary storage system B reads the journal from the journal logical volume JNL 2 according to the update number by the above described restore processing and read write processing and updates the data of the auxiliary logical volume COPY 1 which is the copy of the primary logical volume DATA 1 . Thus the compatibility of data between the logical volumes can be maintained by updating the data in the order of update numbers.

The second auxiliary storage system C reads the journal from the primary storage system A by the above described journal read processing and saves the journal in the journal logical volume JNL 3 by the read write processing . Here the timing at which the second auxiliary storage system C reads the journals the timing of sending the journal read command to the primary storage system A is independently scheduled by the channel adapter of the second auxiliary storage system C. This journal read timing as has already been explained with reference to step shown in may be for example immediately after the normal end of journal storage processing of the previous journal or after a fixed interval elapses since the normal end of journal storage processing of the previous journal or periodically with a fixed time spacing. When the journal read command is sent periodically this time interval may be controlled according to the number of received journals communication capacity of connection path storage capacity of the journals held by the second auxiliary storage system C or the load of the second auxiliary storage system C. Furthermore the second auxiliary storage system C reads the storage capacity of the journals held by the primary storage system A or the pointer information of the primary storage system A and the above mentioned time interval may be controlled based on the numerical values thereof. Transfer of this information may be conducted by a special command or may be contained in the response to the journal read command. In any case it is not necessary that the timing for reading the journals be synchronized with the other auxiliary storage system B.

If the primary storage system A receives a command for reading a journal from the second auxiliary storage system C it reads the journal from the journal logical volume JNL 1 and transmits it to the second storage system C by the command reception processing and read write processing .

The second auxiliary storage system C reads the journal from the journal logical volume JNL 3 according to the update number by the above described restore processing and read write processing and updates the data of the auxiliary logical volume COPY 3 which is the copy of the primary logical volume DATA 1 . Thus the compatibility of data between the logical volumes can be maintained by updating the data in the order of update numbers.

As described hereinabove different auxiliary storage systems B C conduct the journal read processing and restore processing with the independently scheduled timing. The auxiliary storage systems B C send to the primary storage system A the respective notifications about the end of restore processing or journal read processing containing the update number at which the restore processing or journal read processing was ended if the restore processing or journal read processing has ended. The primary storage system A manages the information indicating which of the auxiliary storage systems B C has ended the restore processing or journal read processing and at which update number the processing was ended based on the restore processing or journal read processing end notification from the auxiliary storage systems B C. Then based on this information the primary storage system A releases the storage areas of respective journals in the journal logical volume JNL 1 with respect to the journals with the update numbers for which the restore processing or journal read processing has ended in all the auxiliary storage systems B C. With respect to the journal with an update number for which the restore processing or journal read processing has not been ended in any one of the auxiliary storage systems B C the primary storage system A retains this journal in the journal logical volume JNL 1 and does not release the storage area of this journal.

With the data processing system shown as an example in even if a failure occurs in one of a plurality of auxiliary storage systems copying of the primary logical volume can be maintained by the other normal auxiliary storage system therefore safety is high.

In the data processing system shown in two auxiliary storage systems B C are present for one primary storage system A. As a modification example three or more auxiliary storage systems B C may be provided for one primary storage system A.

In the data processing system shown in a plurality of auxiliary storage systems B C read journals in parallel from one primary storage system A. As a modification example in addition to a function of reading the journals from the primary storage system A the auxiliary storage systems B C can be also provided with a function of reading journals from other auxiliary storage systems and be able to select as to whether to read the journals from the primary storage system A or the other auxiliary storage system. For example when the load of the primary storage system A is low all the auxiliary storage systems B C read the journals from the primary storage system A but when the load of the primary storage system A is high the control can be conducted so that the first auxiliary storage system B reads the journals from the primary storage system A and then the second auxiliary storage system B reads the journals from the first auxiliary storage system B.

Several embodiments of the present invention were described hereinabove. With those embodiments data transfer or data copying can be conducted between a plurality of storage systems without adversely affecting the host computer of the storage systems or the communication between the storage systems and the computer.

Furthermore with some embodiments the data storage area held in a plurality of storage systems can be decreased. Furthermore with some embodiments data transfer or data copying between a plurality of storage systems can be conducted effectively and at a high rate without greatly affecting the operation of the host computer of a plurality of storage systems.

It goes without saying that the present invention is not limited to the above described embodiments and various modifications can be made without departing from the essence of the present invention.

