---

title: Optical aberration correction for machine vision inspection systems
abstract: A high-accuracy optical aberration correction system and method. Z-heights determined by an auto-focus tool, which would otherwise vary depending on the orientation angle of surface features or edges in the focus region of interest, and on the location of the focus region of interest in the field of view, are corrected based on a novel error calibration method. Error calibration data includes a set of Z-corrections for a range of different feature orientation angles (e.g., 180 degrees), for multiple locations in the field of view. Error calibration data may be interpolated to correspond to the location of the current focus region of interest. During auto-focus measurements, a Z-correction may be adapted for a current measurement by weighting orientation-dependent error calibration data based on a histogram of the gradient (edge) directions present in the current focus region of interest.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07724942&OS=07724942&RS=07724942
owner: Mitutoyo Corporation
number: 07724942
owner_city: Kawasaki-shi
owner_country: JP
publication_date: 20051031
---
The present invention relates to machine vision metrology systems and more particularly to a high accuracy optical aberration correction system and method which corrects for errors e.g. Z height measurement errors caused by lens aberrations such as astigmatism.

Precision machine vision inspection systems or vision systems in short can be utilized to obtain precise dimensional measurements of inspected objects and to inspect various other object characteristics. Such systems may include a computer a camera and optical system and a precision stage that is movable in multiple directions so as to allow the camera to scan the features of a workpiece that is being inspected. One exemplary prior art system that is commercially available is the QUICK VISION series of PC based vision systems and QVPAK software available from Mitutoyo America Corporation MAC located in Aurora Ill. The features and operation of the QUICK VISION series of vision systems and the QVPAK software are generally described for example in the QVPAK 3D CNC Vision Measuring Machine User s Guide published January 2003 and the QVPAK 3D CNC Vision Measuring Machine Operation Guide published September 1996 each of which is hereby incorporated by reference in their entirety. This product as exemplified by the QV 302 Pro model for example is able to use a microscope type optical system to provide images of a workpiece at various magnifications and move the stage as necessary to traverse the workpiece surface beyond the limits of any single video image.

Accuracies in the micron range are often desired in such systems. Z height measurements along the optical axis of the camera system are generally derived from a best focus position. The level of precision and reliability achieved for Z height measurements is often less than that achieved for other measurement axes. It would be desirable for a machine vision inspection system to be able to obtain Z height measurements with improved accuracy and reliability. Furthermore in certain machine vision inspection systems an autofocus tool may be utilized to obtain the best focus position and the resulting Z height measurement. It would be desirable for an autofocus tool to operate automatically with improved accuracy and reliability. The present invention is directed to providing a system and method that can overcome the foregoing and other disadvantages.

A high accuracy optical aberration correction system and method are provided. More specifically the present invention is directed to a high accuracy optical aberration correction system and method that corrects for focus errors and or Z height measurement errors that include a dependence on the orientation of directional features in the field of view. Such errors may be caused by lens aberrations such as astigmatism as well as other features or imperfections of the machine vision optical system. In astigmatism the focal length of the lens is different for rays crossing the lens in different planes which corresponds to features e.g. edges located at different angles in the field of view . As a result the focus Z position of the lens is different for different dominant directions of edges in the field of view.

More specifically the inventor has found that significant Z height measurement variations errors may occur when measuring a surface or feature that exhibits directional features in the field of view. The variations depend on the orientation of the directional features e.g. the orientation of striated textures lines edges and the like in the field of view. Such directional surfaces and features are referred to as anisotropic surfaces and features herein. Such variations errors that depend on the orientation of directional features are generally referred to as astigmatism errors herein regardless of the underlying physical processes responsible for the errors.

When the focus position corresponding to a focus region of interest ROI in the field of view is characterized as a function of the direction angle of edges or texture visible in the focus ROI and measured surfaces are then characterized in terms of their dominant edge or gradient direction the appropriate Z compensation can be applied for each surface measured in that focus ROI canceling the focus position error corresponding to the dominant edge direction in the focus ROI. This makes all Z measurements less dependent on and nominally independent of the direction of the edges or texture in the focus ROI.

In many cases the stronger or more apparent the texture or line edges and or directionality the more significant the astigmatism errors. Furthermore it has been found that astigmatism errors may vary significantly over the camera field of view. That is given a uniform directional texture throughout the field of view a focus operation based on image data from one part of the field of view from one ROI may result in a different Z height measurement than a focus operation based on image data from another part of the field of view from another ROI . Such ROI dependent astigmatism errors may be at least partially compensated or corrected by the systems and methods disclosed herein to improve Z height measurement accuracy and decrease measurement variability throughout a field of view.

The error correction systems and methods disclosed herein may also generally correct for focus variations and or Z height variations that depend on the location of the measurement in the field of view independent of any astigmatism errors. For example such variations may be due to lens field curvature due to the imperfect perpendicularity of the camera CCD to the optical axis of the system due to curvature of the CCD due to the imperfect perpendicularity of the optical axis of the vision system to the vision system stage and similar error sources that may cause the best focus position to vary over the field of view. Such errors are generally collectively referred to as static optical errors herein regardless of the underlying physical processes responsible for the errors. Static optical errors result in varying Z height measurements for a workpiece surface having a static height when it is measured at different locations in the camera field of view even for surfaces or patterns that do not exhibit directional features. Such non directional surfaces and patterns are referred to as isotropic surfaces and patterns herein.

In accordance with one aspect of the invention astigmatism errors are characterized using a directional pattern that is oriented at different respective calibration angles as the basis for respective Z height measurements that include respective astigmatism error components. Such Z height measurements of directional patterns are also referred to as anisotropic measurements herein.

It will be appreciated that anisotropic measurements generally include both an astigmatism error component and a static optical error component that is combined errors. Such combined errors in an anisotropic measurement are referred to as anisotropic errors herein. In accordance with one aspect of the invention anisotropic errors may be determined and the resulting anisotropic error calibration data may be stored for compensating or correcting the anisotropic error of future Z height measurements.

In accordance with a further aspect of the invention the difference between a Z height measurement using a directional pattern an anisotropic measurement and an isotropic Z height measurement described further below at the same location in the field of view may determine the astigmatism error component or astigmatism error calibration data at that location. The resulting astigmatism error calibration data may be stored for compensating or correcting the astigmatism error component of future Z height measurements.

In accordance with a further aspect of the invention anisotropic errors and or astigmatism errors are characterized at a plurality of locations within the field of view. The resulting calibration data is stored for compensating or correcting future Z height measurement errors including basing the correction on the location within the field of view that provides the data used to determine a Z height measurement. In various embodiments a plurality of anisotropic measurements and or anisotropic errors and or astigmatism errors may be determined corresponding to precisely known positions in the field of view and interpolation can then be done to estimate anisotropic measurements and or anisotropic errors and or astigmatism errors associated with any particular location in the field of view.

In accordance with a further aspect of the invention anisotropic errors and or astigmatism errors are characterized for each particular lens or lens combination or magnification used in a machine vision system. The resulting calibration data is stored for compensating or correcting future Z height measurement errors when using that particular lens or lens combination or magnification. 

In accordance with another aspect of the invention a calibration target may be utilized for obtaining the calibration data. A calibration target may consist of a plurality of respective anisotropic target elements each of which includes a directional pattern oriented in a different respective angular direction. In one embodiment the respective anisotropic target elements may provide different respective angular directions that cover 0 180 in discrete angular steps. The step size can vary depending on the desired granularity of the calibration data. As examples the granularity may correspond to a step size of 5 or 7.5 or 15 etc.

In accordance with another aspect of the invention static optical errors may be characterized using Z height measurement data provided using the calibration target. In one embodiment the static optical errors are characterized based on averaging a series of measurements of the anisotropic target elements to provide a Z height measurement wherein the astigmatism error component s have in effect been removed by the averaging. Such averaging provides a first type of isotropic or non directional measurement usable to determine static optical errors.

In accordance with a further aspect of the invention static optical errors are characterized at a plurality of locations within the field of view. The resulting calibration data is stored for compensating or correcting future Z height measurement errors including basing the correction on the location within the field of view that provides the data used to determine the static optical errors. In one embodiment a plurality of isotropic measurements and or static optical errors may be determined corresponding to precisely known positions in the field of view and interpolation can then be done to estimate isotropic measurements and or static optical errors associated with any particular location in the field of view.

In accordance with another aspect of the invention isotropic target elements that is target elements consisting of a pattern that lacks directionality may be provided on the calibration target. Since astigmatism errors are minimized or eliminated when measuring isotropic patterns by focusing on one of these patterns a Z height measurement may be obtained that nominally includes only static optical errors if any. Such isotropic target element measurements provide a second type of isotropic or non directional measurement usable to determine static optical errors. A plurality of isotropic target elements may be provided and since their positions on the calibration target are known precisely interpolation can be done to estimate isotropic measurements and or static optical errors associated with any particular location on the calibration target.

In accordance with another aspect of the invention as outlined in greater detail below it is possible to determine a true or reference Z height measurement based on a set of isotropic measurements. That is a true or reference Z height measurement may be estimated that nominally includes no static optical errors and no astigmatism errors. The difference between a true or reference Z height estimate and an anisotropic Z height measurement at the same location determines an anisotropic error or anisotropic error calibration data at that location. The difference between a true or reference Z height estimate and an isotropic Z height measurement at the same location determines a static optical error component or static optical error calibration data at that location. Static optical errors may also be referred to as isotropic errors herein.

In accordance with another aspect of the invention a calibration target may consist of multiple differently sized sets of respective target elements. Within each set each of the respective target elements may be designed to be slightly larger than the field of view at the lowest magnification for which that particular set of target elements is designed. In addition within each set the density or spacing of any anisotropic features within the target element patterns and isotropic features if included may be selected to provide good calibration with the magnification s that it is designed for for example the features should be thick enough in comparison to the camera pixel spacing so as to prevent aliasing and there should be enough features in the field of view e.g. lines and spaces texture scratches or the like so as to provide a strong pattern in the field of view particularly for the anisotropic target elements.

In accordance with another aspect of the invention after calibration data is obtained during a subsequent Z height measurement for a particular region of interest ROI within the field of view e.g. by using an autofocus tool the Z height measurement is corrected by interpolating or extrapolating the calibration data to obtain a correction value that corresponds to that particular location of the region of interest. A first part of this process may include reconstructing or augmenting existing calibration error correction data to estimate values corresponding to the particular position of an autofocus tool region of interest in the field of view. The reconstruction or estimation may be performed by interpolation e.g. bilinear biquadratic bicubic etc. of the error correction data captured at discrete locations within the field of view during the calibration process. A second part of this process may include using the reconstructed or estimated error correction data to compute the Z correction to the initial or raw Z position determined by the autofocus routine.

In accordance with a further aspect of the invention after calibration data is obtained according to this invention during a subsequent Z height measurement for a particular region of interest ROI within the field of view for example based on an autofocus tool a Z correction is computed and applied according to calibration error correction data weighted according to one or more weighting factors that depend on the strength and or orientation of features present in the region of interest. In one embodiment the strength and or orientation of features present in the region of interest is determined in comparison to the strength and or orientation of features of the anisotropic target elements used to determine the relevant calibration data.

In accordance with a further aspect of the invention in various embodiments a histogram of gradient edge directions determined in the region of interest may be used to determine one or more direction weighting or interpolation factors. In various embodiments a histogram of gradient edge strength determined in the region of interest may be used to determine one or more strength weighting factors.

In accordance with another aspect of the invention a histogram may be formed by computing both gradient magnitudes and directions or rather directions that are in one embodiment perpendicular to gradient directions in order to make them consistent with the edge direction data in a set of error calibration data . The gradient computations may be performed corresponding to each pixel in an autofocus tool region of interest. The pixels for which gradient magnitudes are smaller than a certain low noise threshold may be discarded from consideration in embodiments where it is desirable to deal only with relatively strong edges as compared to image noise. If the image noise is significant the region of interest can be additionally smoothed with a spatially small averaging filter before the gradient magnitude and direction computation. A histogram of the gradient directions may then be created for all the remaining qualified pixels that is the pixels for which the gradient magnitude exceeds the appropriate noise threshold and the calibration data weighted accordingly.

According to various aspects of the invention outlined above the calibration data may distinguish static optical errors from astigmatism errors. In such a case the static optical errors may be compensated directly from the static optical error calibration data without the need for additional computations related to weighting factors or the like when a measurement region of interest lacks significant directional content.

In various embodiments to determine the anisotropic error and or static optical error at various locations in the field of view a realistic generic model is established for the calibration target substrate shape based on analysis or experiment. For example it may be assumed to be planar and potentially tilted relative to the optical system axis. Alternatively it may also be assumed to have curvature along one or more directions. Depending on the model straight lines curved lines or a plane or a curved surface may be fit to a plurality of isotropic Z height measurements as described in greater detail below. The resulting best fit substrate location may be used as an estimate of the reference or true Z height measurement value at locations throughout its range of applicability. The difference between the anisotropic Z height measurement and the true Z height value at various locations may be used to determine the anisotropic errors and associated anisotropic error calibration data for the various locations. The difference between the isotropic Z height measurement and the true Z height value at various locations may be used to determine the static optical errors and associated static optical error calibration data for the various locations.

The vision measuring machine includes a moveable workpiece stage and an optical imaging system which may include a zoom lens or interchangeable lenses. The zoom lens or interchangeable lenses generally provide various magnifications for the images provided by the optical imaging system . The machine vision inspection system is generally comparable to the QUICK VISION series of vision systems and the QVPAK software discussed above and similar state of the art commercially available precision machine vision inspection systems. The machine vision inspection system is also described in U.S. patent application Ser. No. 10 978 227 which is incorporated herein by reference.

A workpiece that is to be imaged using the machine vision inspection system is placed on the workpiece stage . One or more of the light sources and emits source light or respectively that is usable to illuminate the workpiece . Light emitted by the light sources and or illuminates the workpiece and is reflected or transmitted as workpiece light which passes through the interchangeable objective lens and the turret lens assembly and is gathered by the camera system . The image of the workpiece captured by the camera system is output on a signal line to the control system portion .

The light sources and that are used to illuminate the workpiece can include a stage light a coaxial light and a surface light such as a ring light or a programmable ring light all connected to the control system portion through signal lines or busses and respectively. As a primary optical assembly of the machine vision inspection system the optical assembly portion may include in addition to the previously discussed components other lenses and other optical elements such as apertures beam splitters and the like such as may be needed for providing coaxial illumination or other desirable machine vision inspection system features. When it is included as a secondary optical assembly of the machine vision inspection system the turret lens assembly includes at least a first turret lens position and lens and a second turret lens position and lens . The control system portion controls rotation of the turret lens assembly along axis between at least the first and second turret lens positions through a signal line or bus .

The distance between the workpiece stage and the optical assembly portion can be adjusted to change the focus of the image of the workpiece captured by the camera system . In particular in various exemplary embodiments the optical assembly portion is movable in the vertical Z axis direction relative to the workpiece stage using a controllable motor that drives an actuator a connecting cable or the like to move the optical assembly portion along the Z axis. The term Z axis as used herein refers to the axis that is intended to be used for focusing the image obtained by the optical assembly portion . The controllable motor when used is connected to the input output interface via a signal line .

As shown in in various exemplary embodiments the control system portion includes a controller an input output interface a memory a workpiece program generator and executor a CAD file feature extractor and a power supply portion . It will be appreciated that each of these components as well as the additional components described below may be interconnected by one or more data control buses and or application programming interfaces or by direct connections between the various elements.

The input output interface includes an imaging control interface a motion control interface a lighting control interface and a lens control interface . The motion control interface includes a position control element A and a speed acceleration control element B. However it should be appreciated that in various exemplary embodiments such elements may be merged and or indistinguishable. The lighting control interface includes lighting control elements which control for example the selection power on off switch and strobe pulse timing if applicable for the various corresponding light sources of the machine vision inspection system such as the light sources and .

The memory includes an image file memory portion a workpiece program memory portion that may include one or more part programs or the like and a video tool portion . The video tool portion includes tool portions which determine the GUI image processing operations etc. for each of the corresponding tools. In various exemplary embodiments of the present invention the video tool portion also includes an autofocus tool an autofocus correction portion a look up table generator portion A a look up table memory portion B an interpolation portion C and a direction strength determining portion D. As will be described in more detail below the autofocus correction portion may correct for Z height measurement errors that result during the operations of the autofocus tool including correcting for astigmatism errors when they are present.

The look up table generator portion A may prepare error correction calibration data e.g. look up tables or any other alternate form or arrangement of error correction calibration data for each particular lens and or particular magnification. In one embodiment the calibration data for a lens includes a set of vertical Z corrections including corrections for astigmatism errors over a 0 180 range of orientations of a directional pattern for multiple spots in a lens camera field of view. In one embodiment the calibration data may include vertical Z corrections including a set of corrections for static optical errors and a set of corrections for astigmatism errors for multiple spots in a field of view. In another embodiment the calibration data may include vertical Z corrections including a set of corrections for anisotropic errors for multiple spots in a field of view. The look up tables are stored in the look up table memory portion B. It should be appreciated that although error calibration data is generally described herein as being determined and stored in the form of look up tables such embodiments are exemplary only and not limiting. More generally any element or method described herein as generating or storing a look up table should be understood as representative of a more general element or method that may generate or store any other now known or later developed form or arrangement of error calibration data that is usable to correct Z height measurements according to the principles of this invention.

The interpolation portion C is utilized for the interpolation extrapolation or other estimate or reconstruction of the look up table data for the position in the field of view corresponding to a current focus region of interest for example an autofocus tool region of interest. Generally the reconstruction is performed by interpolation e.g. bilinear biquadratic bicubic etc. of the error calibration values of the look up tables or the like stored in the look up tables memory portion B. The direction strength direction and strength determining portion D is utilized for determining appropriate measures of the direction nominal orientation and or strength e.g. gradient magnitude of the content of a focus region of interest. In one embodiment the direction strength determining portion D determines a histogram of the gradient edge directions present in the current focus region of interest which as will be described in more detail below may be utilized with reconstructed interpolated error calibration data for computing and applying an appropriate correction to a Z height measurement.

The video tool portion still further includes a region of interest generator that supports automatic semi automatic and or manual operations that define various regions of interest that are operable in various video tools included in the video tool portion . In general the memory portion stores data usable to operate the vision system components portion to capture or acquire an image of the workpiece such that the acquired image of the workpiece has desired image characteristics. The memory portion further stores data usable to operate the machine vision inspection system to perform various inspection and measurement operations on the acquired images either manually or automatically and to output the results through the input output interface .

The signal lines or busses and of the stage light the coaxial light and the surface light respectively are all connected to the input output interface . The signal line from the camera system and the signal line from the controllable motor are connected to the input output interface . In addition to carrying image data the signal line may carry a signal from the controller that initiates image acquisition.

One or more display devices and one or more input devices can also be connected to the input output interface . The display devices and input devices can be used to view create and or modify part programs to view the images captured by the camera system and or to directly control the vision system components portion . In a fully automated system having a predefined part program or workpiece program the display devices and or the input devices may be omitted.

With regard to the CAD file feature extractor information such as a CAD file representing a workpiece is frequently available in industrial applications of machine vision inspection systems. The locations of edges boundaries and or workpiece feature patterns in the CAD file representation may be determined manually in a semi automated fashion or fully automatically and such information may be useful for workpiece part programming or navigating to a desired workpiece feature.

In various exemplary embodiments when a user utilizes the machine vision inspection system to create a workpiece image acquisition program for the workpiece the user generates workpiece program instructions either by explicitly coding the instructions automatically semi automatically or manually using a workpiece programming language or by generating the instructions by moving the machine vision inspection system through an image acquisition training sequence such that the workpiece program instructions capture the training sequence. This process is repeated for multiple images in a set of images that are to be captured. These instructions when executed will cause the machine vision inspection system to manipulate the workpiece stage and or the camera system at certain speed s such that a particular portion of the workpiece is within the field of view of the camera system and at a desired focus state for each of a set of images to be acquired. In addition to the program instructions that control the relative movement of the camera and the workpiece the workpiece image acquisition program also needs to include program instructions that activate one or more of the light sources to provide a desired illumination of the workpiece during each image acquisition.

Once a set of workpiece image acquisition instructions are defined in various exemplary embodiments of the present invention the control system executes the instructions and commands the camera system to capture one or more images of the workpiece according to the instructions. The control system will then under control of the controller input the captured image s through the input output interface and store the captured image s in the memory . The controller may also display the captured images on the display device .

The control system portion is further usable to recall captured and stored workpiece inspection images to inspect and analyze workpiece features in such workpiece inspection images and to store and or output the inspection results. These methods are typically embodied in various video tools included in the video tool portion of the memory such as the autofocus tool edge boundary detection tools dimension measuring tools coordinate matching tools and the like. Some of these tools are routinely used in a variety of commercially available machine vision inspection systems such as the QUICK VISION series of vision systems and the associated QVPAK software.

After the image inspection analysis operation using one or more of these video tools is completed the control system outputs the results of each analysis inspection operation to the input output interface for outputting to various display devices such as a video display printer and the like. The control system may also store the results of each inspection operation in the memory .

The ideal striped surfaces of illustrate a directional pattern that creates a basic measurement problem that the present invention is intended to address. More specifically it has been determined experimentally that for many actual machine vision systems height measurements Z position that are performed based on a contrast metric or the like may vary significantly when measuring targets that present texture or lines that exhibit an apparent orientation. Conventional autofocus tools typically use such contrast metrics to determine their best focus position and the associated Z height measurement. Therefore as disclosed herein the Z height measurements determined using such tools may vary significantly when a target that includes a directional pattern is placed in different orientations such as the 0 orientation of when compared with the 90 orientation of even when the true Z height of the target surface has not changed. Such unwanted measurement variations are described in more detail below with respect to .

The varying height measurements of the graph lines and are obtained with a conventional autofocus tool. The measurements are taken at a consistent region of interest location in the field of view as the nominal orientation of each surface pattern is rotated over 180 . The graph lines and illustrate that astigmatism errors cause varying Z height measurements for anisotropic surface patterns graph lines and as they are rotated through 180 and that astigmatism errors do not significantly affect Z height measurements for isotropic surface patterns graph line . As shown in the Z height measurements for the graph lines and corresponding to the ideal striped and textured surfaces respectively show significant Z value variations as a function of orientation with the stronger directional pattern the ideal stripe pattern graph line showing larger astigmatism errors than the weaker directional pattern the directional texture pattern graph line . More specifically the graph line shows a Z height variation of approximately 5 microns while the Z height variation for the graph line is approximately 3.7 microns as compared to the graph line for the isotropic surface which shows a small Z height variation of approximately 0.26 microns.

The present invention provides a method for correcting astigmatism errors. In preferred embodiments the method also corrects static optical errors if any. As will be described in more detail below with regard to error calibration data e.g. look up tables are prepared for each particular lens combination and or particular magnification. In one embodiment the calibration data may include a set of Z height measurement corrections including corrections for astigmatism errors over a 0 180 range of orientations of a directional pattern for multiple spots in a lens field of view. The calibration data may also include Z height measurement corrections for static optical errors for multiple spots in a lens field of view. In a preferred embodiment the calibration data may include a set of Z height measurement corrections including corrections for anisotropic errors over a 0 180 range of orientations of a directional pattern for multiple spots in a lens field of view. Then as will be described in more detail below with respect to during an autofocus Z height measurement a Z correction is computed and applied. The Z correction may be determined according to interpolated calibration data reconstructed from the calibration look up table s to correspond to a current location in the field of view. The Z correction may include an adjustment weighting or selection of the magnitude of an anisotropic error correction or an astigmatism error correction based on a histogram of the gradient directions representing the orientation angle content characteristics of the directional surface features present in the current autofocus tool region of interest.

In one embodiment each of the rectangular anisotropic target elements may include a striped surface pattern for example a pattern similar to that shown in oriented at a specific angle. For example the 0 rectangular target element in column and row may include horizontally oriented stripes while the 90 rectangular target in column and row may include vertically oriented stripes. Each of the other rectangular target elements contains an identical striped pattern oriented at the respective angle indicated in . Together they cover a 0 180 range of orientation angles in discrete steps of 7.5 degrees. Since the 180 direction is equivalent to the 0 direction no additional 180 target element is included in this embodiment. In various other embodiments the step size can vary depending on a desired granularity of the anisotropic or astigmatism error calibration data or look up tables. In the granularity is 7.5 . It will be understood that all of the rectangular target elements include striped surface patterns not shown respectively oriented at the illustrated degree numbers. Thus even though the 15 rectangular target element in column and row is illustrated as having the number 15 it will be understood that in the actual embodiment the rectangular target element will actually include a striped surface pattern oriented at 15 . In other embodiments the anisotropic target elements may have other types of directional patterns for example a texture pattern or a striated texture pattern or an anisotropic pattern chosen to match a pattern that is frequently encountered on an inspection workpiece.

The anisotropic calibration targets described above are general purpose astigmatism error calibration targets. Another type of anisotropic calibration target may be particularly useful for calibrating errors that may otherwise be present in an edge focus type of autofocus operation as opposed to the surface autofocus that is generally assumed herein. An edge focus operation may find a z height that maximizes the intensity gradient across an edge for example rather than the more general area based contrast measures that are typically used for surface autofocus operations. In an embodiment that emphasizes correction of edge focus astigmatism errors a single straight edge a border between a light zone and a dark zone may be used as an anisotropic target element. Because such a target element is asymmetric the range of orientation angles used for calibration is preferably 0 360 rather than the 0 180 range previously described.

The target element group A also includes a set of 35 isotropic target elements . As described in greater detail below each respective isotropic target element may be used for finding an isotropic measurement Z height also referred to as an isotropic measurement at their respective locations. It may be convenient to use the center of an isotropic target element as the reference point for its location. If desired the astigmatism error components included in adjacent anisotropic target element measurements can be isolated by subtracting a coinciding interpolated isotropic measurement as described below to provide astigmatism error calibration data.

In operation since astigmatism errors are minimized or absent when measuring isotropic patterns e.g. the isotropic target elements performing autofocus measurements on these patterns provides isotropic measurements that are nominally free of astigmatism errors. In one exemplary set of operations for determining true and or reference Z height values for various locations on the calibration target if the same autofocus region of interest position within the field of view e.g. the center of the field of view is used to measure each of the isotropic patterns the static optical error components will be nominally the same for all such measurements. Thus this procedure will provide the raw Z height measurements at the locations of the isotropic patterns on the calibration target that each contain only the same common mode static optical errors. Thus the differences between such Z height measurements are nominally due only to true Z height differences in various portions of the calibration target substrate surface. Thus one set of such isotropic Z height measurements taken at the same point in the field of view may be used as a set of true Z height values throughout the calibration target reflecting the position tilt and or distortion of the calibration target.

In one embodiment isotropic targets may be omitted from the calibration target and an isotropic measurement of a different type may be provided for any set constant location in the field of view by averaging a set of anisotropic measurements made over the range of orientation angles to provide a Z height measurement average value wherein the astigmatism error component s have in effect been removed by the averaging. This type of isotropic measurement may then be used in the same manner as the type of isotropic measurement described above.

In either case since the X Y position of each isotropic measurement may be precisely known additional true Z height values may be estimated between the actual measurement locations. If bilinear interpolation is used the estimated true Z height values may reflect any global and or local tilt of the calibration target. If higher order e.g. biquadratic or other more complex interpolation schemes are used curved distortions of the calibration target may be more accurately reflected.

It will be appreciated that a reference or zero Z plane may be chosen somewhat arbitrarily provided that all other Z measurements are measured relative to this plane. Thus any one set of true Z height values determined at the same point in the field of view as outlined above may be used as reference Z height values throughout the calibration target reflecting the position tilt and or distortion of the calibration target. It may be convenient to use the center of the field of view as the point in the field of view that provides the reference Z height values for the calibration target. It should be appreciated that the reference Z height values may be treated as though they are free of both astigmatism errors and static optical errors.

In one embodiment according to this invention anisotropic error calibration data may be determined at various locations throughout the field of view. A description of one exemplary embodiment of this process begins here with an exemplary set of operations for determining a single anisotropic error calibration value for one orientation angle at one location in the field of view.

To determine a single anisotropic error calibration value first one of the anisotropic target elements described above may be positioned to fill the field of view with its anisotropic pattern at its respective orientation angle. Then the center of a focus region of interest is positioned at a desired location in the field of view this assumes the center of a region of interest is used as the reference point for its location. Then an anisotropic measurement is obtained at that location in the field of view e.g. by autofocusing using the focus region of interest. The difference between an anisotropic measurement at a respective orientation angle at that location in the field of view and a reference Z height value at that same location in the field of view may provide the anisotropic error calibration value that should be associated with that respective orientation angle at that location in the field of view.

The anisotropic error calibration steps described above may be repeated at that same location in the field of view for each respective anisotropic target at its respective orientation angle to provide a complete set of anisotropic error calibration data corresponding to that location in the field of view. The characteristics of such a set of anisotropic calibration data collected for a single location in the field of view may be better understood based on the description of below.

The entire set of anisotropic error calibration operations described above may then be repeated at a number of desired locations throughout the field of view to provide complete sets of anisotropic error calibration data corresponding to each of those desired locations. Anisotropic error calibration values or data corresponding to any of the respective orientation angles may then be estimated at other unmeasured locations in the field of view by using various interpolation techniques analogous to those indicated above or described further below. Generally the anisotropic error shape represented by the anisotropic error values corresponding to the same orientation angle but at different locations in the field of view may be more complex than the shape of the calibration target surface. Thus higher order types of interpolation may provide better accuracy. One example of respective sets of anisotropic error calibration data at respective locations in the field of view is described below with reference to .

Static optical errors may be determined if desired. In one exemplary set of operations for determining the static optical errors to be associated with a desired location in the field of view a respective isotropic target element having a respective known reference Z height value is positioned at the desired location in the field of view. Next a focus region of interest is set at that location in the field of view and a new isotropic measurement is obtained at that location in the field of view. The difference between the known reference Z height of that isotropic target element and the newly obtained isotropic measurement Z height is the static optical error to be associated with that location in the field of view. If desired this process may be repeated at that location in the field of view using additional isotropic target elements having respective known reference Z height values and the results may be averaged to provide a more refined value for the static optical error at that location in the field of view. In any case the resulting static optical error may be stored as static optical error calibration data corresponding for that location in the field of view if desired.

The static optical error calibration process described above may be repeated at respective locations throughout the field of view to provide respective static optical error calibration data corresponding to those locations throughout the field of view. Static optical error calibration values or data may then be estimated for other unmeasured locations in the field of view by using various interpolation techniques analogous to those indicated above but to interpolate the static optical errors in this case. Generally the static optical error shape may be more complex than the shape of the calibration target surface so higher order types of interpolation may provide better accuracy.

If static optical errors are determined at various locations throughout the field of view then astigmatism error calibration data may also be determined at various locations throughout the field of view if desired. Complete sets of astigmatism error calibration data corresponding to each desired location in the field of view may be determined in the manner described above for determining anisotropic error calibration data except instead of subtracting a coinciding reference Z height value from each anisotropic measurement at each location a coinciding isotropic measurement value is subtracted from each anisotropic measurement at each location. The characteristics of a set of astigmatism calibration data collected for a single location in the field of view may be better understood based on the description of below.

In various embodiments an anisotropic error value corresponding to the location and orientation angle content of a focus region of interest may be subtracted from a raw Z height measurement based on that focus region of interest to provide a corrected Z height measurement value. A corrected Z height measurement value is nominally the same as the true Z height value of the measured region of a workpiece. Alternatively it should be appreciated that subtracting both a static optical error value and an astigmatism error value corresponding to the location and orientation angle content of a focus region of interest is equivalent to subtracting an anisotropic error value corresponding to the location and orientation angle content of a focus region of interest. Thus in various embodiments according to this invention the error calibration data may be prepared and applied in different forms with the same result.

It will be appreciated that even if astigmatism error calibration data and static optical error calibration data are separated it is generally advantageous to apply both an astigmatism error correction and a static optical error correction to determine a corrected Z height measurement value. However in general using either of the corrections alone will still provide at least partially corrected Z height measurement values that are more independent of surface characteristic and or the measurement location in the field of view than raw Z height measurements. Thus using either of the corrections alone may still provide certain benefits in various applications. For example in some particularly well crafted precision machine vision inspection systems static optical errors may be insignificant and the use of astigmatism error calibration and correction operations alone may be the simplest and most advantageous alternative.

It will be appreciated that the error calibration operations outlined above with reference to are exemplary only and many variations are possible. The various values determined above are all based on various combinations of isotropic and anisotropic measurement values. Generally all of the various required isotropic and anisotropic measurement values may be obtained in any efficient or inefficient order and subsequently processed to provide the desired anisotropic error calibration values astigmatism error calibration values or static optical error calibration values etc. in any functionally equivalent manner.

Furthermore although the error calibration data described above generally comprises stored error values the error calibration data could alternatively comprise the various measurement values used to determine those error values. In one such embodiment the different types of measurement values may be stored in one or more look up tables and are later processed to correct raw Z height measurements as needed. In another embodiment the different types of measurement values or errors may be stored as analytical expressions describing different surfaces corresponding to the different types of measurements or errors. For example a reference Z height surface an isotropic measurement surface a number of anisotropic measurement surfaces corresponding to different orientation angles etc. All of the foregoing data forms may be considered a type of Z height error calibration data that characterizes a variation in Z height measurement results based on a focus region of interest in relation to a variation in the orientation angle of the anisotropic image content in the focus region of interest. In any case Z height errors may be corrected in raw measurements by the proper use of any of these forms of data. Thus each is considered to be a form of stored error calibration data. In various embodiments any isotropic or anisotropic measurement can be repeated as many times as desired and the results averaged to provide a more reliable and or repeatable value that may be used instead of a single measurement value. These and other variations will be apparent based on this disclosure.

It will be understood that the target element group B shown in includes elements similar to those of the target element group A although on a smaller scale. The target element group B is thus conveniently utilized in the same manner as previously described for the target element group A but with a lens arrangement having a higher magnification than that for which the target element group A is typically used.

Each of the anisotropic target elements in the target element groups A and B is designed to be slightly larger than the field of view of the lens at the lowest magnification for which the target is designed with the directional pattern oriented at the designated angle. The density of the lines or features within the anisotropic target elements is selected to provide good calibration in the autofocus regions of interest at all magnifications for which the target is designed. More specifically the lines or features are designed to not be too thin which can cause aliasing with the camera pixels and are also designed to have enough cycles in the autofocus region of interest to provide a strong anisotropic pattern in the autofocus region of interest. In one specific example the target element group A is intended to work well with a 100 100 pixel autofocus region of interest assuming a field of view size of 640 480 pixels at 1 and 2 turret lens assembly settings with a 2.5 objective lens. In this example the target element group B would be intended to work well with a 100 100 autofocus region of interest at a 6 turret position the target element group B is 3 times smaller than the target element group A .

It will be appreciated that the features arrangements and or aspect ratios of the target element groups A and B of are illustrative only and can differ from those shown. For example in one embodiment generally the size of each of the anisotropic target elements depends on the total lens magnification and or field of view for which the target element group is to be used. Each of the anisotropic target elements is made slightly larger than the largest intended field of view. This constraint allows the use of commercially available multipoint autofocus tools or operations to rapidly collect anisotropic measurements for a particular orientation angle over the entire field of view.

The number of anisotropic target elements can be smaller or larger depending on the selected granularity of the look up tables used for the astigmatism correction. The calibration target has a granularity of 7.5 but the granularity can be smaller or larger depending on the desired accuracy and speed of calibration. Due to the smooth nature of the astigmatism error curves it is generally sufficient in various embodiments to use granularity for collecting the data in 5 7.5 10 or 15 intervals. The number of anisotropic target elements can generally be computed as 180 granularity.

In one embodiment where the anisotropic target elements comprise periodic line patterns it is desirable to select the line pitch so that an autofocus region of interest much smaller than the field of view e.g. 100 100 pixels in 640 480 pixel field of view will contain at least 2 3 full cycles but at the same time so that the lines are not too fine e.g. not thinner than 5 pixels to prevent aliasing with the pixel pitch which could skew the calibration results. In one example embodiment the line pitch used in the target element group A is selected to provide about 3 full cycles in a 91 91 autofocus area at 5 magnification with about 7.5 pixel line width at 2.5 magnification. The scaled version of the target element group B to be used at 15 magnification provides the same number of cycles in the autofocus region of interest about 3 as given by the target element group A for the 5 magnification. The ratio of the line thickness to space thickness in line patterns can be 1 1 but the ratio may also vary.

The isotropic target elements can also contain different patterns than the concentric circles shown in . In one embodiment any pattern without dominant gradient edge direction i.e. with a uniform gradient direction histogram may be utilized. The number of isotropic patterns can be increased or decreased or they may be omitted and an average of anisotropic measurement values may be used to provide their function as previously described.

In one embodiment according to this invention a calibration target such as that shown in is not used. The following calibration procedure has the disadvantage that it is more labor intensive and requires more equipment. Nevertheless suitable error calibration data results. In this embodiment a rotary table is positioned in the machine vision inspection system field of view with its rotation axis aligned nominally parallel to the z axis of the system. A flat surface including an anisotropic pattern such as that used for one of the anisotropic target elements of the calibration target is leveled parallel to the X Y plane of the machine vision inspection system. The anisotropic pattern may have a size that fills the field of view regardless of its orientation angle. To obtain anisotropic measurements for a desired location in the field of view the rotation axis of the rotary table is positioned at that desired location. Then by rotating the rotary table in discrete steps according to a set of orientation angles such as those previously described with reference to a set of anisotropic measurements is taken at that location in the field of view. This process is repeated at each desired location in the field of view with the rotation axis positioned at each desired location. As explained previously the set of anisotropic measurements at each location in the field of view may be averaged such that the effect of the astigmatism error components is cancelled to provide in effect an isotropic measurement at that location in the field of view. These anisotropic and isotropic measurements may be used in the same manner as the anisotropic and isotropic measurements previously described with reference to the operations associated with . All of the same calibration data may be derived from such measurements.

It should be appreciated that anisotropic error calibration data which corresponds to various orientation angles of the same striped anisotropic target element at the same particular location for a focus region of interest in the field of view would look identical to the astigmatism error calibration data except the error calibration data the curve would be shifted in the vertical direction by an amount of the static optical error at that location. Such anisotropic error calibration data may be used to determine a Z height adjustment that should be applied to a Z height measurement on a workpiece in order to correct or eliminate anisotropic errors combined astigmatism and static optical errors when using a focus region of interest located at the same location in the field of view as that used to obtain the error calibration data. When the focus region of interest contents have approximately the same directional content as the striped anisotropic target element the Z height adjustment that is the anisotropic error correction value may be taken directly from the data for the orientation angle corresponding to the contents of the focus region of interest.

As shown in the nine sets of anisotropic error calibration data at the various locations within the field of view are represented by graphs . The graphs and are based on anisotropic measurements at the four corners of the field of view while the rectangular graphs and are based on anisotropic measurements at the middles of the sides of the field of view and the rectangular graph is based on anisotropic measurements at the center of the field of view. The particular anisotropic measurements reflected in were collected using a 100 100 square autofocus tool region of interest located approximately as shown. It will be understood that graphs are for illustration purposes only to symbolically represent what the anisotropic error calibration results may be at those locations within the field of view . As will be described in more detail below with respect to a rectangular portion illustrates that for additional locations within the field of view interpolation between adjacent sets of error calibration data may be utilized to estimate anisotropic error calibration values for correcting Z height measurement results for astigmatism and static optical errors at any location in the field of view.

Since in small neighborhoods the error surface may be approximately piecewise planar using bilinear interpolation of the sets of anisotropic error calibration data belonging to four closest field of view locations is in some implementations sufficient. However in some embodiments for better accuracy it is desirable to use more than nine lookup tables and biquadratic interpolation of the nine closest sets of anisotropic error calibration data.

The process of bilinear interpolation of the four points A B C and D consists of two steps. The first step is interpolating in the horizontal direction using point pairs A B and C D to obtain two horizontally interpolated points Z and Z see . The second step is interpolating in the vertical direction using the pair of interpolated points Z Z computed in the previous step to obtain the final interpolated value Z. Alternatively the process can start from interpolating in the vertical direction and then horizontally. The result does not depend on which direction of interpolation is considered first.

If auxiliary ratios r and s see are used where r m W and s n V points Z and Z can be horizontally interpolated using the basic linear proportions weighted averages 1 1 Eq. 1 2 1 Eq. 2 

And after computing Z and Z the final desired result Z value is vertically interpolated using the proportion weighted average 3 1 12 Eq. 3 

Z is therefore a result of bilinear interpolation of the four initial values A B C and D at the location within the rectangular grid specified by the ratios r and s derived from the grid pitch and the location of the point Z within the grid . It will be appreciated that this interpolation method may be used for any type of values associated with the location points A B C and D e.g. anisotropic measurements isotropic measurements reference Z height values static optical error values anisotropic error values or astigmatism error values corresponding the same angular orientation etc.

As shown in nine points A B C D E F G H and K correspond to measurement locations on a rectangular grid in the field of view. The labels of these nine points are also representing the values to be interpolated. In this particular example the values are assumed to be Z height measurement values. The label K is used instead of I only to improve readability. The horizontal pitch of the rectangular grid is W and the vertical pitch is V. It is desired to compute recover the interpolated value Z at point Z marked with the question mark in . The position of point Z is expressed in relation to point E which is treated as the origin of the temporary local coordinate system. The point Z s horizontal coordinate with respect to point E is m and its vertical coordinate with respect to the point E is n. The coordinates m n can be positive or negative depending on the relative position of point Z and the direction of the coordinate system x y axes shown in .

The process of biquadratic interpolation of the nine points A B C D E F G H and K consists of two steps. The first step is interpolating in the horizontal direction for each set of horizontally aligned points A B C D E F and G H K to obtain three horizontally interpolated points Z Z and Z see . The second step is interpolating in the vertical direction using the three interpolated points Z Z Z computed in the previous step to obtain the final interpolated value Z. Alternatively the process can start from interpolating in the vertical direction and then horizontally.

In order to interpolate points Z Z Z and Z in the parameters of parabolas passing through these points are computed which is slightly more complex than for linear interpolation. Equations for fitting a single parabola to three points are described below with respect to after which the full biquadratic interpolation equations for are presented.

Therefore the complete equation of the parabola passing through the three points shown in can be written as 

Using EQUATION 11 the Z coordinate of a point with an arbitrary x location can be estimated interpolated . It will be appreciated that this interpolation method may be used for any type of values associated with the locations points A B C D E F G H and K.

Returning to the biquadratic interpolation of by treating the points B E and H as centers of the horizontal parabolas and substituting x in EQUATION 11 with the horizontal grid pitch W the values Z Z and Zwith the corresponding horizontal point trio A B C D E F or G H K and using the horizontal coordinate m of point Z as the x variable with respect to the center locations of the horizontal parabolas 

As the final step of the biquadratic interpolation the value Z can be interpolated by fitting a vertical parabola to the three points estimated interpolated above. In this case the values Z Zand Zof EQUATION 11 are substituted with Z Z Z the x is substituted with the vertical grid pitch V and the x variable by the vertical coordinate n of point Z with respect to the center location of the vertical parabola Z . The final equation to compute Z is 

In one embodiment of an error calibration method according to this invention the calibration target of and the various anisotropic and isotropic measurement techniques and error calibration data determining techniques described with reference to and one or more of the interpolation techniques described with reference to may be used to provide error calibration data used for correcting anisotropic errors or astigmatism error components and or static optical error components included in raw Z height measurements obtained when inspecting a workpiece at a desired location in the field of view. The value used for inspection purposes is then the corrected Z height measurement obtained by correcting the anisotropic errors or astigmatism error components and or static optical error components. All the error calibration steps outlined above may be repeated for each objective lens and power turret position combination used by a machine vision inspection system since the anisotropic errors astigmatism errors and static optical errors differ between the various objective lenses and power turret positions .

A machine vision inspection system may generally be programmed to automatically perform step and repeat anisotropic and isotropic calibration target measurements and determine all required error calibration data values according to previously outlined principles for example. The automatic operations may include determining all the error calibration data values corresponding to one lens combination and or magnification and then automatically changing the magnification and repeating the error calibration operations using a different target element group of the appropriate size for that magnification.

In one embodiment histograms such as those shown in are formed by computing gradient magnitudes and directions for all pixels in an autofocus tool region of interest. The gradient magnitude is understood to be equal to the absolute value of the gradient herein. In one embodiment the computed directions are perpendicular to gradient directions in order to make them consistent with the edge direction data in a look up table such as that of . The pixels for which gradient magnitudes are smaller than a certain low noise threshold may be discarded from consideration in embodiments where it is desirable to deal only with relatively strong edges as compared to image noise or surface aberrations. If the image noise is significant the region of interest could be additionally smoothed with a spatially small averaging filter before the gradient magnitude and direction computation. The histogram H of the gradient directions is then created for all the remaining pixels. The histogram H is then normalized so that all its bins sum to 1.

It will be appreciated that in one embodiment the option of discarding the low gradient pixels and or smoothing the region of interest image before computing gradients is not critical since random noise gradient directions obtained for pixels with very weak gradients most likely due to image noise may form a uniform distribution all gradient directions equally likely and therefore affect all the histogram bins equally without changing its shape or nominal value. Nevertheless filtering out the pixels with very weak gradient magnitudes may in some implementations improve the performance of the algorithm. In one embodiment the gradient directions may be computed using a Sobel operator for example or any other known method for determining gradient directions throughout the focus region of interest.

In one embodiment for adapting an anisotropic or astigmatism error correction to a particular surface in the focus region of interest with a gradient histogram H for a focus region of interest at a location in the field of view and a look up table L similar to that represented in for example corresponding to that location in the field of view a total or adapted anisotropic or astigmatism error correction C which may be used for correcting the raw Z position determined by a conventional autofocus operation may be computed as 

where N is the number of bins in the histogram equal to the number of entries in the look up table L His the value of the a th bin in the histogram and Lis the anisotropic or astigmatism error correction value positive or negative stored at the corresponding orientation angle or value of the look up table L.

Intuitively the adapted anisotropic or astigmatism error correction is a weighted sum of anisotropic or astigmatism corrections corresponding to different edge orientation angles with weights proportional to the directional edge content of the surface within the autofocus region of interest. Therefore the directional texture characteristics of the measured surface represented as the gradient direction histogram H are used to influence the relative contributions of the anisotropic or astigmatism error corrections for different edge orientation angles. The above formula provides a method for determining reasonable anisotropic or astigmatism error correction values for all types of surfaces such as those with clearly defined directional structure e.g. an ideal stripe pattern such as that illustrated in or a textured pattern such as that illustrated as shown in as well as isotropic surfaces with no dominant gradient direction e.g. an isotropic pattern such as that illustrated in . It should be appreciated that determining an astigmatism error correction value according to this technique and adding the static optical error correction value for the same location produces an overall error correction result that is equivalent to determining the anisotropic error correction value according to this procedure for the same location.

In a further embodiment for adapting an anisotropic or astigmatism error correction to a particular surface in the focus region of interest each histogram bin value determined as previously described for example can be further adjusted based on the gradient magnitudes of pixel contributing to the bin. A gradient magnitude may generally correspond to the sharpness or strength of an edge. In one embodiment a histogram bin is incremented by 1 exponent of 0.0 applied to the absolute value of the gradient for each pixel with a gradient angle within the bin s range. In another embodiment a histogram bin is incremented by the square root of the absolute value of the gradient exponent of 0.5 applied to the absolute value of the gradient of each pixel with a gradient angle within the bin s range. In yet another embodiment a histogram bin is incremented by the absolute value of the gradient exponent of 1.0 applied to the absolute value of the gradient of each pixel with a gradient angle within the bin s range. Incrementing the bin by the absolute value of the gradient emphasizes the stronger edges which most likely have the strongest influence on the autofocus algorithm contrast computation . However due to the fact that the autofocus region of interest is a 2D structure and the gradient angle histogram is a 1D array the influence of a single pixel on a contrast type focus metric within a focus region of interest is smaller than its influence on the gradient angle histogram. This may lead to overcorrection if only a small number of high gradient pixels are present in the region of interest. Thus in some embodiments or applications it is desirable to increment the histogram bins by a fractional power of the absolute value of the gradient for the pixels in each bin. In one specific implementation an exponent of 0.5 is utilized which results in incrementing the histogram bins by the square root of the absolute values of the gradients which has been found to produce desirable results.

In the previous discussion of histogram determination a histogram is formed by computing gradient magnitudes and directions for all pixels in an autofocus tool region of interest. However in another embodiment a histogram may be formed by computing gradient magnitudes and directions for a sub sample of pixels that are distributed relatively uniformly throughout a focus region of interest.

The previously described methods of error calibration and correction are generally described as applied to Z height measurements determined based on surface focus operations. However edge focus methods or tools are also commonly available in machine vision inspection systems. Handling of anisotropic or astigmatism errors arising during edge focus operations can be done in a manner similar to that described previously the difference being to replace each instance of a surface focus operation with the edge focus operation both during calibration procedures and during workpiece inspection operations. Once the error calibration data is determined and stored the process of determining the gradient directions within the region of interest creating the histograms and computing the total adapted Z correction does not significantly slow down an autofocus operation in various embodiments. The process is not computationally intensive and the autofocus region of interest is usually only a small fraction of the entire field of view. In one example embodiment the observed slow down of autofocus in an actual implementation ranges from 1 to 3 and depends on the selected autofocus speed more slowdown for higher speed lower accuracy autofocus operations and autofocus region of interest size more slowdown for larger regions of interest .

The present invention is intended to provide a corrected Z height measurement value that is independent of workpiece surface characteristics and their orientation angle and also independent of the measurement location in the field of view. In some embodiments corrected Z height measurements may deviate from those that would correspond to the actual or theoretical best focus position. For this reason it is generally desirable to output the corrected Z height measurements values as inspection measurement results not to actually incorporate the various error corrections physically into an autofocus operation or to move the machine vision inspection system to a corrected Z height value. For example a primary purpose of an autofocus operations is frequently just to provide a sharply focused image that provides a good basis for X and Y measurements. Adjusting physical positioning or movement operations according to the various error corrections would thus be counterproductive for this purpose. In some embodiments the Z height correction of output values may be switched on and off manually or automatically. The switching of the Z correction on and off could be done automatically depending on the type of the autofocus tool run by the user. Some commercially available machine vision inspection systems include an autofocus tool with point which would use Z correction on since the returned or output measurement values are the X Y Z coordinates to be used for dimensional measurements or the like. In contrast an autofocus tool without point could use Z correction off since the primary goal of this tool may be obtaining sharp images for X and Y measurements no measurement coordinates are returned .

Any static optical errors included in the data sets shown in the do not contribute to the variations of each data set because the measurement location in the field of view is the same throughout each set. That is a static optical error if any contributes equally to each measurement. Nevertheless in other tests that analyzed static optical error components measurement variations at various locations in the field of view due to uncorrected static optical errors have been on the order of a few microns or more and have been reduced very significantly by the error calibration and correction techniques described previously.

At a block the angular content characteristics that is the orientation angle content characteristics of the surface image in the auto focus region of interest are determined or characterized and an estimated anisotropic error correction adapted to the particular surface in the autofocus region of interest is determined based on the angular content characteristics and the anisotropic error look up table estimated at the block . In one embodiment the angular content characteristics may be embodied in an angular content histogram similar to one of those previously described and the adapted anisotropic error correction is determined as previously described with reference to EQUATIONS 16 and 17. At a block the computed positive or negative correction is subtracted from the Z height measurement stored at block and the corrected Z height value may be reported as a corrected Z height measurement.

At a block the histogram determined at block is normalized so that the sum of its bin values is 1. At a block an anisotropic error correction adapted to the particular surface in the autofocus region of interest is determined by multiplying each orientation angle entry from the anisotropic error look up table determined at block of by the bin value corresponding to that orientation angle in the normalized histogram determined at block and summing the resulting products.

While the preferred embodiment of the invention has been illustrated and described numerous variations in the illustrated and described arrangements of features and sequences of operations will be apparent to one skilled in the art based on this disclosure. Various aspects of the invention may be used separately or in combinations and sequences other than those explicitly disclosed. Thus it will be appreciated that various changes can be made therein without departing from the spirit and scope of the invention.

