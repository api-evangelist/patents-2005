---

title: Router and method for protocol process migration
abstract: A router and a method for migrating routing protocol processes or Virtual Routers (VRs) from one Route Processor (RP) to another using graceful restart procedures for maintaining packet flow to the router and assisting the router to obtain restart information. The router includes first and second RPs and a forwarding engine for forwarding packets to neighbor routers in the network. When the routing protocol process is terminated on the first RP, the neighbor routers detect a router failure and initiate the graceful restart procedures. A filter rule in the forwarding engine causes it to forward packets to the new routing protocol process on the second RP. The new process learns the network topology from the neighbor routers, and the migration is completed without packet loss and without requiring complex changes to the network protocol stack.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07583590&OS=07583590&RS=07583590
owner: Telefonaktiebolaget L M Ericsson (Publ)
number: 07583590
owner_city: Stockholm
owner_country: SE
publication_date: 20050715
---
The present invention relates to communication systems. More particularly and not by way of limitation the present invention is directed to a router and a method in an Internet Protocol IP based network for migrating protocol processes from one route processor to another route processor using a graceful restart procedure.

In state of the art IP routers different processors are implemented to handle control functions and packet forwarding functions. When routing and signaling protocols running on the control processor fail forwarding of payload traffic is interrupted even though all the information required to perform such forwarding is available to the packet forwarding processor. This interruption occurs because neighbor routers detect the failure of the routing and signaling protocols and assume that the entire router has failed. Consequently the neighbor routers compute alternate paths bypassing the failed router. During this time called routing convergence time there is a potential for traffic loss.

To address this problem the Internet Engineering Task Force IETF has standardized a set of extensions to the routing and signaling protocols to gracefully handle the restart of a failed protocol process on a neighbor router. When these extensions are implemented and a router s control software must be restarted the router s neighbors continue to use it for forwarding traffic. Neighbors also help the restarted router software relearn the state that was known prior to the failure.

It is also known for IP network operators to build manage and provision virtual private networks VPNs on top of their existing infrastructure. These networks are typically used by enterprises that need interconnectivity between geographically distributed sites. Using a private network is also appealing because it offers a level of protection from intruders. Telecom network operators also use VPNs to provide traffic separation between various classes of telecom traffic. This is useful for providing different quality of service QoS and security services to these traffic classes.

With the growth in the size and speed of IP networks routers or packet processing nodes must be scalable. Otherwise as the demands for processing power increase or as more customer VPNs are configured more and more routers must be deployed with added operational complexity and expenditure. To handle the resiliency and scalability needs of IP and telecom networks routers or packet processing nodes are increasingly designed using a cluster of processors. To address scalability needs middleware known as cluster management software distributes the processing load across multiple processors. The increase in processing demands is addressed by adding more processors to the cluster and migrating processes to the new processors. Any state needed by the process is also migrated to its new location by the cluster management software. Although effective the use of processor clusters increases the complexity and cost of implementation of the routers.

An alternative that offers resiliency against node failures is to maintain one or more control processors usually known as Route Processors or RPs in hot standby state to backup a primary RP. The protocol state is replicated between the primary and backup RPs. If the primary RP fails the backup RP takes over and masks the failure from the router s neighbors. The complexity in this approach is in synchronizing state information between the primary and backup RPs. For protocols like Border Gateway Protocol BGP and Label Distribution Protocol LDP that run over the Transmission Control Protocol TCP TCP session state such as sequence numbers congestion window parameters and the like must also be replicated.

Thus what is needed in the art is a more efficient way to handle the resiliency and scalability needs of IP and telecom networks that overcomes the deficiencies of conventional systems and methods. The present invention provides such a router and method.

The present invention provides a router and a method of migrating routing protocol processes from one Route Processor RP to another using graceful restart procedures. The RPs may be in the same router or different routers. A similar mechanism is utilized to migrate a Virtual Router VR and all its associated processes from one RP to another.

Thus in one aspect the present invention is directed to a method in a router in an Internet Protocol IP based network for migrating routing protocol processes from a first route processor to a second route processor. The router includes a forwarding engine for forwarding packets to neighbor routers in the network and the neighbor routers include a graceful restart procedure for maintaining packet flow to the router and assisting the router if the router fails. The method includes terminating the routing protocol processes on the first route processor thereby indicating to the neighbor routers that the router has failed and causing the neighbor routers to start the graceful restart procedure and restarting the routing protocol processes on the second route processor. The method also includes diverting by the forwarding engine packets destined for the routing protocol processes on the first route processor to the restarted routing protocol processes on the second route processor and receiving by the restarted routing protocol processes on the second route processor information from the neighbor routers regarding the network s topology. In this aspect the routing protocol processes may be for example Border Gateway Protocol BGP processes.

In another aspect the method may include terminating the routing protocol processes on the first route processor and adding a filter rule to the forwarding engine after terminating the routing protocol processes on the first route processor. The filter rule causes the forwarding engine to divert packets destined for the routing protocol processes on the first route processor to the restarted routing protocol processes on the second route processor. The method also includes restarting the routing protocol processes on the second route processor sending a message to each of the neighbor routers requesting the neighbor routers to start the graceful restart procedure and receiving by the restarted routing protocol processes on the second route processor information from the neighbor routers regarding the network s topology. In this aspect the routing protocol processes may be for example Open Shortest Path First OSPF processes or Intermediate System to Intermediate System Protocol IS IS processes.

In yet another aspect when the routing protocol processes do not have a defined graceful restart procedure said method may include terminating the routing protocol processes on the first route processor adding the filter rule to the forwarding engine restarting the routing protocol processes on the second route processor and receiving periodic refresh messages from each of the neighbor routers regarding a protocol state. The refresh messages include information on all routes within the network s routing domain. The router then sends a message to each of the neighbor routers advertising that the router is operational. In this aspect the routing protocol processes may be for example Routing Information Protocol RIP .

In yet another aspect the present invention is directed to a method in a router in an IP based network for migrating a Virtual Router VR from a first route processor to a second route processor. The router includes a forwarding engine for forwarding packets to neighbor routers in the network the VR includes routing and signaling protocol processes and a Route Table Manager RTM that computes a forwarding information base utilized by the forwarding engine and the neighbor routers include a graceful restart procedure for maintaining packet flow to the router and assisting the router if the router fails. The method includes terminating the VR s routing and signaling protocol processes on the first route processor thereby indicating to the neighbor routers that the router has failed and causing the neighbor routers to start the graceful restart procedure restarting the VR s routing and signaling protocol processes on the second route processor and diverting by the forwarding engine packets destined for the VR s routing and signaling protocol processes on the first route processor to the VR s restarted routing and signaling protocol processes on the second route processor. The method also includes receiving by the VR s restarted routing and signaling protocol processes on the second route processor information from the neighbor routers regarding the network s topology restarting the VR s RTM on the second route processor and receiving by the VR s restarted RTM information from the VR s restarted routing and signaling protocol processes regarding the network s topology thereby establishing a routing state. The method also includes receiving by the VR s restarted RTM information from the forwarding engine regarding the current forwarding information base thereby establishing a forwarding information state and synchronizing by the RTM the forwarding information state and the routing state.

In yet another aspect the present invention is directed to a router in an IP based network in which neighbor routers include a graceful restart procedure for maintaining packet flow to the router and assisting the router if the router fails. The router includes a forwarding engine for forwarding packets to the neighbor routers in the network a first route processor connected to the forwarding engine for running routing protocol processes a second route processor connected to the forwarding engine for running routing protocol processes and means for migrating a routing protocol process from the first route processor to the second route processor said migrating means including means for preventing packet loss while migrating the routing protocol process without requiring changes to the network protocol stack.

The present invention provides a router and a method for migrating routing protocol processes from one Route Processor RP to another using graceful restart procedures. The RPs may be in the same router or different routers. A similar mechanism is utilized to migrate a Virtual Router VR and all its associated processes from one RP to another. Routing protocols such as the Border Gateway Protocol BGP Open Shortest Path First OSPF Intermediate System to Intermediate System Protocol IS IS and Routing Information Protocol RIP communicate with a Route Table Manager RTM using an Application Programming Interface API that hides the communication between these processes. In such a communication method it is unknown to each process exactly where the other end of the communication channel is located. This provides flexibility by allowing routing protocols to reside on a first RP while the RTM resides on a different RP or conversely the routing protocols and RTM may all reside on the same RP.

In the embodiment described herein the routing protocols and RTM processes run on one or more of the RP boards . If only one RP board is present all the processes run on the single RP. If two or more RPs are present the routing protocols and RTM may run on separate available RPs. Interprocess Communications IPCs between the routing protocols and the RTMs ensure that all the processes can talk to each other irrespective of the RP board on which they are running. Similarly one or more VRs may be instantiated on multiple RP boards depending on the processing requirements of the VR s processes.

BGP is a path vector based routing protocol that is primarily used to set up routing connections across routing domains. It is a very popular and important protocol used in routers. BGP works by setting up a TCP socket connection between two neighbor routers. The entire BGP connection is dependent on the continued existence of the TCP connection. Failure of the TCP connection in any way results in the loss of the BGP session and a further loss of forwarding capabilities which leads to severe damage of the network functionality.

The Graceful Restart procedure for BGP requires that a loss of the TCP connection be a signal to the receiving router that the neighbor router has failed. The procedure requires the receiving router to continue to use the failed router for forwarding until told otherwise by the restarting router. This procedure ensures that if only the BGP process on a router dies then traffic will continue to be forwarded while the BGP process restarts itself thus ensuring that the network traffic is not lost.

Migration of BGP processes requires that the TCP connection continue to be maintained during the time that the process moves from one RP to another. This is a very complex problem that is still being researched and there are very few successful implementations of this technique. Existing techniques require that the entire TCP IP network stack of the router be revamped to deal with a TCP connection migration.

Thus the invention s use of Graceful Restart for BGP process migration completely removes the need to do any complex manipulation of the TCP IP network stack. The invention may additionally be utilized on any stock off the shelf network stack. The invention therefore drastically reduces the complexity of implementing process migration for BGP processes. This reduces developer costs for the vendor and purchasing costs for the customer.

Protocols such as OSPF IS IS and RIP do not run over TCP and hence there is no session state maintained inside the operating system running over the RP. However the protocol processes do maintain protocol state and this state needs to be relearned once the protocol process is restarted on the new RP. The OSPF and IS IS protocols have graceful restart mechanisms defined but RIP does not.

Thus when the protocol process is ready to migrate to RP it is terminated on RP at step . At step a filter rule is added to the forwarding engines to detect the protocol packets destined for the old RIP process and to divert the packets to the new RIP process on RP . At step the RIP process is then restarted on RP . At step the new RIP process receives periodic refreshes of all the routes across the routing domain. At step the new RIP process sends advertisements to neighbor routers after the RIP process has relearned its protocol state.

Thus when the VR is ready to migrate to RP its routing and signaling protocol processes are terminated on RP at step . At step assuming the routing and signaling protocol processes have graceful restart mechanisms defined Router A s neighbor routers detect the failure of Router A and enter the Graceful Restart state at step . At step a filter rule is added to the forwarding engines to detect TCP packets destined for the VR s terminated routing and signaling protocol processes and to divert the packets to new routing and signaling protocol processes on RP . At step the RTM is restarted on RP . At step the routing and signaling protocol processes restart on RP and set up peering relationships with neighbor routers. At step the new routing and signaling protocol processes learn the network topology with the help of the neighbor routers. At step the RTM learns the routing state from the routing and signaling protocol processes and at step the RTM learns the current forwarding information base from the forwarding engines and synchronizes the forwarding information state with the routing state.

As will be recognized by those skilled in the art the innovative concepts described in the present application can be modified and varied over a wide range of applications. Accordingly the scope of patented subject matter should not be limited to any of the specific exemplary teachings discussed above but is instead defined by the following claims.

