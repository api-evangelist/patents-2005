---

title: Method system and program storage device for optimization of valve settings in instrumented wells using adjoint gradient technology and reservoir simulation
abstract: A new adjoint method for calculating and using adjoint gradients in a Reservoir Simulator comprises: calculating adjoint gradients of an objective function with respect to changes in valve settings taking into account the modeling of pressure drop and fluid flow along a wellbore, and using the adjoint gradients to calculate sensitivities of a reservoir to changes in parameterization of downhole devices and using of these sensitivities in optimal control of the wells to optimize some objective function subject to production constraints.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07640149&OS=07640149&RS=07640149
owner: Schlumberger Technology Corporation
number: 07640149
owner_city: Sugar Land
owner_country: US
publication_date: 20051205
---
This specification is a Utility Application of Provisional Application Ser. No. 60 636 202 filed Dec. 15 2004 and entitled Method Apparatus and System for Optimization of Valve Settings in Instrumented Wells Using Adjoint Gradient Technology and Reservoir Simulation .

The subject matter of this specification relates to a new Adjoint Method and associated System and Program Storage Device for Calculating Gradients and in particular to an Adjoint Method for Calculating Gradients of an objective function with respect to changes in valve settings while taking into account the modeling of pressure drop and fluid flow along a wellbore for more effectively and efficiently optimizing settings of control valves for reservoir production.

Controllable down hole devices have made feasible the implementation of advanced well control strategies for achieving an objective such as maximizing hydrocarbon recovery or net present value. However the development of algorithms for determining the best strategy for controlling these devices subject to production and injection constraints is still an area of active research and generally involves implementation of some form of control logic within a reservoir simulation workflow.

Some control strategies for controlling these devices are reactive meaning that interventions are made when local conditions are met at particular wells or valves without taking into account the future effect of the intervention on the entire reservoir. Moreover with this approach it may already be too late to intervene to prevent unwanted breakthrough. These production rule methods tend to be heuristic but are very efficient in reservoir simulation. Alternative proactive control strategies apply to the lifetime of the field and thus provide a mechanism to control fluid flow early enough to delay breakthrough. These alternative proactive control strategies for controlling these devices can be divided into at least two methods 1 stochastic methods such as Monte Carlo which investigate the effect of a large number of possible strategies and 2 deterministic methods which set the behavior of each well and valve based on its effect on the objective. This specification includes a proactive deterministic constrained optimization method associated with the aforementioned alternative proactive control strategies adapted for controlling the aforementioned controllable downhole devices . In particular this specification includes a first application of adjoint gradients to control and optimize settings in a multi segmented well model.

One aspect of the Adjoint Method of Calculating Gradients as described in this specification involves a method for calculating and using adjoint gradients in a reservoir simulator comprising calculating adjoint gradients of an objective function with respect to changes in valve settings while taking into account a modeling of pressure drop and fluid flow along a wellbore in response to the calculated adjoint gradients calculating sensitivities of a reservoir responsive to changes in parameterization of downhole devices and in response to the calculated sensitivities using said sensitivities to optimize control of wells in a reservoir by optimizing an objective function.

Another aspect of the Adjoint Method of Calculating Gradients as described in this specification involves a method for optimizing production of a reservoir having one or more wells having valves comprising a running a reservoir simulator in a forward simulation to simulate the life of the reservoir b processing outputs from the forward simulation to generate intermediate partial derivatives of flow equations for the well and for the reservoir c combining the intermediate partial derivatives of the well flow equations and the reservoir flow equations in the reservoir simulator d solving a large adjoint system of linear equations at regular time intervals to calculate the adjoint gradients of an objective function with respect to the control parameters e determining from the adjoint gradients a search direction f using the search direction to solve an optimization algorithm that maximizes the objective function using line search methods g locating a local maximum along the search direction and updating control parameters h using the new updated control parameters in the reservoir simulator and i repeating steps a i until an optimal value of the objective function has been reached.

Another aspect of the Adjoint Method of Calculating Gradients as described in this specification involves a program storage device readable by a machine tangibly embodying a set of instructions executable by the machine to perform method steps for calculating and using adjoint gradients in a reservoir simulator said method steps comprising calculating adjoint gradients of an objective function with respect to changes in valve settings while taking into account a modeling of pressure drop and fluid flow along a wellbore in response to the calculated adjoint gradients calculating sensitivities of a reservoir responsive to changes in parameterization of downhole devices and in response to the calculated sensitivities using said sensitivities to optimize control of wells in a reservoir by optimizing an objective function.

Another aspect of the Adjoint Method of Calculating Gradients as described in this specification involves a program storage device readable by a machine tangibly embodying a set of instructions executable by the machine to perform method steps for optimizing production of a reservoir having one or more wells having valves said method steps comprising a running a reservoir simulator in a forward simulation to simulate the life of the reservoir b processing outputs from the forward simulation to generate intermediate partial derivatives of flow equations for the well and for the reservoir c combining the intermediate partial derivatives of the well flow equations and the reservoir flow equations in the reservoir simulator d solving a large adjoint system of linear equations at regular time intervals to calculate the adjoint gradients of an objective function with respect to the control parameters e determining from the adjoint gradients a search direction f using the search direction to solve an optimization algorithm that maximizes the objective function using line search methods g locating a local maximum along the search direction and updating control parameters h using the new updated control parameters in the reservoir simulator and i repeating steps a i until an optimal value of the objective function has been reached.

Another aspect of the Adjoint Method of Calculating Gradients as described in this specification involves a system adapted for calculating and using adjoint gradients in a reservoir simulator comprising first apparatus adapted for calculating adjoint gradients of an objective function with respect to changes in valve settings while taking into account a modeling of pressure drop and fluid flow along a wellbore second apparatus responsive to the calculated adjoint gradients adapted for calculating sensitivities of a reservoir responsive to changes in parameterization of downhole devices and third apparatus responsive to the calculated sensitivities adapted for using the sensitivities to optimize control of wells in a reservoir by optimizing an objective function.

Another aspect of the Adjoint Method of Calculating Gradients as described in this specification involves a system adapted for optimizing production of a reservoir having one or more wells having valves comprising apparatus adapted for running a reservoir simulator in a forward simulation to simulate the life of the reservoir processing outputs from the forward simulation to generate intermediate partial derivatives of flow equations for the well and for the reservoir combining the intermediate partial derivatives of the well flow equations and the reservoir flow equations in the reservoir simulator solving an adjoint system of linear equations at regular time intervals to calculate a set of adjoint gradients of an objective function with respect to the control parameters determining from the adjoint gradients a search direction using the search direction to solve an optimization algorithm that maximizes the objective function using line search methods locating a local maximum along the search direction and updating control parameters further using the new updated control parameters in the reservoir simulator and repeating the processing combining solving determining using locating and further using functions performed by the apparatus until an optimal value of the objective function has been reached.

Further scope of applicability will become apparent from the detailed description presented hereinafter. It should be understood however that the detailed description and the specific examples set forth below are given by way of illustration only since various changes and modifications within the spirit and scope of the Adjoint Method of Calculating Gradients as described and claimed in this specification will become obvious to one skilled in the art from a reading of the following detailed description.

Oil and gas is produced from underground rock formations. These rocks are porous just like a sponge and they are filled with fluid usually water. This porous characteristic of rocks is known as porosity. These rocks in addition to being porous have the ability to allow fluids to flow through the pores a characteristic measured by a property called permeability. When oil or gas is trapped in such formations it may be possible to extract it by drilling wells that tap into the formation. As long as the pressure in the well is lower than that in the rock formation the fluids contained in the pores will flow into the well. These fluids may then flow naturally up the well to the surface or the flow up the well may have to be assisted by pumps. The relative amounts of oil gas and water that are produced at the surface will depend on the fraction of the rock pore space that is occupied by each type of fluid. Water is always present in the pores but it will not flow unless its volume fraction exceeds a threshold value that varies from one type of rock to another. Similarly oil and gas will only flow as long as their volume fractions exceed their own thresholds.

The characteristics of the rock including porosity and permeability in an oil reservoir vary greatly from one location to another. As a result the relative amounts of oil gas and water that can be produced will also vary from reservoir to reservoir. These variations make it difficult to simply predict the amount of fluids and gases a reservoir will produce and the amount of resources it will require to produce from a particular reservoir. However the parties interested in producing from a reservoir need to project the production of the reservoir with some accuracy in order to determine the feasibility of producing from that reservoir. Therefore in order to accurately forecast production rates from all of the wells in a reservoir it is necessary to build a detailed mathematical model of the reservoir s geology and geometry.

A large amount of research has been focused on the development of reservoir simulation tools. These tools include mathematical and computer models that describe and which are used to predict the multiphase flow of oil and gas within a three dimensional underground formation a field . Reservoir tools use empirically acquired data to describe a field. These data are combined with and manipulated by mathematical models whose output describes specified characteristics of the field at a future time and in terms of measurable quantities such as the production or injection rates of individual wells and groups of wells the bottom hole or tubing head pressure at each well and the distribution of pressure and fluid phases within the reservoir.

The mathematical model of a reservoir is typically done by dividing the reservoir volume into a large number of interconnected cells and estimating the average permeability porosity and other rock properties for each cell. This process makes use of seismic data well logs and rock cores recovered when wells are drilled. Production from the reservoir can then be mathematically modeled by numerically solving a system of three or more nonlinear partial differential equations describing fluid flow in the reservoir.

Computer analysis of production from an oil reservoir is usually divided into two phases history matching and prediction. In the history matching phase the past production behavior of the reservoir and its wells is repeatedly modeled beginning with initial production and continuing up to the present time. The first computer run is based on a geological model as described above. After each run the computer results are compared in detail with data gathered in the oil field during the entire period of production. Geoscientists modify the geological model of the reservoir on the basis of the differences between computed and actual production performance and rerun the computer model. This process continues until the mathematical reservoir model behaves like the real oil reservoir.

Once a suitable history match has been obtained production from the oil reservoir can be predicted far into the future sometimes for as long as 50 years . Oil recovery can be maximized and production costs minimized by comparing many alternative operating plans each requiring a new run of the computer model. After a field development plan is put into action the reservoir model may be periodically rerun and further tuned to improve its ability to match newly gathered production data.

When sufficient data is obtained about the reservoir characteristics of a reservoir can be mathematically modeled to predict production rates from wells in that reservoir. The gross characteristics of the field include the porosity and permeability of the reservoir rocks the thickness of the geological zones the location and characteristics of geological faults relative permeability and capillary pressure functions and such characteristics of the reservoir fluids as density viscosity and phase equilibrium relationships. From this data a set of continuous partial differential equations PDEs are generated that describe the behavior of the field as a function of time and production parameters. These production parameters include the locations of wells the characteristics of the well s completions and the operating constraints applied to the wells. Operating constraints may include such as the production rate of a particular fluid phase the bottom hole pressure the tubing head pressure or the combined flow rates of a group of wells. These constraints may be applied directly by data or by means of another simulator that models the flow of fluids in the surface equipment used to transport the fluids produced from or injected into the wells. However because only the simplest system of PDEs can be solved using classic or closed form techniques e.g. a homogeneous field having circular boundaries a model s PDEs are converted into a set of non linear approximations which are then solved numerically. One approximation technique is the finite difference method. In the finite difference method reservoir PDEs are converted into a series of difference quotients which divide a reservoir into a collection of discrete three dimensional cells which are then solved for at discrete times to determine or predict the value of reservoir characteristics such as pressure permeability fluid fractions and at a later time.

Within the computerized reservoir simulator reservoir performance is modeled in discrete increments of time. Each so called timestep advances the solution from a previous point in time where all variables are known to a future point in time where all variables are unknown. This process is repeated until the entire time period of interest has been modeled. Within each timestep it is necessary to solve a huge system of nonlinear equations that models fluid flow from cell to cell and through the wells. With current technology it is possible to include several million cells in the reservoir model. Solutions to the system of nonlinear equations are obtained by Newton iteration. In each such iteration the system of nonlinear equations is approximated by a system of linear equations which must be solved by yet another iterative procedure. One such reservoir simulator is the Eclipse reservoir simulator that is owned and operated by Schlumberger Technology Corporation of Houston Tex.

The Eclipse simulator software receives output data from the Flogrid simulation gridding software and responsive thereto the Eclipse simulator software generates a set of simulation results which are displayed on a 3D viewer. The Flogrid simulation gridding software is described in U.S. Pat. No. 6 106 561 to Farmer the disclosure of which is incorporated by reference into this specification.

As illustrated in the Eclipse simulator software includes an Adjoint Method including its associated system and program storage device for calculating adjoint gradients of an objective function with respect to changes in valve settings taking into account the modeling of pressure drop and fluid flow along a wellbore and using the adjoint gradients to calculate sensitivities of a reservoir to changes in parameterization of downhole devices and the use of these sensitivities in optimal control of the wells to optimize some objection function subject to production constraints hereinafter called an Adjoint method for calculating and using adjoint gradients .

This specification includes 1 a Background discussion with reference to which provides background information relating to the performance of a seismic operation and a well logging operation adapted for generating seismic and well logging data the seismic and well logging data being provided as input data to a workstation that stores a Flogrid simulation gridding software and an Eclipse simulator software and 2 a description of the Eclipse simulator software further including the Adjoint method for calculating and using adjoint gradients and associated system and program storage device discussed below with reference to representing one possible implementation of the Adjoint method for calculating and using adjoint gradients .

Referring to a method and apparatus for performing a seismic operation is illustrated. During a seismic operation a source of acoustic energy or sound vibrations such as an explosive energy source produces a plurality of sound vibrations. In one such sound vibration reflects off a plurality of horizons in an earth formation . The sound vibration s is are received in a plurality of geophone receivers situated on the earth s surface and the geophones produce electrical output signals referred to as data received in in response to the received sound vibration s representative of different parameters such as amplitude and or frequency of the sound vibration s . The data received is provided as input data to a computer of a recording truck and responsive to the input data the recording truck computer generates a seismic data output record . Later in the processing of the seismic data output record such seismic data undergoes data reduction in a mainframe computer and a reduced seismic data output record is generated from that data reduction operation .

Referring to a well logging operation is illustrated. During the well logging operation a well logging tool is lowered into the earth formation of which is penetrated by a borehole . In response to the well logging operation well log data is generated from the well logging tool the well log data being provided as input data to a computer of a well logging truck . Responsive to the well log data the well logging truck computer produces a well log output record .

Referring to the seismic data output record of is provided as input data to a mainframe computer where the data reduction operation of is performed. A mainframe processor will execute a data reduction software stored in a mainframe storage . When the execution of the data reduction software is complete the reduced seismic data output record of is generated.

Referring to a workstation is illustrated in . A storage medium such as a CD Rom stores software and that software can be loaded into the workstation for storage in the memory of the workstation. In the workstation includes a workstation memory the software stored on the storage medium CD Rom being loaded into the workstation and stored in the workstation memory . A workstation processor will execute the software stored in the workstation memory in response to certain input data provided to the workstation processor and then the processor will display or record the results of that processing on the workstation recorder or display or 3D viewer . The input data that is provided to the workstation in includes the well log output record and the reduced seismic data output record . The well log output record represents the well log data generated during the well logging operation in an earth formation of and the reduced seismic data output record represents data reduced seismic data generated by the mainframe computer in in response to the seismic operation illustrated in . In the software stored on the storage medium CD Rom in includes a Flogrid software and an Eclipse simulator software . When the storage medium CD Rom is inserted into the workstation of the Flogrid software and the Eclipse simulator software stored on the CD Rom are both loaded into the workstation and stored in the workstation memory . The Flogrid software and the Eclipse simulator software are owned and operated by Schlumberger Technology Corporation of Houston Tex. The Flogrid software is disclosed in U.S. Pat. No. 6 106 561 to Farmer entitled Simulation Gridding Method and Apparatus including a Structured Areal Gridder Adapted for use by a Reservoir Simulator the disclosure of which is incorporated by reference into this specification. When the workstation processor executes the Flogrid software and the Eclipse simulator software the Eclipse simulator software responds to a set of more accurate grid cell property information associated with a respective set of grid blocks of a structured simulation grid generated by the Flogrid software by further generating a set of more accurate simulation results which are associated respectively with the set of grid blocks of the simulation grid. Those simulation results are displayed on the 3D viewer of and can be recorded on a recorder

Referring to referring initially to the Flogrid software and the Eclipse simulator software are illustrated as being stored in the workstation memory of . In addition the simulation results which are output from the Eclipse simulator software are illustrated as being received by and displayed on the 3D viewer . The Flogrid software includes a reservoir data store a reservoir framework a structured gridder an unstructured gridder and an upscaler all of which are fully discussed in the above referenced U.S. Pat. No. 6 106 561 to Farmer the disclosure of which has already been incorporated by reference into this specification. In a set of simulation grids and properties associated with the grids generated by the Upscaler and the Petragrid unstructured gridder are received by the Eclipse simulator software . In response the Eclipse simulator software generates a set of simulation results associated respectively with a set of grid blocks of the simulation grids and the simulation results and the associated grid blocks are displayed on the 3D viewer . The Petragrid unstructured gridder is disclosed in U.S. Pat. Nos. 6 018 497 and 6 078 869 the disclosures of which are incorporated by reference into this specification.

In the Flogrid software generates a set of output data comprising a plurality of grid cells and certain properties associated with those grid cells. That output data is provided as input data to the Eclipse simulator software . Some other programs provide other input data to the Eclipse simulator software . In response to the output data comprised of a gridded earth formation including a plurality of grid cells and certain properties associated with each of the grid cells as well as the other output data from the other programs the Eclipse simulator software generates a set of simulation results the simulation results including the plurality of grid cells and a plurality of simulation results associated respectively with the plurality of grid cells. The aforementioned plurality of grid cells and the plurality of simulation results associated respectively with the plurality of grid cells are displayed on the 3D Viewer of .

Referring to an example of the simulation results i.e. the plurality of grid cells and the plurality of simulation results associated respectively with the plurality of grid cells which are displayed on the 3D viewer of and is illustrated in .

The following paragraphs will present the Eclipse Simulator Software of and where the Eclipse Simulator Software further includes a Detailed Description of an Adjoint method for calculating and using adjoint gradients and associated System and Program Storage Device as shown in . In particular the following paragraphs will present a Detailed Description of an Adjoint Method including its associated system and program storage device for calculating adjoint gradients of an objective function with respect to changes in valve settings taking into account the modeling of pressure drop and fluid flow along a wellbore and using the adjoint gradients to calculate sensitivities of a reservoir to changes in parameterization of downhole devices and the use of these sensitivities in optimal control of the wells to optimize some objection function subject to production constraints as shown in .

Referring to a general outline of the operation of a prior art reservoir simulator is discussed below with reference to . In reservoir data and of and rock core data are used to describe a computational grid and the properties of the reservoir rocks. This data is combined with data relating to the physical properties of the fluids contained in the reservoir the combined data being used to compute the initial distributions of pressure and fluid saturations volume fractions as well as the composition of each fluid phase block in . Time varying data such as the locations and characteristics of wells production and injection flow rate controls and simulator control information is read from a data base block . Using the current pressure saturation and fluid compositions for each grid cell the partial differential equations describing mass balances are approximated by finite differences in block which results in two or more nonlinear algebraic equations for each grid cell. Also in block these nonlinear equations are linearized by means of Newton s method. In block the resulting system of linear equations is solved iteratively using methods described in this specification. After the linear equations have been solved there is a test in block to determine whether all of the nonlinear terms in the finite difference equations have converged. If not the simulator returns to block . If the nonlinear terms in the finite difference equations have converged the simulator moves to block and updates values to complete the current timestep. In block the simulator tests to determine whether the desired ending time i.e. the stop time in the simulation has been reached. If not the simulator advances time to the next level block and then it returns to block to read new time varying data and to begin the next timestep. If the endpoint of the simulation has been reached then the simulator completes output operations and the run is finished block .

In the Eclipse simulator software of and includes software which functions to perform or practice an Adjoint Method for Calculating and Using Adjoint Gradients step in .

In however the Adjoint Method including its associated system and program storage device for Calculating and Using Adjoint Gradients step in includes two basic steps steps and which are discussed below with reference to as follows 

 Step 1 Calculating adjoint gradients of an objective function with respect to changes in valve settings taking into account the modeling of pressure drop and fluid flow along a wellbore step in and

 Step 2 Using the adjoint gradients to calculate sensitivities of a reservoir to changes in parameterization of downhole devices and the use of these sensitivities in optimal control of the wells to optimize some objective function subject to production constraints step in .

Each of the above referenced two steps and illustrated in associated with the Adjoint Method for Calculating and Using Adjoint Gradients step in will be discussed in detail below with reference to of the drawings.

In the Adjoint Method and associated system and program storage device for Calculating and for Using Adjoint Gradients illustrated in effectively and efficiently optimizes settings of control valves in a reservoir and as a result optimizes the production of oil gas and other hydrocarbons from the reservoir. The Adjoint method and associated system and program storage device for calculating and using adjoint gradients shown in represents a proactive deterministic constrained optimization method . Gradients are required for this proactive deterministic constrained optimization method . The term gradients means the sensitivity or response of the reservoir to a change in a control parameter and represents quantitative information on how an objective will respond to any changes made in the well operating targets and valve settings . Given that control of the behavior of a large number of wells in a reservoir at a reasonably high frequency may be desired the gradients are required for a large number of control parameters on the order of 10to 10 . Hence the adjoint method for calculating and using adjoint gradients shown in must generate and provide these gradients efficiently and accurately. For this reason the aforesaid adjoint method for calculating and using adjoint gradients of represents a function that is practiced by in a reservoir simulator such as the Eclipse reservoir simulator that is owned and operated by Schlumberger Technology Corporation.

Another adjoint method has previously been applied to optimization within reservoir simulation by several authors . However the studies produced by the aforesaid several authors include smart wells as a series of independent injectors or producers and as such do not take into account the accurate modelling of the pressure drop along the wellbore. In addition the several authors have published the use of the adjoint method to calculate gradients in reservoir simulation such as 1 Fifth European Conference on Mathematics of Oil Recovery Zakirov Zakirov Aanonsen Palatnik 2 SPE 78278 Brouwer Jansen and 3 SPE 92864 Sarma Aziz Durlofsky .

In addition the use of a multi segmented well model in reservoir simulation to accurately model flow in a wellbore is disclosed in prior pending U.S. application Ser. No. 10 900 176 to David A. Edwards et al entitled Near Wellbore Modeling method and apparatus published as US patent application number 20050015231 published Jan. 20 2005.

However the adjoint method for calculating and using adjoint gradients disclosed in of this specification may include use of a fully coupled multi segmented well model that accurately calculates the pressure drop and component flow rates along the length of a multi lateral well. In addition the adjoint method for calculating and using adjoint gradients of addresses the problem of how to control downhole devices to achieve an objective where the objective includes maximizing hydrocarbon recovery or the net present value of the reservoir. The aforesaid problem of how to control downhole devices involves the control of fluid fronts in a reservoir in order to prolong hydrocarbon production from the reservoir field as a whole while minimizing the production of unwanted fluids. In addition control parameters associated with the aforesaid problem of how to control downhole devices include 1 well production and injection rates and pressures and 2 the settings of down hole inflow control devices.

The accurate modeling of the physics of fluid flow within smart wells is of paramount importance when developing control strategies for this type of well. The control of downhole devices is modeled by using a reservoir simulator adapted for accurately modeling the physics of fluid flow in smart wells such as the previously referenced Eclipse reservoir simulator owned and operated by Schlumberger Technology Corporation. As a result a gradient based field optimization method is disclosed in this specification the aforementioned gradient based field optimization method being known as the Adjoint method for calculating and using adjoint gradients illustrated in . The aforesaid gradients are calculated using the Adjoint method for calculating and using adjoint gradients of . The Adjoint method for calculating and using adjoint gradients of is used because it provides a very efficient method of calculating gradients of the objective function for a large numbers of parameters. This is of great significance in reservoir simulation where there may be a large number of controllable wells in the reservoir and a large number of valves in the wells that may be changed at regular intervals over the lifetime of the reservoir. The Adjoint method for calculating and using adjoint gradients of accurately calculates the gradients of an objective function with respect to changes in valve settings taking into account the accurate modeling of pressure drop and fluid flow along the well bore. These gradients are then used to calculate the sensitivities of a reservoir to changes in parameterization of downhole device. These sensitivities are then used in an optimal control of the wells in the reservoir in order to optimize some objective function subject to production constraints. The optimal control of the wells in the reservoir includes the generation of new optimized control settings for wells and or the generation of new optimized control settings for a set of downhole well valves that are disposed within those wells.

Consequently the Adjoint method for calculating and using adjoint gradients disclosed in this specification and shown in 1 concerns the first application of adjoint gradients to control and optimize settings in a multi segmented well model and in particular 2 represents the use of adjoint gradients to calculate sensitivities of a reservoir to changes in parameterization of downhole devices and the use of these sensitivities in optimal control of the wells to optimize some objective function subject to production constraints where an example of an objective function would be cumulative oil production see step in .

Referring to one construction of the Adjoint Method for Calculating and Using Adjoint Gradients of is illustrated the construction shown in representing an optimization flow diagram which functions to practice the Adjoint Method for Calculating and Using Adjoint Gradients of .

In a new set of Production Optimization Inputs including an objective function a set of control parameters and production constraints are provided as input data to a Reservoir Simulator such as the aforementioned Eclipse reservoir simulator offered by Schlumberger Information Solutions a division of Schlumberger Technology Corporation of Houston Tex. The set of Production Optimization Inputs which are provided as input data to the Reservoir Simulator are used to define an optimization problem that will be solved by the Reservoir Simulator . In addition a Well Control Schedule which is time dependent and a Reservoir Model providing the geology of the reservoir are also provided as input data to the Reservoir Simulator . The Reservoir Simulator includes a multi segmented well model the construction and function of which will be described later in this specification. As noted earlier the set of Production Optimization Inputs including the objective function the set of control parameters and the production constraints are provided as input data to the Reservoir Simulator . In the objective function represents a linear combination of discounted flowing rates a measure of the value of the reservoir and the control parameters represent or include well control settings which may be changed during simulation such as valve settings in an instrumented well rate settings for conventional and instrumented wells and bottom hole pressure settings for conventional and instrumented wells. As noted earlier the Reservoir Simulator includes a multi segmented well model . The multi segmented well model is a model of a physical well which accurately models the pressure drop and fluid flow along the wellbore this is achieved by discretizing the well path into segments within which the flow equations are solved consistently. When the Reservoir Simulator receives as input data the reservoir model the well control schedule and the production optimization inputs including the objective function and the control parameters and the production constraints the Reservoir Simulator will perform an Adjoint Gradient Calculation . As noted in the Adjoint Gradient associated with the Adjoint Gradient Calculation is a derivative of the above referenced objective function with respect to changes in the control parameters that are evaluated using the adjoint method. A solution to a large adjoint system of linear equations is required at regular time intervals to calculate the adjoint gradients of the objective function with respect to the control parameters . When the Adjoint Gradient Calculation is complete the following two additional steps will be performed in sequence 1 Calculation of Search Direction that is a suggested change to the control parameters that will not violate any production constraints or limit values of the control parameters followed by 2 an Optimizer which executes an optimization software that maximizes the objective function using line search methods. Recalling that the input data provided to the Reservoir Simulator included a well control schedule when the function performed by the Optimizer is completed the Optimizer will then generate an Updated Well Control Schedule which is time dependent wherein when a local maximum has been located along the gradient based search direction or when a production constraint is encountered the Optimizer will generate the Updated Well Control Schedule which is comprised of new updated control parameters. The Updated Well Control Schedule comprised of the new updated control parameters is then presented to the multi segmented well model associated with the Reservoir Simulator and responsive thereto the Simulator is rerun using these new updated control parameters. In particular recalling that the Reservoir Simulator includes a multi segmented well model the multi segmented well model will receive the Updated Well Control Schedule from the Optimizer and responsive thereto the multi segmented well model will then generate two outputs 1 Reservoir Production Profiles and 2 Optimized Reservoir Production Profiles . As a result which illustrates one construction of the Adjoint Method for Calculating and Using Adjoint Gradients of practices a method for optimizing production of a reservoir having one or more wells having valves the method including a running a reservoir simulator in a forward simulation to simulate the life of the reservoir b processing outputs from the forward simulation to generate intermediate partial derivatives of flow equations for the well and for the reservoir c combining the intermediate partial derivatives of the well flow equations and the reservoir flow equations in the reservoir simulator d solving an adjoint system of linear equations at regular time intervals to calculate a set if adjoint gradients of an objective function with respect to the control parameters e determining from the adjoint gradients a search direction f using the search direction to solve an optimization algorithm that maximizes an objective function using line search methods g locating a local maximum along the search direction and updating control parameters h using the new updated control parameters in the reservoir simulator and i repeating steps a i until an optimal value of the objective function has been reached.

Referring to a detailed description of the construction and the function of the multi segmented well model of is illustrated.

In a wellbore is divided into a plurality of segments and a set of solution variables is determined for each of the segments a method and associated system and program storage device for determining the solution variables will be discussed later in this specification . For example in a multi segmented wellbore is illustrated which consists of a plurality of segments such as segments and . As illustrated in a set of solution variables define each segment.

In the process or method for determining the set of solution variables for each segment of the multi segement wellbore in is discussed in detail the following paragraphs with reference to .

Referring to a multilateral wellbore is illustrated. In the multilateral wellbore includes a main stem and four lateral branches however the four lateral branches include an upper lateral branch a middle lateral branch and two bottom lateral branches. Segments and lie on the main stem. The upper lateral branch of the multilateral wellbore of includes a plurality of segments one of those segments being Segment . The middle lateral branch of the multilateral wellbore of also includes a plurality of segments one of those segments being Segment . The two bottom lateral branches of the multilateral wellbore of each include a plurality of segments. That is the left most bottom lateral branch of the multilateral wellbore of includes a plurality of segments one of those segments being Segment and the right most bottom lateral branch of the multilateral wellbore of includes a plurality of segments one of those segments being Segment . In each segment can be further divided up into a plurality of sub segments. For example Segment can for example be divided up into several other sub segments such as sub segments and

In each segment can be characterized and represented by a set of solution variables . That is each segment can be characterized or represented by the following set of solution variables Q the flowrate of fluid in said each segment Fw the fraction of water in that segment Fg the fraction of gas in that segment and P the absolute pressure in that segment. A shorthand notation for each set of solution variables for a particular segment is selected to be Q Fw Fg P i where i identifies the particular segment. Therefore in segment of the multilateral wellbore can be characterized or represented by the solution variables Q Fw Fg P i 1 segment of the multilateral wellbore can be characterized or represented by the solution variables Q Fw Fg P i 2 . . . and segment of the multilateral wellbore can be characterized or represented by the solution variables Q Fw Fg P i 10 etc. See for a complete list of each set of solution variables Q Fw Fg P i which characterize and represent each of the segments through of the multilateral wellbore of .

A single bore wellbore has a single pipeline or branch and that single branch could also be divided up into a plurality of segments where each segment is characterized or represented by a set of solution variables Q Fw Fg P i.

Referring to a more detailed construction of the Eclipse simulator software of where the Eclipse simulator software includes the Adjoint method for calculating and using adjoint gradients of and where the Adjoint method . . . of further includes the multi segmented well model software of is illustrated.

In the Eclipse simulator software of includes a multi segment well model software . In the Eclipse simulator software includes a group field control model software and the multi segment well model software which is responsive to the group field control model software . However in the multi segment well model software further includes a single well model software and a reservoir model software which jointly determine the solution variables Q Fw Fg P for each segment of a well.

In the group field control model software sends targets limits to the single well model . These targets might be a flow target such as an oil rate production target or a pressure target if the group field control model includes a surface network model each well has its own target to which the well must produce . The group field control model must deal with all the collective aspects of production and injection that is producing a field to a certain target allowing for pressure losses for pipelines on the surface etc.

In response to the targets limits from the group field control model the single well model sends well flow rates up to the group field control model . In addition the single well model sends grid block connection flow rates and derivatives down to the reservoir model . The single well model models each individual well within the reservoir that is the single well model operates on a plurality of wells one at a time.

The reservoir model provides information about fluid conditions in the grid blocks up to the single well model in addition the reservoir model provides the increments to the segment solution variables needed by the single well model at the end of each iteration to be discussed below.

In the single well model interacts with the reservoir model because the reservoir grid blocks act as boundary conditions to the well model single well model. From the reservoir model s point of view the single well model acts as a source of a set of source sink terms used by the reservoir model. The single well model therefore interacts with the reservoir model and extracts fluid from it or injects fluid into it and the Group Field control model interacts with the single well model in that it decides how to allocate field targets and gives each single well an operating target.

In referring initially to the single well model software functions to model a multilateral wellbore and a single bore wellbore block of . In however the step of modeling multilateral wellbores and single bore wellbores block of comprises the following additional steps 1 sub divide each pipeline or branch of the wellbore into a plurality of segments block 2 determine a set of solution variables Q Fw Fg P for each segment of each pipeline of the wellbore block and 3 display and or record the plurality of segments of each pipeline and plurality of solution variables Q Fw Fg P which correspond respectively to the plurality of segments block

The step of sub dividing each pipeline or branch of the wellbore into a plurality of segments block was discussed briefly above with reference to . However the step of determining a set of solution variables Q Fw Fg P for each segment of each pipeline of the wellbore block is practiced by both the single well model and the reservoir model and it will be discussed in detail below with reference to .

In a more detailed discussion of block of which determines a set of solution variables Q Fw Fg P for each segment of each pipeline of a multilateral or single bore wellbore is set forth in the following paragraphs with reference to of the drawings.

In and referring intially to in order to determine a set of solution variables Q Fw Fg P for each segment of each pipeline of the wellbore block of the following steps are performed by the single well model software of 1 initial condition guess solution variables Q Fw Fg P i for each segment in the multi lateral or single bore wellbore block in 2 work out the fluid in place in each segment which is a function of its solution variables Q Fw Fg P i block in 3 work out the flow between each segment and the reservoir which is a function of the segment s solution variables Q Fw Fg P i and the solution variables in the reservoir grid blocks which communicate with the segment block in 4 work out the flow between each segment and its neighboring segments which is a function of its solution variables Q Fw Fg P i and the solution variables in the neighboring segments block in . In 5 calculate the pressure drop along each segment which is a function of its solution variables Q Fw Fg P i block in 6 since blocks and in represent three expressions in a Material Balance Equation for each segment and since block in represents a Pressure Equation for each segment determine the Material Balance Equation residuals and the Pressure Equation residuals for all segments in the well the residuals being a function of the solution variables Q Fw Fg P i for the segments and their neighboring segments and the solution variables in any reservoir grid blocks which communicate with the segments block of 7 calculate the derivatives of the residuals block of 8 ask the question are the residuals less than a tolerance value specified by the user block of FIG. if no go to step 9 below if yes go to step 11 below 9 since no was the answer to the question of block of use the derivatives of block to calculate changes delta Q delta Fw delta Fg delta P to the solution variables Q Fw Fg P for all segments to reduce their residuals to a smaller value on the next iteration block of 10 in apply the changes delta Q delta Fw delta Fg delta P to the solution variables Q Fw Fg P of all segments to produce a new set of solution variables Q Fw Fg P i new and go back to step 2 which is block of block of 11 since yes was the answer to block of in the four equations comprising the three expressions of the material balance equation blocks of and the pressure equation block of are balanced each segment i can be characterized by the solution variables Q. Fw Fg P i block of 12 record and or display the solution variables Q Fw Fg P i for each segment i block of . In display or record on recorder or display or 3D viewer of all of the segments of each of the pipelines of the multilateral or single bore wellbore and the solution variables Q Fw Fg P for each segment block of and block of .

A functional description of the operation of the Adjoint Method for Calculating and Using Adjoint Gradients of will be set forth in the following paragraphs with reference to of the drawings.

The Adjoint method for calculating and using adjoint gradients step of first involves running the Reservoir Simulator of in order to simulate the life of the reservoir. Outputs from this forward simulation of the Simulator are generated and processed thereby generating intermediate partial derivatives of the well and reservoir flow equations . These intermediate partial derivatives of the well and reservoir flow equations are combined inside the Reservoir Simulator of . In the Adjoint Gradient Calculation step of a solution of the large adjoint system of linear equations is then required at regular time intervals in order to calculate a set of adjoint gradients of the objective function with respect to the control parameters . Thus step of i.e. the Adjoint Gradient Calculation step corresponds to step of i.e. calculating adjoint gradients of an objective function with respect to changes in valve settings taking into account the modeling of pressure drop and fluid flow along a wellbore step . As a result when the aforementioned intermediate partial derivatives of the well and reservoir flow equations are combined inside the Reservoir Simulator of the Adjoint Gradient Calculation step of will then generate a set of adjoint gradients of the objective function with respect to the control parameters . In the Calculation of Search Direction step of the set of adjoint gradients of the objective function with respect to the control parameters that were generated by step of are then used in the Calculation of Search Direction step to determine a search direction that is a suggested change to the control parameters that will not violate any production constraints or limiting values of the parameters. Thus step of i.e. Calculation of Search Direction step corresponds to step in i.e. using the adjoint gradients to calculate sensitivities of a reservoir to changes in parameterization of downhole devices and using of these sensitivities in the optimal control of the wells to optimize some objective function subject to production constraints step . This search direction is given to the Optimizer of . The Optimizer includes an optimization algorithm that when executed maximizes the objective function using line search methods recall from step of that the calculated sensitivities are used in the optimal control of the wells to optimize some objective function . When a local maximum of the objective function has been located by the Optimizer along the gradient based search direction that was established by the calculation of search direction step or when a production constraint is encountered the Optimizer will then generate an Updated Well Control Schedule which includes a set of new updated control parameters . The new updated control parameters of the Updated Well Control Schedule are presented to the Reservoir Simulator and in particular to the multi segmented well model of the Reservoir Simulator . The Simulator is re run using the aforementioned new updated control parameters . The above referenced process or method is repeated that is a new set of adjoint gradients of the objective function with respect to the control parameters is calculated by the Adjoint Gradient Calculation step of a new search direction is determined by the calculation of search direction step of and a new Updated Well Control Schedule is generated by the Optimizer of until some termination criterion has been satisfied. For example the termination criterion will be satisfied when convergence has been achieved and convergence will be achieved when an optimal value of the objective function has been reached.

When the multi segmented well model of the Reservoir Simulator receives the new updated control parameters of the Updated Well Control Schedule the multi segmented well model will then determine a set of solution variables for each segment of each pipeline of the wellbore step of and then display or record the segments of each pipeline and the sets of solution variables corresponding respectively to the segments step of . The multi segmented well model will then generate two outputs 1 the Reservoir Production Profiles and 2 the Optimized Reservoir Production Profiles of .

A functional specification associated with the Adjoint Method for Calculating and Using Adjoint Gradients of and is set forth in the following paragraphs.

This specification includes software namely the Resopt software that is embodied within the Eclipse Simulator software of that uses adjoint gradient technology to optimize production from a simulation model subject to constraints.

In the objective function we are trying to change the production control parameters P so that we maximize a quantity e.g. FOPT subject to the constraints that the simulator fluid flow residual equations R 0 are satisfied and also that additional production constraints C 0 are satisfied.

Generally production constraints are inequalities. For convenience we will divide these into active i.e. those for which currently C 0 and inactive constraints. For clarity we will denote the active constraints by C.

Lagrange multipliers are used to combine the equality constraints with the objective function into the merit function L 1 

where J is the objective function X is the vector of solution variables e.g. pressure saturations molar densities and and are the vectors of Lagrange multipliers on the equality constraints.

In order to determine a search direction for maximizing this objective function we are interested in forming its total derivatives with respect to the production control parameters. This is

In order to calculate this we need the solution derivatives X P and also the following partial derivatives of the Lagrangian.

Since R 0 and C 0 then we are free to choose any values for and in 1 . In particular we can choose these vectors so that L X 0 in 3 . This removes the need to perform the expensive step of calculating X P in 2 and we then just need to evaluate 4 to get the Lagrangian gradient.

If there are Nactive constraints and Ninactive constraints then we have enough degrees of freedom to set L P 0 for Nof the production control parameters. So from 4 

Equation 8 involves the solution of a system of equations in which the matrix R X is very large. R is the vector of residual equations at all time intervals and X is the vector of solution variables at all time intervals. In practice it is possible take advantage of structure in the total Jacobian matrix R X to reduce the size of the system that needs to be solved.

Since R t R X t X t P then the total Jacobian matrix is a block lower triangular so its transpose is block upper triangular 

The diagonal matrices are the Jacobian matrices from each time interval Jac t . In RESOPT these are reconstructed from the contents of the restart file that were saved at each report step of the forward simulation.

If we specify the parameters P and constraints C so that each applies to a particular time interval then the entire system 8 becomes the following sequence of smaller systems 

Hence for a particular cell the product of this matrix with a vector multiplying from the left such as

This process requires 1 solve of the transpose simulation Jacobian matrices followed by 1 solve of a small matrix system order of number of active constraints . Total 1 transpose Jacobian matrix solve.

In the case where the active constraints are not sensitive to the dependent parameters i.e. C P 0 we cannot solve 5 and 6 by eliminating and then solving for . Instead we must take the more costly approach of eliminating which may involve multiple R X solves and then solving for .

As before if we specify the parameters P and constraints C so that each applies to a particular time interval and remembering the time structure of R X then the entire system 10 becomes 

We keep the C Pterm here because we want to be able to handle cases where some active constraints are insensitive to the parameters so C P 0 in some sense.

When solving 11 we are solving a transpose system involving the simulator Jacobian matrices so as in the normal formulation we solve this system backwards in time. In order to use the same backwards in time philosophy when solving 12 we re write it as

We can solve the nequations of 14 first and then solve the other equations backwards to solve the entire system. Note that if N 0 then we only solve for t and can arbitrarily set t 0 for all other k.

In a similar way we can solve the nequation of 11 first and then solve the other equations backwards to solve the entire system. Note that if N 0 at a particular time interval t then 11 reduces to t t 

This process requires 1 Nsolves of the transpose simulation Jacobian matrices followed by 1 solve of a small matrix system order of number of active constraints and then followed by sgn N solve of the transpose simulation Jacobian matrices. Total 1 sgn N Ntranspose Jacobian matrix solves.

In the code there are N N NOCONL dependent production control parameters and N N NOPARL NOCONL free production control parameters at each time level.

Pre 2006a only a very simple partitioning of the parameters was used make the first Nparameters dependent and treat the rest as free.

At 2006a some logic was added so that the ones with the largest C P diagonal values normal approach or largest R P column sum alternative approach are taken as the free parameters. This logic uses an indirection indexing array IDXP to convert from the original parameter order to the sorted order. Original arrays such as R P F P etc. are stored in original order as they are calculated before the parameter split. Intermediate arrays such as C P are stored in local order.

Once we have successfully stepped backwards over all the time intervals we have the complete vector of Lagrangian derivatives L P for the free production control parameters. We use these to determine the free production control parameter search step P using either steepest descent or conjugate gradients in the current code .

For any P the linearized forms of the perturbed reservoir constraint equations and the active optimization constraint equations give

Hence the Nactive constraint equations can be seen as a partitioning of the production control parameters P into P P where the first Nproduction control parameters P are dependent on the remaining free ones P through the generally non linear constraint and definitely non linear reservoir equations.

We split this system into smaller ones each covering a time interval. We denote the Jacobian for the reservoir equations

In RESOPT following on from the previous calculations the sequence of these additional calculations is 

This process requires 1 solve of the simulation Jacobian matrices followed by 1 solve of a small matrix system order of number of active constraints . Total 1 Jacobian matrix solve.

If the active constraints are not sensitive to the dependent parameters then we cannot use 17 to eliminate the dependent parameters and then solve for X and P so instead we have to use 15 to eliminate X. From 15 

As before if we specify the parameters P and constraints C so that each applies to a particular time interval and remembering the time structure of R X then the entire system 19 becomes 

In RESOPT following on from the previous calculations the sequence of these additional calculations is 

This process requires 1 Nsolves of the simulation Jacobian matrices followed by 1 solve of a small matrix system order of number of active constraints and then followed by sgn N solves of the simulation Jacobian matrices. Total 1 sgn N NJacobian matrix solves.

Given that we have a search direction for the production control parameters P we next need to know the step length. From 18 we know if we step a distance along X then we should also step a distance along P. The active constraint equations will be satisfied inherently but we must not violate any of the currently inactive ones so we are interested in how far we can step before we would violate the inactive constraints. In order to hit an inactive constraint at this step 0

The closest constraint i.e. the one that would be first violated if an unrestricted amount of the search direction were used is the one with the minimum value of .

In RESOPT following on from the previous calculations the sequence of additional calculations is as follows 

When taking a step in the optimizer we need to restrict the production control parameter step length by a factor to ensure that do not violate any of these simple bounds. By default is one.

In RESOPT following on from the previous calculations the sequence of additional calculations is as follows 

Loop over all production control parameters if necessary solving 25 for and then modifying the control parameter step length.

Finally in RESOPT we conduct a line search along the search direction to complete this step of the optimizer.

Once we have exited the line search we look for the next production control parameter step direction.

This is a summation over sub functions J. Here Cis specified for each sub function in the OPTFUNC keyword and the sub function J is given by

The user can specify multiple sub functions in the OPTFUNC keyword. For example optimize field oil production while penalizing water production from well PROD between timesteps 2 and 7 

Each constraint is included in the objective function as a pair of additional sub functions and . The Lagrange multiplier will multiply these constraint sub functions in order to incorporate them in the objective function.

This sub function approach has the advantage that the gradients of the sub functions can be accumulated to give the gradient of the function.

These are limits on the simulation quantities themselves. For example the production rate must not exceed 2000 in well PROD. The constraint is re written as follows WOPR 2000 2000 0

This is handled as the following pairs of sub functions one pair for each report index at which the constraint is active 

This is handled as the following pairs of sub functions one pair for each report index at which the constraint is active 

These are limits on derived simulation quantities. For example the gas oil ratio must not exceed 1.5 in well PROD. The constraint is re written as follows 

This is handled as the following pairs of sub functions one pair for each report index at which the constraint is active 

As another example the water cut must not exceed 0.2 in well PROD. The constraint is re written as follows 

This is handled as the following pairs of sub functions one pair for each report index at which the constraint is active 

When comparing constraint functions to see which is the most binding we need to normalize them so that we can make a far comparison between constraints on data type with vastly different units.

For simple constraints the constraint value is the obvious choice. For example to normalize 2000 0 use 2000 to change it to

For a GOR constraint the constraint has been transformed from . . . 1.5 0 to the following which can be written as sub functions . . . 1.5 0 If we were to normalize the original constraint equation we would divide by the constraint value as we did in the case of simple constraints . This would give . . .

So the normalizing factor that needs to be applied to the pair of sub functions in order to get the same result as normalizing the original constraint equation is 1.5 times OPR.

Hence the normalizing factor is the constraint times the oil production rate in the domain of the constraint.

For a WCT constraint the constraint has been transformed from . . . 0.2 0 to the following which can be written as sub functions . . .

If we were to normalize the original constraint equation we would divide by the constraint value as we did in the case of simple constraints . This would give . . .

So the normalizing factor that needs to be applied to the pair of sub functions in order to get the same result as normalizing the original constraint equation is 0.2 times the sum of OPR and WPR.

Hence the normalizing factor is the constraint times the sum of the oil and water production rates in the domain of the constraint.

In a non restarted deck the scope of the functions sub functions parameters and constraints in RESOPT is the same as that of the simulation i.e. 1 to NTOTRS is the same as 1 to NOPTIM so we can use the same indexing in both areas of the code and we can compare optimizer step index with the simulation report index.

In a restarted deck the scope of the simulation is IRESTZ 1 to NTOTRS while the scope of the storage in the RESOPT code is 1 to NOPTIM NTOTRS IRESTZ . We use the RESOPT scope internally because it is efficient for storage.

Hence the SOPT array which holds to double precision optimizer run time information such as the current time value and the size of time steps is indexed from 1 to NOPTIM. Many of the arrays holding information and results for parameters are indirectly indexed using this optimizer scope also.

To convert from optimizer step index ISTEP to simulation report index JSTEP just add IRESTZ. The standard mechanism in the code is to just do this locally when required e.g. JSTEP ISTEP IRESTZ

Typical arrays in the adjoint optimizer code are IOPP SOPP ZOPP IOPF SOPF IOPS SOPS ZOPS and SOPG. The naming convention for these arrays is as follows 

The above description of the Adjoint Method of Calculating Gradients being thus described it will be obvious that the same may be varied in many ways. Such variations are not to be regarded as a departure from the spirit and scope of the claimed method or apparatus or program storage device and all such modifications as would be obvious to one skilled in the art are intended to be included within the scope of the following claims.

