---

title: Methods, systems, and computer program products for hierarchical registration between a blood vessel and tissue surface model for a subject and a blood vessel and tissue surface image for the subject
abstract: Methods, systems, and computer program products for hierarchical registration () between a blood vessel and tissue surface model () for a subject and a blood vessel and tissue surface image for the subject are disclosed. According to one method, hierarchical registration of a vascular model to a vascular image is provided. According to the method, a vascular model is mapped to a target image using a global rigid transformation to produce a global-rigid-transformed model. Piecewise rigid transformations are applied in a hierarchical manner to each vessel tree in the global-rigid-transformed model to perform a piecewise-rigid-transformed model. Piecewise deformable transformations are applied to branches in the vascular tree in the piecewise-transformed-model to produce a piecewise-deformable-transformed model.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08233681&OS=08233681&RS=08233681
owner: The University of North Carolina at Chapel Hill
number: 08233681
owner_city: Chapel Hill
owner_country: US
publication_date: 20050926
---
This application claims the benefit of U.S. Provisional Patent Application Ser. No. 60 613 166 filed Sep. 24 2004 the disclosure of which is incorporated herein by reference in its entirety.

This invention was made with U.S. Government support under Grant No. R01 EB000219 awarded by the National Institutes of Health. The U.S. Government has certain rights in the invention.

The subject matter described herein relates to modeling blood vessel and tissue surface images and registering blood vessel and tissue surface models with blood vessel and tissue surface images for a subject. More particularly the subject matter described herein relates to methods systems and computer program products for hierarchical registration between a blood vessel and tissue surface model for a subject and a blood vessel and tissue surface image for the subject.

In medical applications such as ultrasound guided surgery it may be desirable to register a pre operative image onto the ultrasound image generated by an ultrasound probe during the surgery. For example features of interest such as tumors and lesions may not be visible in the intra operative ultrasound image used for surgical guidance. However these features may be clearly visible in pre operative images such as magnetic resonance MR and computerized tomography CT images. Because these features of interest are visible in the pre operative images but not in the intra operative ultrasound images it is desirable to transcribe or map these features from the pre operative images to the intra operative images.

One conventional method for mapping pre operative image features into intra operative images involves an image to image mapping of the pre operative image to the intra operative image. One problem with performing image to image mappings is that the image to image mappings are typically slow because of the number of pixels or voxels that must be mapped between the two images. For example some image to image mapping techniques can take between five minutes and two hours to converge. Such slow convergence is unsuitable for applications such as surgical guidance that require real time changes in the mappings. For example during ultrasound guided percutaneous liver surgery a pre operative MR or CT image may initially be manually aligned as an overlay with an ultrasound image. During surgery the liver may move and or deform when the patient moves or breathes. As a result the ultrasound image becomes misaligned with the pre operative image. Similarly in brain surgery the brain may settle due to changes in pressure during surgery caused by opening of the skull or tumor removal. These movements also cause the ultrasound image to become misaligned with the pre operative image.

Current surgical guidance systems attempt to solve this misalignment problem using a joystick or other method that allows manual alignment between the pre operative and intra operative images. However such alignment is rigid and does not account for target image deformation during surgery. In addition manual re alignments must be continuously performed during surgery for a subject.

Accordingly in light of these difficulties associated with conventional methods for aligning pre operative and intra operative image data there exists a need for improved methods systems and computer program products for registration between blood vessel and tissue surface image data.

According to one aspect the subject matter described herein includes a method for hierarchical registration between a blood vessel and tissue surface model for a subject and a blood vessel and tissue surface image for the subject.

The method includes generating a blood vessel and tissue surface model from a source blood vessel and tissue surface image for a subject. A plurality of hierarchical registrations between blood vessel models in the blood vessel and tissue surface model and blood vessels in a target blood vessel image for the subject are performed. At least one registration is performed between a tissue surface model in the blood vessel and tissue surface model and a tissue surface in the target blood vessel and tissue surface image. The results of the registrations are transformations between locations in the blood vessel and tissue surface model and locations in the target image data. Based on the transformations in locations the location of a feature of interest in the target blood vessel and tissue surface image is determined.

The subject matter described herein for implementing hierarchical registration between a blood vessel and tissue surface model and a blood vessel and tissue surface image may be implemented using a computer program product comprising computer executable instructions embodied in a computer readable medium. Exemplary computer readable media suitable for implementing the subject matter described herein include chip memory devices disk memory devices application specific integrated circuits programmable logic devices and downloadable electrical signals. In addition a computer program product that implements the subject matter described herein may be located on a single device or computing platform or may be distributed across multiple devices for computing platforms.

According to one aspect the subject matter described herein includes a system for hierarchical registration between a blood vessel and tissue surface model and blood vessel and tissue surface image data. illustrates such a system. Referring to a blood vessel and tissue surface model generator receives source blood vessel and tissue surface image for a subject. The source blood vessel and tissue surface image may be an MR image a CT image or any other type of image in which blood vessels and tissue surfaces can be distinguished from other features. Blood vessel and tissue surface model generator generates a vascular model and a tissue surface model based on the source blood vessel and tissue surface image. An exemplary method for producing a vascular model and a tissue surface model will be described in detail below.

The system illustrated in also includes a hierarchical blood vessel and tissue surface model to image registration module for registering the models generated by blood vessel and tissue surface module generator with target blood vessel and tissue surface images for the subject using hierarchical piecewise and global registrations. Hierarchical blood vessel and tissue surface model to image registration module may receive the models and target blood vessel and tissue surface images for a subject. Hierarchical blood vessel and tissue surface model to image registration module may also receive a location or feature of interest in the source blood vessel and tissue surface image to be mapped into the target blood vessel and tissue surface image. For example the location or feature may be the location of a tumor or an notation made by a physician that corresponds to tumor margins. Hierarchical blood vessel and tissue surface model to image registration module may apply a series of hierarchical rigid and deformable registrations to produce a model with a target image registered location or feature of interest. For example in registering a pre operative MR image of a liver tumor with an intra operative image of the liver hierarchical blood vessel and tissue surface model to image registration module may utilize the transformations between the locations of the blood vessels and the tissue surfaces to determine the transformation in the location of the tumor from the pre operative image to the intra operative image.

The registrations performed by hierarchical blood vessel and tissue surface model to image registration module are hierarchical in the sense that blood vessel models in the blood vessel and tissue surface model are mapped to blood vessels in the target image starting from a trunk of each blood vessel and continuing along successive branches of each blood vessel. For example blood vessels in the human vasculature form tree like structures. The hierarchical blood vessel model to image registration method according to the subject matter described herein first registers the trunk of a vessel in the model with a trunk of a vessel in the image. Branches that are children of the trunk are registered along with the trunk. Next the branches and sub branches are registered in a hierarchical manner. Piecewise rigid and deformable registrations are both performed in this manner.

According to one aspect the subject matter described herein includes a method for registering a vascular model with a vascular image for a subject. is a flow chart illustrating exemplary steps for registering a vascular model with a vascular image according to an embodiment of the subject matter described herein. Referring to in step a vascular model is mapped to a target image using a global rigid transformation. In step vessels in the global rigid transformed vascular model are mapped to vessels in the target image using piecewise rigid transformations. The vessels are mapped in a hierarchical manner from root to branches to sub branches as illustrated in . In step the vessels in the piecewise rigid transformed vascular model are mapped to vessels in the target image using piecewise deformable transformations. The deformable transformations are also performed in a hierarchical manner as described above.

As stated above in aligning a model with a target image the blood vessel registration method illustrated in may be augmented with tissue surface registration. is a flow chart illustrating exemplary steps for combining tissue surface model to image registration with blood vessel model to image registration according to an embodiment of the subject matter described herein. Referring to in step a vascular model and a tissue surface model are generated from image data for a subject. In step a global rigid registration is performed between the vascular and tissue surface models and a blood vessel and tissue surface image for a subject to form a first transformed vascular and tissue surface model. The registration in step may be performed such that the registrations for the vascular and tissue surface models are simultaneously optimized. In step hierarchical piecewise rigid registration is performed between blood vessels in the first transformed vascular model and blood vessels in the target image to form a second transformed vascular model. Step is the same as step illustrated in . Once step is performed it is necessary to determine how to move the tissue surface model based on movements in the blood vessels in the vascular model. Two options are illustrated in for registering the tissue surface model after the piecewise rigid blood vessel registration. One option is illustrated in step A where the deformation field produced by the second vascular transformation step is extrapolated to obtain a second transformed tissue surface model. The second alternative is illustrated in where a global rigid registration is performed between the tissue surface model and the tissue surface image to form the second transformed tissue surface model.

In step a hierarchical piecewise deformable registration is performed between the second transformed vascular model and the target image to form a third transformed vascular model. Step is the same as step illustrated in . In step a global deformable registration is performed between the second transformed tissue surface model and the target image to form a third transformed tissue surface model. In step the third transformed vascular model and the third transformed tissue surface models are combined to form a third transform vascular and tissue surface model.

After step the result is a model in which the vessels and tissue surfaces are transformed from the source image data to the target image data. However it may be still be desirable to transform other locations or features from the source image data to the target image data. Examples of such locations or features include tumor locations and or annotations made by a physician in the source image data. Accordingly in step a deformation field interpolation is performed to transcribe features of interest in the source image data to the third transformed vascular and tissue surface model.

Steps may be continually repeated during surgery or other time period in order to continually update registration between the vascular and tissue surface model and the target image as the target image changes. Because the registration is hierarchical and includes both rigid and deformable transformations the resulting registration is both more accurate and more rapidly converging than conventional image to image registration methods. Exemplary methods for performing the steps illustrated in will now be described in detail.

Blood vessel modeling may be performed using any suitable method that extracts a blood vessel model from blood vessel image data. In one example a three dimensional blood vessel modeling or segmentation method according to the subject matter described herein may include performing a multiscale extraction of the centerline of a vessel and then estimating the radius of the vessel about the centerline. Specifically the method involves three steps 

Two of the most important benefits to this approach to radius estimation are as follows. 1 The kernels cover a large extent of the tube thereby providing additional insensitivity to image noise. 2 The kernels are fit to the spatial curve of the centerline thereby reducing assumptions about the local shape of the tube. Tests that demonstrate the method estimates centerlines in noisy images in seconds with sub voxel accuracy and with insensitivity to the position of the initial seed point xand the initial radius restimate have been performed. See Aylward et al. A Comparison of Methods for Tubular Object Centerline Extraction IEEE Transactions on Medical Imaging 21 2 61 75 2002 . These centerlines and radius representations are the basis of the present registration process.

As illustrated above in the subject matter described herein includes tissue surface modeling registering tissue surface models with tissue surface image data and combining tissue surface model to image registration with vascular model to image registration. The following sections illustrate examples of blood vessel and tissue surface modeling and model to image registration for using human liver image data as an example.

The input to the present liver surface and vessel extraction methods can be any suitable image in which vessels tissue surfaces and features of interest are identifiable such as CT or MR scans. The CT scanner used in the examples described herein is a Siemens Sensation 16 multi detector unit. Liver scans are acquired 30 and 60 seconds after contrast injection to help distinguish portal from hepatic vessels. illustrate CT images of the liver used in this example. More particularly illustrates one slice from a portal phase contrast CT scan. illustrates one slice of a hepatic phase contrast CT scan acquired 30 seconds after the portal phase scan. illustrates one slice from a subtracted 3D VIBE MR scan. Voxel size is 0.56 0.56 1.5 mm. For MR imaging of liver parenchyma and vasculature a 3D VIBE sequence on the Siemens 1.5T Sonata MR scanner was used. This 17 second contrast enhanced acquisition sequence can capture liver volume and vasculature at 0.6 0.6 2.5 mm. A pre contrast VIBE scan from a VIBE scan acquired 23 seconds after gadolinium contrast injection .

The semi automated liver surface segmentation process is a sequence of connected component and morphological operations Aylward 2002a that has been shown to be faster and more accurate than hand segmentation Weeks 2001 . Specifically 1 from a user specified starting point and using lower and upper intensity thresholds specified by the user the voxels spatially connected to the starting point and having intensities within the thresholds are identified this is the standard connected components technique . 2 That component is pruned via erosion using a spherical operator to remove sections that are only connected by thin strands to the main components. The main component is subsequently dilated by the same amount to return it to its original borders minus its clipped regions . 3 The main component is then dilated using a spherical operator to fill in small holes and again subsequently eroded by the same amount to return it to its original borders minus its holes and clipped regions . 4 A Finite Element Quad Mesh is fit to the segmented liver using methods in the NLM s Insight Toolkit. All liver segmentations are performed using the hepatic phase CT data with 200 and 400 HU as the thresholds and 1.2 cm as the radius of the erosion and dilation operators. Sometimes it is necessary to edit the resulting segmentations for example to exclude the inferior vena cava. On CT scans of water filled balloons and surgical gloves the present semi automated process requires approximately 1 minute per item and estimates the volumes to within 10 of ideal on the same data hand contouring requires up to 15 minutes per item and averages error Weeks 2001 . This semi automated segmentation process while effective is not critical to the success of the present system manual contouring could be used to generate the surface model needed for feature image registration. However the present semi automated method has been used to segment livers from over 20 subtracted VIBE scans and 80 liver CT scans with excellent results.

Accurate 3D vessel segmentations have been performed using the method described above Over 80 liver CT over 20 liver VIBE MR and over 150 head MRA scans have had their vessels segmented using the present method. As described above the segmentation method includes dynamic scale centerline extraction followed by adaptive radius estimation. Monte Carlo simulations have been conducted to measure the present vessel extraction method s speed accuracy and dependence on its initial parameter values Aylward 2002a . Those analyses demonstrate the level of detail and accuracy that can be expected from the present pre operative vessel models. They are summarized below.

To evaluate centerline extraction accuracy a mathematical model of a tortuous vessel was created and three different magnitudes of Gaussian noise were added to its image data. The vessel had a radius of 4 voxels at its ends and 0.5 voxel at its middle. At its middle it branched. The branch was optimally difficult each branch was identical and only spanned one voxel. For each level of image noise the present dynamic scale ridge traversal method was applied using different initial scales and 200 randomly chosen starting points within the object. Average time to extract 20 voxels of centerline was about 0.3 seconds. At the low and medium levels of noise average centerline error was less than one voxel maximum error was about two voxels 90 of the centerline points were with in one voxel of ideal and the branch point was traversed 60 80 of the time. Regarding automation the accuracy of the centerline extractions was not statistically significantly affected by the starting parameter values initial scans and starting points .

To verify the centerline extraction method on clinical data tests were performed using 300 extractions of a small radius 1 voxel and tortuous vessel in intracranial time of flight MRA data were performed using. Seed points to designate the vessel of interest were randomly chosen within two radii of the vessel. No two extractions of the centerline of interest differed by more than 1 10of a voxel.

To evaluate radius estimation accuracy and consistency another vessel with multiple branch points was simulated. Three different levels of Gaussian noise were added to its image data. At each noise level 300 random centerline extractions were performed. The average radius estimation error was less than voxel maximum error was approximately one voxel and 80 of the estimates were within voxel of ideal.

Capturing vascular movement is critical to capturing deformations internal to the liver and the level of detail provided by the present pre operative models is well beyond what has been used by others. Surface models alone are insufficient since only a small segment of the liver surface is captured in each ultrasound scan and it may be difficult to correlate surface movement with deformations internal to the liver. However King 2001a b limited vessel models to manually specified centerlines of the major portal vein and the inferior vena cava and Porter 2001 used simple thresholding to find bright voxels indicative of vessels in MR and Doppler ultrasound.

Examples of the application of the present liver surface and vessel segmentation methods are given in . More particularly illustrates a vessel tree extracted from a portal phase contrast CT scan. illustrates a vessel tree extracted from a hepatic phase contrast CT scan. illustrates a vessel tree extracted from pre post 3D VIBE MR sequences. illustrates a liver its vessels and right lobe segmented from a CT scan. The 3D visualizations illustrated in may be useful for partial liver transplant planning. The other source of data in ultrasound annotation the intra operative ultrasound data will now be discussed.

Target images to which the hierarchical model to image registration methods may be applied can be obtained from any suitable source. In one example a Meduson Voluson 530D 3D ultrasound system was utilized to obtain ultrasound images of the liver for the present method. The strength of the Voluson 530 scanner is that it acquires 3D ultrasound scans without requiring the operator to perform a sweeping motion the linear transducer internal to the probe is automatically swept to acquire the 3D data. Unlike the freehand 3D option on 2D ultrasound machines these 3D scans are FDA approved for volume and other 3D measurements. Self contained automated 3D sweeping greatly simplifies the mental and physical demands placed on the clinician and reduces the risk of spatial errors.

One complication with the Voluson 530 is that scans require 7 to 15 seconds to be acquired. Given that the PLL RFA patients are often not under respiratory control 7 to 15 second scans are likely to suffer from intra scan organ movement. A Volu son 730 scanner that offers sub second scan times may be used to perform the scans.

To measure the spatial accuracy of the present 3D ultrasound scanner a Rammex RMI 403GS Middleton Wis. calibration phantom was used. After Cartesian resampling by the Voluson system 3D scans captured distances within one voxel throughout their entire volume accuracy did not vary for deep or off center targets. Nevertheless in liver acquisitions as the ultrasound pulses pass through heterogeneous tissues spatial distortions may occur. These distortions however will have equal effect on the apparent position of the needle liver surface and liver vessels within the ultrasound data. Since the present methods are primarily concerned with the relative locations of these objects the ultrasound distortions should have minimal effect on physician performance or accuracy when using ultrasound annotation.

The present example did not involve the acquisition of Doppler ultrasound images. The Voluson 530 produces very poor quality Doppler ultrasound images. Doppler ultrasound images have been determined to be unacceptable for clinical use and review has showed that the quality and quantity of the vessels captures with Doppler is less than what is available in its b mode images. In a manufacturer demonstration the GE Voluson 730 provided significantly better 3D Doppler images. However it is believed that the present method would be more broadly applicable if 3D Doppler images weren t required since not all 3D acquisition techniques can provide them e.g. the popular Stradx software for creating 3D ultrasound images cannot create 3D Doppler images.

Ultrasound probe tracking cannot account for organ changes between pre and intra operative image acquisitions intra operative patient movements internal organ movement or organ deformations however the present method will track the 3D ultrasound probe when ultrasound data is acquired and then use the tracker data to initialize the registration of the ultrasound data and the pre operative models. The tracker data provides rigid transforms that capture relative probe movements between subsequent ultrasound scans. That rigid transform is compounded with the previously resolved image transform to initialize the next image registration process. One exemplary tracker suitable for use in tracking an ultrasound probe is a Flock of Birds magnetic tracker Ascension Technologies . To reduce the ultrasound probe s interference of the magnetic sensor the sensor is fixed to the end of a rigid 15.5 long piece of plastic that has an extruded triangle shape. At the other end an aluminum ring passes through the plastic and can be tightened around the ultrasound probe handle. This setup has been determined to be particularly stable and broadly applicable. This setup however requires calibration of the relationship between the sensor and points in the ultrasound data. For tracker to ultrasound data calibration a 5 5 5 cm pyramid shaped wire frame object was constructed. It is placed in a bucket of water and three or more tracked 3D ultrasound scans are acquired. The location and orientation of the object in each scan is determined using a generalized Hough transform Ballard 1981 . The present method solves using a squared error minimization technique initialized with expected values for the transformation matrix that can be compounded with each tracker position to align their object representations. Repeated calibrations of the same probe sensor setup were performed. For a sensor to probe tip distance of 338.4 mm the standard deviation of four repeated calibrations was 0.145 mm and the maximum difference from the mean was 0.168 mm. Another possible source of magnetic tracker error is field deformation due to metal moving near the sensor. The present studies indicate that this error may be significant. In particular a tracker sensor sitting on a surgical bed beside a patient will appear to move as much as 11 mm when a 24 gage biopsy needle is moved near it. Such additional uncertainty in registration initialization adds to the time required perform the image registration process. It may therefore be desirable to use an optical tracker to track the ultrasound probe and thereby accurately initialize registration. Using an optical tracker will allow focus on the primary purpose for image registration in ultrasound annotation i.e. accounting for liver deformation due to patient movement organ movement breathing needle pressure etc. that external tracking cannot capture.

The present registration metric quantifies how well a transform aligns liver surface and vessel models from pre operative data with intra operative ultrasound images. The present metric uses the physics of ultrasound acquisition when specifying the type of measures to be made in the ultrasound images. For example since vessels appear as dark tubes in 3D ultrasound images when a vascular model is aligned with an ultrasound image the centerline points of the model will map to dark voxels in the image. Similarly organ surfaces form bright or high gradient surfaces in ultrasound images dependent on the orientation of the ultrasound probe with respect to the orientation of the surface. However occluded regions are also commonly present in ultrasound data and vessel surface features will not be visible in those regions. Therefore prior to initiating intra operative registration it is necessary to identify occluded regions and exclude them from influencing the registration process.

Occluded region identification The present subject matter includes a method for rapid identification of occluded regions in ultrasound images. The occluded regions are designated as don t care regions so that features that map into those regions will neither dilute the match metric nor create false local metric maxima. The primary emphasis during occluded region masking is speed underestimating an occluded region is allowed since the present registration method is insensitive to missing features Aylward 2003 . The present occluded region masking method operates by down sampling the 3D ultrasound images from 256 256 256 to 64 64 64 requires 0.64 seconds and then convolving that sub sampled image with a 1D Gaussian derivative kernel oriented approximately along the ultrasound wave propagation direction via table lookup . The intensity and gradient magnitude are then thresholded to identify points within the occluded region. Thresholds were chosen based on observations from multiple 3D ultrasound scans the thresholds have worked on every subsequent scan without modification. The resulting mask is then up sampled to 256 256 256 using nearest neighbor interpolation. Convolution thresholding and up sampling requires 1.86 seconds. Total computation time is 2.5 seconds. This processing was implemented using ITK the National Library of Medicine s Insight Toolkit for Medical Image Segmentation and Registration www.itk.org. ITK provides multi threading and data streaming with the requested dual processor machine the computation time should be reduced by 40 50 . Results are illustrated in . More particularly illustrates a 3D mask computed using the method described in this paragraph. The computation of the 3D mask in required 2.505 seconds. The robustness of the present registration process allows for the underestimation of the occluded region. Emphasis was therefore placed on speed.

Vascular Feature Image Match Metric One exemplary metric suitable for use with the subject matter described herein quantities the match between pre operative vascular models and the intra operative ultrasound image data. Again the present implementation focuses on vascular features since they have received the least attention by other groups and yet they may be best at capturing deformations internal to the liver. The vascular feature image match metric is given by 

As will be described below this metric is extended to include surface models and measures. Additional aspects of the physics of ultrasound acquisition will also be described.

In addition to using a vascular feature image match metric the present implementation includes a coarse to fine deformable registration. Traditionally coarse to fine registration is implemented using an image pyramid a sequence of sub samplings. However by using deformations at one scale as a prior for deformations at a finer scale for every point in an image the underlying assumption is that the objects throughout the image have equal coherence across those scales yet objects exist at different scales in images. For the present application blood vessels inherently provide a natural coarse to fine hierarchy as tree structures. In the liver the portal and hepatic vessels form two distinct trees. The accuracy of the present tree formation process isn t critical but has been demonstrated to be over 98 accurate as evaluated by comparison to x ray angiograms by expert radiologists Bullitt 2001b . These vascular tree structures are used to localize and scale the present system s coarse to fine registration process.

As illustrated in one exemplary deformable transform optimization process includes three steps. The first step is global rigid registration using a vessel image metric Aylward 2001 2002a 2003 . The second step consists of a piecewise rigid registration process applied hierarchically from vessel tree roots to leaves. The third step is a piecewise non rigid deformation process that is also applied from vessel tree roots to leaves. The two last steps are unique and their use of the vessel hierarchy supports fast registration by eliminating the need to compute intra operative image pyramids.

Rigid registration The present deformable registration strategy is initiated by solving for a global rigid transform that maps the pre operative models into the intra operative ultrasound data Aylward 2001 2002a 2003 . A unique property of the present method is that it limits vessels to inducing registration updates in their normal directions. Furthermore the iterative updates of the rigid transform are adjusted for the orientation bias of the vessels. For example if most of the vessels in the network have a horizontal orientation the total vertical update they induce is down weighted so that horizontal alignment updates can have equal force. This registration process achieves consistent sub voxel convergence from 0.2 radians of mis rotation and 20 voxel offsets in 2 3 seconds for MR to ultrasound registration. The present rigid registration implementation involving only vasculature operates as follows.

A matrix Nis defined to specify the plane normal to each transformed vessel centerline point. For the vessel model points that matrix is defined as 4 where denotes the outer product operator and the nare the directions normal to the vessel centerline at x.

To limit a vessel point to inducing changes in its normal directions the scaled image gradient is projected onto its normal plane 5 

To remove the global orientation bias the spread of the normal planes is calculated for the subsampled centerline points as a global bias matrix

Then each projected gradient is corrected for the global orientation bias by multiplying it by the inverse of the global bias matrix 7 Even though each normal plane Nis of reduced rank 3 3 matrix of rank 2 the bias matrix B is invertible as long as all of the vessels in a network are not parallel. The unbiased gradients from Equation 7 are then used to determine updates to transforms parameters that maximize the metric. For example offset vector updates during registration optimization are defined as the weighted sum of the unbiased projected gradients.

Piecewise rigid registration After global rigid registration a rigid transformation is calculated to refine the position of each vessel in a hierarchical manner. First if a root of a vascular tree overlaps with the ultrasound image after global rigid registration its position and orientation independent of other vessels is refined using a rigid transform and the metric. Vessels spanning more than 20 voxels are broken into 20 voxel segments. Second each root s branches are registered rigidly with the image one branch at a time using the tree s parent child hierarchy and using branch points as anchor points. Again only those branches that were determined to overlap the intra operative image based on the global rigid transform are used and long vessel segments are broken into shorter vessel segments. For each branch its rotation about its branch point is solved iteratively using the present vessel image metric Equation 3 and Aylward 2001b 2003 . Each branch s rotation is computed independently and its descendants do not contribute to the metric. The weightings of the points in each branch s model win Equation 3 decrease based on their distance from the branch point. A branch s translation is constrained to be along its parent. Specifically the translation vector of the child is projected onto the tangent direction of its parent vessel at the branch point and the amount of translation allowed is constrained by an elasticity property of the parent vessel translation updates are dampened by how much a branch point has been translated from its initial location. Updates use a gradient ascent optimization strategy. While appearing complex the multiple constraints involved reduce the complexity of the transformation s parameter space and thereby speed the registration process this step requires only 5 seconds.

Piecewise non rigid of deformable registration The piecewise non rigid or deformable registration step parallels the rigid registration step. 1 The image gradient is computed at a scale proportional to the radius of the local vessel point and projected onto the normal of the vessel point to determine how that vessel point should move as was done for rigid registration in Aylward 2001 2002b 2003 Equation 5 . 2 To handle local image noise and avoid overly complex deformations such as folding a rigidity coefficient that dampens vessel bending is added. Specifically it dampens updates based on the difference between the initial curvature at a vessel point and the current curvature at that point. This rigidity coefficient varies along a vessel proportional to the radius of the vessel it and elasticity could also depend on the material properties of the vessel and liver but such precision is unnecessary for image driven registration . In the present implementation this rigidity value is kept constant at every point and the sampling rate along a vessel is used to accommodate the coefficient as the radius changes Equation 3 . 3 This process is applied starting from each root and spreading to their branches. Steps 1 and 2 closely resemble a deformable explicit snake that maximizes the integral of the scaled intensities it encounters and minimizes its internal bending energy. By using a coarse to fine approach based on the vascular tree this process requires only 10 15 seconds.

Total deformable registration time is 20 30 seconds. Next the model s transform is interpolated to transcribe pre operative markings such as desired PLL RFA sites into the intra operative ultrasound data.

Knowing how the pre operative model deforms to fit the intra operative data the transform needed to transcribe desired PLL RFA sites from the pre operative data into the intra operative data s overlay is estimated. In order to estimate the transform a deformation field vector value D at a point x is estimated using the method in Pennec 2003 i.e. using Gaussian interpolation of the update vectors dat model points xas follows

Deformation field interpolation is an instance of deformation field regularization this class of methods has been the focus of much research. Excellent iterative large deformation diffeomorphic field generation and finite element model based techniques have been developed for deformation field regularization Joshi 2000 . These methods however tend to be dense field techniques it is necessary to solve for many often all of the points in a deformation field to determine the deformation field at any particular point.

Equation 9 has been used King 2001a b Pennec 2003 for intra operative deformation field interpolation since it is only necessary to evaluate it at the PLL RFA points to determine how to translate them into the ultrasound s coordinate system. This computation is fast and produces acceptable results under the assumption that the deformations are small and smooth this is likely the case for ultrasound annotation for minimally invasive procedures such as PLL RFA. Nevertheless there are problems with Equation 9 it lacks consideration of the fact that model deformation vectors donly capture the normal direction components of the underlying deformation field by design they lack the tangential component Equations 4 8 . The present solution is applicable to many of the model active contour active surface active shape and sparse field deformation strategies that limit model updates to normal directions.

Regardless of this limitation however the present preliminary implementation uses this equation to produce fast consistent and accurate results using phantom and clinical data. They are discussed next.

The following test demonstrates the present system s ability to consistently rigidly register the exact types of data that it will encounter in the proposed work and when used in a clinic. As detailed in the previous section global rigid registration is the initial step in the present deformable registration process. This evaluation begins by estimating liver motion due to breathing to determine how much liver displacement is likely to occur during a procedure. That estimate is used to generate Monte Carlo runs for quantifying the consistency of MR to ultrasound registration.

Liver motion due to breathing is the likely source of much of the intra operative liver displacement. A portal phase CT scan at maximum breath inhale and a hepatic phase CT scan at maximum exhale was acquired. The vessel models from the portal scan were modeled and those models were then registered with the hepatic scan using the present rigid registration strategy. The resulting transform parameters are given in Table 1. On inhale the liver translates to the posterior and rotates to the inferior along a sagittal course. Total movement is about 1 cm and 0.09 radians.

Monte Carlo experiments were then conducted to measure the consistency with which MR vascular models and ultrasound data could be rigidly registered given liver breath motion. A patient was scanned using the 3D VIBE MR sequence and three days later two 3D ultrasound scans were acquired one on inhale and one on exhale. A liver vasculature model was extracted from the MR scan and registered with each ultrasound scan. Each registration was roughly initiated by hand in the clinic an optical tracker would provide this initialization and the present vascular model to image rigid registration method was applied to refine those registrations. Each rigid registration required less than 3 seconds and appeared to be accurate despite the fact that the patient s liver was not cirrhotic and therefore contained deformations . More particularly illustrate two ultrasound scans overlaid on two different slices of an MR scan. These scans were aligned by registering a vascular model from the MR scan with each ultrasound scan. Vessel and liver surface correspondences are indicated by arrows. In vessel models from the MR scan are overlaid on an ultrasound scan. Shadowing is evident in nearly one half of this slice but registration was consistent as illustrated in Table 2 below.

From this initial registration Monte Carlo experiments were conducted the registration of the MR vascular models to the ultrasound data was repeated given random initial mis registrations based on expected liver motion due to breathing i.e. 1 cm 14 voxels and 0.1 radians from Table 1. Results from the 97 successful of the 100 re registrations are in Table 2.

The proposed extensions are expected to reduce the failure rate to zero and to improve both accuracy and consistency. In the evaluation described in the next section the registration method s accuracy is evaluated.

These preliminary studies quantify the accuracy with which tumors visible in CT can be transcribed into ultrasound data using a rigid vascular registration method even when a needle is present in the ultrasound data. These studies involved a gelatin phantom containing simulated vessels and tumors and a biopsy needle.

Specifically a tub of gelatin containing soba noodles and four 5 5 5 mm targets was scanned in a CT system using a standard liver protocol. A model of the vessels noodles was extracted from that scan. An ultrasound scan with an RFA needle inserted through the center of the tub was then acquired. The CT vessel models were roughly rigidly registered with that ultrasound scan using a calibrated magnetic tracker. The centers of mass of the four targets were calculated in each scan The mean distance between those centers across the roughly registered scans was 8.8 mm and the max distance was 9.8 mm. The vascular registration system was then used to refine the alignment of the CT model with the ultrasound data. This registration required 2 seconds. The mean distance between corresponding targets was reduced to 2.0 mm and the max distance was reduced to 2.2 mm . More particularly is an image of the tub of gelatin and soba noodles. It was determined that a tub of gelatin and soba noodles has CT properties within a few HU of liver CT properties. Vessels were extracted from Cr scan and then registered with the ultrasound scan. In after vascular registration mean distances reduced to 2 mm and maximum distances less than 2.2 mm dark CT vascular model and targets light ultrasound based targets . These results are well within the 5 mm required for PLL RFA. Admittedly registration accuracy is not the sole determinant of needle placement accuracy during PLL RFA nevertheless the proposed studies involving deformable transforms and clinical PLL RFA data are justified.

This section illustrates the performance of the present vessel tree based hierarchical deformable registration strategy using clinical MRA data. Two clinical sets of data have been evaluated in detail a intra cranial MRA data acquired pre and post arteriovenous malformation embolization and b liver CT data acquired six months apart. Each deformable registration required 20 30 seconds and provided sub voxel accuracy at the vessel model points. The three steps of deformable registration are illustrated for these data in . More particularly in two vessel networks are shown. The dark grey post operative vascular models are being deformably registered with the MRA image data used to generate the light grey pre operative vascular models. The light grey models are not used in the registration. They are only shown for reference. illustrates the results of globally rigidly aligning a vascular model dark grey from a post operative scan directly with a pre operative scan not shown instead its vessel are shown by light grey to reveal registration accuracy . In the results from piecewise rigid registration are illustrated. In the results from piecewise non rigid registration are illustrated. In the circles indicate an area of large deformation. Average distance between the vascular networks is sub voxel.

In liver vessels from two CT scans taken six months apart are shown. Two vessel networks are shown but the dark gray vascular model is being deformably registered with the CT image data used to generate the light grey vascular model. illustrates the model and image before registration. illustrates the image and vascular model after deformable registration. In the mean distance between the deformed and the data s actual vascular network is 0.66 mm. The time required for registration is less than 30 seconds.

The success of the implementation described above car be enhanced by incorporating principled extensions and conducting thorough validations. These developments and evaluations will use data from percutaneous liver lesion radio frequency ablation procedures PLL RFA . The specific aims are

Central to these developments and evaluations is the clinical PLL RFA data that will be recorded and then used retrospectively. Via informed consent pre and post operative MR or CT scans and intra operative 3D ultrasound scans will be collected from 20 patients per year. The first five patients enrolled each year will be used for system development the other 15 will be reserved for the evaluations. Therefore at the end of three years 15 patients data will be available for training and 45 for testing. They will be grouped and made available from a web site as such. Details regarding the pre operative MR CT and intra operative 3D ultrasound are described below.

Pre operative CT MR It is necessary to acquire MR CT scans of PLL RFA patients to form pre operative liver vessel and surface models to be used during registration. Most PLL RFA patients come from outside referral and electronic access to their prior CT MR scans is generally not available. Randomly but possibly modified by consent and health status such as creatine levels half of the patients will be assigned to receive a pre operative MR and half will receive a pre operative CT.

All CT scans will be acquired on a Siemens Sensation 16 multi detector CT unit using a liver donor evaluation protocol. The portal and hepatic phase scans are acquired 30 and 60 seconds after contrast injection to capture portal and hepatic vessels details respectively. These scans are registered to generate a model that contains both vascular networks. These scans contain approximately 512 512 280 voxels with a voxel size of 0.56 0.56 1.5 mm.

All MR scans will be acquired on a Siemens Sonata 1.5 T MR unit using a 3D VIBE sequence. This high gradient 1.5 T magnet supports fast and detailed 3D and thin slice images. The VIBE sequence is a T1 weighted 3D Flash breath hold technique. Three dimensional Fourier transform GRE imaging has potential advantages over 2D imaging. In comparison with traditional 2D GRE sequences properly structured 3D GRE sequences have the capacity to provide thinner sections no gaps fat saturation higher SNR and comparable image contrast in the same breath hold time frame. The VIBE sequence has TR 4.78 ms TE 2.27 ms FA 10 slab thickness 80 mm effective slice thickness 2.5 mm matrix size 195 256 FOV 320 mm imaging time 20 to 23 seconds. Data can be acquired transverse and dynamically pre contrast arterial phase early portal venous phase and late portal venous phase with a single dose of gadolinium. A pre contrast scan is subtracted from a late portal venous phase image to emphasize vascular detail. These images cover the liver in a 512 512 200 voxel volume with contiguous 0.6 0.6 2.5 mm voxels.

A potential problem with abdominal MR is spatial distortion however since it is only necessary to capture the relative relationship between the liver s surface and vessels and the desired RFA sites in the MR data if the MR distortions are not locally severe it is not necessary to correct for them deformable registration with the ultrasound data will still be valid the relative locations of the image features will still be maintained. In the unlikely event that MR distortion is not continuous and severely distorts the relative location of objects in the MR scan the proposed studies will be restricted to the use of CT. This is a reasonable fallback position but the subject matter described herein can be used with MR images.

Intra operative 3D ultrasound 3D ultrasound scans will be acquired during PLL RFA procedures for each designated tumor one scan will be collected prior to needle insertion two scans will be collected after needle insertion while en route to the tumor and one scan will be collected immediately prior to ablation initiation. It is preferable to use an ultrasound spacer on thin patients so that a larger portion of the liver surface near the ultrasound probe is captured and available for registration. Also both b mode and Doppler images will be acquired to compare their vascular detail and effect on registration performance in Aim 4. A GE Voluson 730 ultrasound machine may be used for these acquisitions. Compared to a Medison Voluson 530D the GE 730 offers reduced sub second versus 7 15 second scan times and Doppler capabilities. Faster scan times will reduce the amount of intra scan organ movement that would degrade registration accuracy and consistency. Doppler scans are likely to provide improved vascular detail leading to improved registration accuracy. All scans are automatically stored in isotropic Cartesian coordinates using 0.6 0.6 0.6 mm voxels. DICOM will be used to push each scan to a workstation.

As with MR spatial distortions may occur in ultrasound images however also as with MR distortions these distortions are not likely to disturb the relative location of objects in the images and therefore will have minimal effect on deformable registration performance. The pre operative models will be registered directly with the ultrasound data and the resulting desired PLL RFA site overlay will maintain correct relative location.

As discussed above ultrasound probe tracking cannot account for organ changes between pre and intra operative image acquisition intra operative patient movement organ movement particularly due to breathing or organ deformations however the 3D ultrasound probe will be tracked when ultrasound data is acquired to initialize the registration of the ultrasound data and the pre operative models by providing relative rigid transforms between consecutive ultrasound scans. The calibration protocol detailed above may be used. Since the present preliminary results demonstrate magnetic tracker interference from the RFA needle an optical tracker may be more suitable for this purpose.

The present method is based on a consistent philosophy for the simultaneous consideration of vasculature and surfaces for model to image registration. The preliminary implementation focused on understanding and evaluating the potential of vasculature in intra operative registration for ultrasound annotation. Vasculature has only received limited attention in intra operative ultrasound registration King 2001a b Porter 2002 but it has amazing potential vasculature moves as the surrounding tissues move are dense throughout the liver and are clearly visible on ultrasound. Despite the strengths of vasculature there is also a clear role for surfaces in registration surface deformation ensures that estimating a deformation field only requires interpolation and not extrapolation to cover an organ.

In this Aim an intra operative ultrasound annotation system that embodies this philosophy will be implemented. The steps of the present ultrasound annotation method are a pre operative CT MR liver vessel and surface modeling b pre operative desired PLL RFA site specification c intra operative deformable registration and d intra operative desired PLL RFA site transcription. The basic processes and capabilities of these steps are described above. Here the modifications needed to incorporate surfaces into those processes are described.

 1 Pre operative CT MR Vessel and Surface Modeling One exemplary liver vessel and surface modeling method is described and evaluated above and in Aylward 1996 2002a Weeks 2001 Bullitt 20001a b . This method provides accurate and consistent models. This method has been used to segment liver surfaces and vessels from MR and CT scans from over 100 potential partial liver donors. Vessels are represented by centerline points with radii. Surfaces are represented by quad meshes.

 2 Pre operative Desired PLL RFA Site Specification The interventional radiologist who will perform the PLL RFA procedure will specify the desired needle destinations via point and clicks within the pre operative image slices. These will be recorded using software developed for liver transplant planning. Many intra operative factors determine the appropriate approaches to those sites so only the sites and not the paths to those site can and will be specified on the pre operative data.

 3 Intra Operative Deformable Registration The simultaneous and consistent consideration of vessels and surfaces is one of the innovations in described herein. Preliminary results demonstrate that considering vessels leads to a fast and accurate feature image match metric tumor locations are transcribed from pre operative CT of a phantom into 3D ultrasound images in 2 3 seconds with maximum error of 2.2 mm. Including surface features will support the localization of tumors near the liver surface where vessels are sparse. The clinical utility of this extension will be quantified in Aim 4.

Intra operative deformable registration progresses in three steps global rigid piecewise rigid and then piecewise deformable registration. Underlying all three is a common metric. Here the extension of the metric Equation 3 to include surfaces is described. The corresponding extensions to the steps of registration are also described.

Vessel Sufface Feature Image metric The present surface registration metric assumes that surface model points map to bright voxels within the target image when the model and image are registered just as vessel model points should map to the dark voxels in the image. The vessel to image match metric of Equation 3 is augmented to become a combined vessel surface to image metric as follows 

Global rigid registration The strengths of the present vessel registration process are maintained in the present vessel surface registration process. 1 Vessels and surfaces are limited to inducing registration updates in their normal directions. 2 Parameter updates are adjusted to remove any biases resulting from the vessels and surfaces having a dominant orientation. As defined in Equation 4 above and in Aylward 2001 2003 a matrix Nis used to encode the normal directions at each point. It is then used in Equations 5 8 to limit local updates and to calculate the total orientation bias. For a vessel point there are two normal directions that defined the plane in which it can induce local updates. For points on surfaces there is a single normal direction in which updates are locally well defined. The general equation for the matrix that captures the normal direction s for vessel and surface points xis

Piecewise rigid registration Initialized using the global rigid registration results this step proceeds coarse to fine using the vascular tree hierarchy as described above. After vessel based piecewise rigid registration the surface is rigidly registered independently with the ultrasound image using gradient ascent and the metric in Equation 10.

Piecewise deformable registration Initialized using the piecewise rigid registration results the method solves for the deformable registration of the vessels to the ultrasound data and then uses their deformation field to initialize the deformable registration of the surface to the data. As detailed above the process of piecewise deformable registration uses the natural hierarchical relationship between vessels as tree structures to implement a coarse to fine optimization scheme. First the vascular roots are deformed to fit the data and then their branches are deformed. This process requires 20 30 seconds. The vessel model deformations are extrapolated to the surface by evaluating the deformation field interpolation equation Equation 9 at the surface points. The fit of the surface to the data is then refined using Equation 10 and a gradient ascent optimization strategy. As with vessels optimization is directed by the normalized and unbiased gradients at the surface points as defined by Equation 7 and updates are dampened by an internal energy term based on the difference between each surface point s initial and current Gaussian curvature. That is just as the present deformable vessel registration process resembles an explicit snakes technique applied hierarchically the present surface deformation technique is a variant of explicit active surfaces that maximizes the integral of the scaled intensities it encounters while minimizing internal energy as measured by bending.

 4 Intra operative Desired PLL RFA Site Transcription From the model deformations each desired PLL RFA point is transcribed into the ultrasound data s coordinate system from the pre operative data using Equation 9 the deformation field interpolation strategy of Pennec 2003 .

This integrative surface and vessel registration process while simple is novel accurate fast and provides a consistent philosophy for handling vessels and surfaces that is absent from other intra operative registration strategies. It is also extensible to include aspect of the physics of liver deformation and ultrasound acquisition.

Deformation field interpolation via Equation 9 makes numerous assumptions regarding how local liver and vessel deformations combine to specify the movement of surrounding liver tissues. One motivation for the use of deformation field interpolation is described above. Here its limitations are discussed and corrected. In particular an often overlooked limitation assumption is identified and an alternative is offered.

Simple Gaussian interpolation as in Equation 9 has limitations the deformations must be small and smooth for the interpolated deformation vectors to be diffeomorphic and accurate. These limitations are well known. One often completely overlooked assumption however is that the deformation vectors being interpolated are assumed to completely describe the deformation field at those points and this is largely untrue.

For deformable registration strategies the deformation vector at a model point favors the component of the deformation field normal to the model point the tangential component of the deformation field is not included. Here Equation 9 is corrected to enable the accurate interpolation of deformation fields given sparse limited support i.e. given deformation field values at model points where those values selectively capture only a subspace component of the local deformation field.

To correctly estimate the deformation field vector at a desired PLL RFA point x the influence of the normal direction s Non their dmust be considered. Therefore each dis weighted by the uniqueness of its basis Ncompared to the total basis of all of the local deformation vectors dthat contribute to x. This total basis is a weighted sum of the normal matrices of the local model points 

To visualize the importance of this approach consider the non rigid registration of a pre operative image of a large circle with an embedded cross and an intra operative image that contains a smaller circle and cross with rotation . The correct deformation from the pre to the intra operative image is ambiguous many vector field transforms could be applied to map these images. However if local feature matching is used the vector field implied is shown in .

If a smoothing based interpolation Equation 9 is applied to determine how the space between the circle and the cross is deformed the likely results is shown in FIG. D a swirl is introduced this interpolation does not consider the orientation biases of the features in the image. The outer circle s local vectors tell us nothing about rotation and the inner cross vectors poorly capture scale. The biases Nof points on the circle and points on the cross are orthogonal so their gradient vectors should linearly combine as in Equ. 14 and as shown in . The resulting transform is nearly a similarity rigid scale transform a lower order transform it has a smaller Jacobean trace it is more likely the underling process from A to B.

The above example is a simple case but in more complex situations the present deformation field interpolation strategy remains applicable. Admittedly there are other strategies by which similar results could be achieved for the data in and e.g. by first solving for an affine transform prior to solving for the non rigid transform. However such strategies will not work in the more general case when non rigid deformations are truly present and model points only capture the portion of the local deformation field in their normal directions This is the case for nearly every model active contour active surface or active shape deformable registration strategy. Equation 14 explicitly handles such cases it better captures the underlying physics of the deformation field as specified by vessel and surface models. The next section describes the physics of ultrasound acquisition and extensions of the subject matter described herein that account for such physics.

There are two aspects of the physics of ultrasound acquisition that should be considered when combining surface and vessel measures for registration 1 Organ surfaces are visible in ultrasound images as intensity surfaces or gradient surfaces dependent upon the change in the acoustic properties across the organ surface and the orientation of the organ surfaces with respect to the ultrasound wave . In the arrows indicate the portions of the liver surface that are represented via strong gradiance or bright intensities in the image. The image properties of surfaces and ultrasound vary by their orientation with respect to the ultrasound wave. The present enhanced metric accounts for this dependency. 2 The influence of vessel and surface measures must be scaled to have equal influence on the metric.

 1 The present metric is modified to account for the interdependence between ultrasound wave direction and the surface normal orientation. The modification includes pre computing the orientation of the ultrasound wave at every voxel in the 3D ultrasound data as u x . The dot product between the wave orientation and the vessel point s transformed normal direction T n is computed to weight the local gradient and intensity image information at surface points. The weighting wof the ultrasound image surface intensity measure sat T x is defined so that when the surface normal and ultrasound wave orientation are aligned the ultrasound intensity information is favored 15 16 Similarly the weighting wof the ultrasound image gradient measure at T x is defined so that when the transformed surface normal and ultrasound wave orientation are orthogonal the image gradient information in the normal direction sis favored 1 17 18 

 2 It is necessary to balance the influence of the vessel intensity surface intensity and surface gradient measures so that their responses equally influence the registration process i.e. the metric. The normalization of these disparate measures is determined using statistics from the 15 scans reserved for system development. First however inter scan intensity variations are accounted for so that the normalization statistics are constant across ultrasound scans.

The method of dynamic intensity remapping of Pennec 2003 is used to solve for the degree two polynomial that rescales the vessel surface and liver intensities in an ultrasound image to match the expected values of those intensities as defined by a template ultrasound image. As did Pennec as the transform is optimized the ultrasound intensities are sampled where the transformed models suggest that vessel surface and liver intensities are present. Using the measured means of those class intensities the present method solves for the degree two polynomial that brings them into closer correspondence with template means for those classes. A prior is used to constrain the parameters of the polynomial and only small parameter changes are allowed at each step as registration progresses. Template means are chosen by hand labeling vessel surface and liver points within a training ultrasound image. Pennec has shown this method to be effective not only for simple intra modality ultrasound ultrasound matching but also for more complex MR to CT intensity matching. Once the intensities are matched across scans the statistics needed to equate vessel intensities surface intensities and surface gradients can be computed so as to give those measures commensurate units as described next.

To give commensurate units to the intensity and gradient measures in the metric the measures are converted to likelihood measures. Specifically using the 15 scans reserved for system development after matching their intensities using the method described above the present method will measure the means and variances of the vessel Equation 3 and surface Equations 16 and 18 measures at model points after model image registration and for random offsets and rotations from registration. Each value v of measure m is then scaled based on its signed distance from each mean normalized by their variances and then normalized by the spread of the means as follows

This section seeks to quantify how the proposed extensions aid in the speed and accuracy of CT MR to ultrasound intra operative registrations for PLL RFA. The extensions will be compared using recorded clinical PLL RFA data.

The accuracy of the image registration component of an ultrasound annotation system is quantified by how closely it can transcribe a point designated on pre operative CT MR data into its correct position in the intra operative ultrasound data. The speed of the image registration component is measured by the time required to register an intra operative 3D ultrasound image with a pre operative CT MR image.

To establish truth for the accuracy measures an interventional radiologists will designate the desired PLL RFA sites on each of the 4 intra operative 3D ultrasound images from the 45 patients designated for system testing. These are patients undergoing PLL RFA treatment so their tumors are visible on those scans as a clinical requirement. The interventional radiologists will have already Aim 1 designated the desired PLL RFA site on the pre operative data for each tumor of interest.

For accuracy the present focus is not central tendencies or variance of accuracy but instead the key statistics for clinical accuracy are the extremes therefore the present method focuses on the 95 99 100 maximum quantities of error. One way ANOVA analysis of variance tests will be conducted to compare the 24 possible combinations of the independent variables where the dependent variables for comparison are the 95 99 and 100quantile of the log transformed distances between the transcribed desired PLL RFA sites and their manually designated locations within the ultrasound data. The log transformation is used to ensure the validity of normal assumption Muller and Fetterman 2002 page 219 . The Tukey test will be used to compare the difference among all the different levels for the independent variables. Since three hypotheses are to be compared one for each quantile alpha 0.05 3 will be used as the significance level to adjust Type I error Kirk 1995 .

For speed again the present focus is not central tendencies and variance of time but instead the key clinical statistics are the 95 99 100 maximum quantile of the time to register the data. The above one way ANOVA tests are repeated to compare the 24 possible combinations of the independent variables where the dependent variables are the 95 99 and 100quantile of registration time. Again the Tukey test will be used to compare the different levels for the independent variables and 0.05 3 will be used for alpha.

For speed and accuracy repeated measure ANOVA will also be used to analyze the data. Repeated measures ANOVA where the patient is the repeated measure unit accounts for the correlations of the measures resulting from using multiple scans from the same patient. The outcomes in the analysis will be the log transformed discrepancy distance and registration times based on readings from the tumors in all patients. By performing the complete set of tests every possible combination of the independent variables the factor of each independent variable as well as their interaction can be analyzed. It will be possible to quantify how important physically based interpolation is to a vessel only model as well as determine which is the most accurate and fastest method.

Power analyses have been conducted. Assuming that each of the 45 patients has only one qualifying tumor size less than 5 cm that is captured in 4 images then n 180. Using an alpha of 0.05 3 0.1666 since three hypotheses are being tested then the power chart in is applicable to the present pair data hypothesis experiments. More particularly illustrates power graphs that assume that each of the 45 patients has only one qualifying tumor that appears in four images and that use an alpha of 0.05 3 0.166. Since three hypotheses are being tested it is expected that 0.2 mm differences at the 95 99 or 100quantile of accuracy or speed with a 0.9 power will be detectable. Based on Monte Carlo results Table 2 the standard deviation of a registration method s accuracy is estimated to be 0.7 mm. Therefore if the expected difference between any two systems at any quantile is greater than 0.2 mm the present method will be able to detect it with a power of 0.9. If the standard deviation were to double to 1.4 mm the present tests would be able to detect 0.4 mm differences with a power of 0.9.

Regarding clinical accuracy requirements each implementation s maximum error will be compared with the clinical goals of 5 mm maximum error as stated by others King 2001a b and radiologists primarily based on the desire for a 1 cm burn margin around each tumor. For each implementation the alternative hypothesis that on average it provides less than 5 mm error at its 100quantile of accuracy will be tested. Given n 180 alpha 0.05 0.7 mm Table 2 and given that the initial experiments described above had a maximum error of 2.2 mm the power to detect a difference is 1.0. More simply each system will be judged as unacceptable if any of its registrations produced a maximum error of more than 5 mm.

Clinical image registration speed requirements are not easily measured. There are many factors that influence acceptable speed. Delays between image acquisitions in CT guided PLL RFA are often acceptable if a patient s only other option is open surgery. However it has been shown that waiting several minutes between requesting an intra operative scan and viewing the results reduces the accuracy with which a physician can guide a needle to a point and increases the length of a procedure Sheafor 1998 . After much discussion with radiologists 30 seconds has been selected as the cut off time between a truly effective intra operative registration strategy and one whose lack of speed may ultimately degrade a physician s ability to accurately place a needle. Any system will be determined to be clinically unacceptable if any of its 180 test registrations requires more than 30 seconds to complete. While this may seem like a weak test of the many systems reviewed in this proposal e.g. King 2001a b Porter 2001 Roche 2001 Pennec 2003 only the proposed method is likely to pass it. The present preliminary implementation performs deformable registrations in 20 30 seconds. The other systems reviewed require 5 10 minutes per registration which is 10 to 20 times of a radiologist s suggested limit.

The subject matter described herein addresses the key component of image based ultrasound annotation intra operative deformable registration of pre operative CT MR images with intra operative 3D ultrasound images. It promotes the use of vascular and surface models from the pre operative images to drive the registration process. One of its strengths is that those models specify the location scale orientation and type of measure to be made in the intra operative data to determine the validity of a transform. Those focused measures also specify how the parameters of the deformable transform should be updated to improve the registration of the pre and intra operative data. This makes the system uniquely accurate and fast. Extensions based on the physics of ultrasound acquisition and liver vessel and surface deformation are described herein. These extensions embody a philosophy that is applicable to other deformable registration strategies. Extensive and well powered tests to compare the accuracy and speed of the base and extended implementations using clinical PLL RFA data are also described. An ultrasound annotation system that meets radiologists speed and accuracy requirements does not exist preliminary results indicate the present implementation will be the first.

Although the examples described herein for hierarchical model to image registration relate primarily to surgical guidance applications the subject matter described herein is not limited to such applications. For example the registration methods described herein may be used in any application in which it is desirable to rapidly register a blood vessel model with blood vessel image data. Examples of such applications include disease diagnosis disease staging surgical planning transplant planning etc.

The following citations correspond to the shortened citations listed above. Each of the references represented by these citations is hereby incorporated herein by reference in its entirety.

It will be understood that various details of the invention may be changed without departing from the scope of the invention. Furthermore the foregoing description is for the purpose of illustration only and not for the purpose of limitation.

